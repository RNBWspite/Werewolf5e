<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - Werewolf 5e</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
</head>
<body>
    <header class="sticky-header">
        <nav>
            <a href="index.html" class="nav-home" aria-label="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="account.html" class="active">Account</a>
            <a href="characters.html">Characters</a>
            <a href="sessions.html">Sessions</a>
            <a href="about.html">About Us</a>
        </nav>
        <a href="index.html" class="header-logo-link">
            <img src="https://github.com/user-attachments/assets/aaa6e10d-a24c-4711-8da7-2683d2028d7b" alt="RNBW Logo" class="header-logo">
        </a>
    </header>
    
    <main class="account-main">
        <!-- Guest View (Not Logged In) -->
        <section id="guest-view" class="account-section">
            <h1>Welcome, Traveler</h1>
            <p class="subtitle">Join the pack and track your adventures across the World of Darkness.</p>
            
            <div class="auth-container">
                <!-- Sign In Form -->
                <div class="auth-form-wrapper" id="signin-wrapper">
                    <h2>Sign In</h2>
                    <form id="signin-form" class="auth-form">
                        <div class="form-group">
                            <label for="signin-email">Email</label>
                            <input type="email" id="signin-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signin-password">Password</label>
                            <input type="password" id="signin-password" name="password" placeholder="Enter your password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </div>
                        <p class="forgot-password"><button type="button" class="link-btn" id="show-forgot-password">Forgot Password?</button></p>
                    </form>
                    <p class="auth-switch">Don't have an account? <button type="button" class="link-btn" id="show-signup">Create one</button></p>
                </div>
                
                <!-- Sign Up Form (Hidden by default) -->
                <div class="auth-form-wrapper hidden" id="signup-wrapper">
                    <h2>Create Account</h2>
                    <form id="signup-form" class="auth-form">
                        <div class="form-group">
                            <label for="signup-username">Username</label>
                            <input type="text" id="signup-username" name="username" placeholder="Choose a username" required minlength="3" maxlength="30">
                        </div>
                        <div class="form-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-dob">Date of Birth</label>
                            <input type="date" id="signup-dob" name="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" name="password" placeholder="Create a password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="signup-confirm">Confirm Password</label>
                            <input type="password" id="signup-confirm" name="confirm" placeholder="Confirm your password" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-security-question">Security Question</label>
                            <select id="signup-security-question" name="securityQuestion" required>
                                <option value="">Choose a security question...</option>
                                <option value="pet">What was the name of your first pet?</option>
                                <option value="city">In what city were you born?</option>
                                <option value="school">What is the name of your elementary school?</option>
                                <option value="friend">What is your best friend's name?</option>
                                <option value="book">What is your favorite book?</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="signup-security-answer">Security Answer</label>
                            <input type="text" id="signup-security-answer" name="securityAnswer" placeholder="Enter your answer" required minlength="2">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </div>
                    </form>
                    <p class="auth-switch">Already have an account? <button type="button" class="link-btn" id="show-signin">Sign in</button></p>
                </div>
                
                <!-- Password Reset Form (Hidden by default) -->
                <div class="auth-form-wrapper hidden" id="reset-wrapper">
                    <h2>Reset Password</h2>
                    <form id="reset-form" class="auth-form">
                        <div id="reset-step-1">
                            <div class="form-group">
                                <label for="reset-email">Email</label>
                                <input type="email" id="reset-email" name="email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="verify-email-btn">Continue</button>
                            </div>
                        </div>
                        <div id="reset-step-2" class="hidden">
                            <div class="form-group">
                                <label id="security-question-label">Security Question</label>
                                <p id="security-question-text" class="security-question-display"></p>
                            </div>
                            <div class="form-group">
                                <label for="reset-security-answer">Your Answer</label>
                                <input type="text" id="reset-security-answer" name="securityAnswer" placeholder="Enter your answer" required>
                            </div>
                            <div class="form-group">
                                <label for="reset-new-password">New Password</label>
                                <input type="password" id="reset-new-password" name="newPassword" placeholder="Enter new password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="reset-confirm-password">Confirm New Password</label>
                                <input type="password" id="reset-confirm-password" name="confirmPassword" placeholder="Confirm new password" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Reset Password</button>
                            </div>
                        </div>
                    </form>
                    <p class="auth-switch"><button type="button" class="link-btn" id="back-to-signin">Back to Sign In</button></p>
                </div>
            </div>
        </section>
        
        <!-- Logged In View -->
        <section id="user-view" class="account-section hidden">
            <div class="user-header">
                <h1>Welcome back, <span id="display-username">User</span></h1>
                <button type="button" class="btn btn-secondary" id="signout-btn">Sign Out</button>
            </div>
            
            <div class="account-content">
                <!-- User Stats -->
                <div class="account-card">
                    <h3>Your Profile</h3>
                    <div class="profile-info">
                        <p><strong>Username:</strong> <span id="profile-username">-</span></p>
                        <p><strong>Email:</strong> <span id="profile-email">-</span></p>
                        <p><strong>Member Since:</strong> <span id="profile-joined">-</span></p>
                    </div>
                </div>
                
                <!-- Gaming Systems & Characters -->
                <div class="account-card">
                    <h3>Your Characters</h3>
                    <div id="systems-list" class="systems-list">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="card-actions">
                        <a href="characters.html" class="btn btn-primary">View All Characters</a>
                    </div>
                </div>
                
                <!-- Campaigns -->
                <div class="account-card">
                    <h3>Your Campaigns</h3>
                    <div id="campaigns-list" class="campaigns-list">
                        <p class="empty-state">No campaigns yet. Join or create a campaign to get started!</p>
                    </div>
                    <div class="card-actions">
                        <a href="sessions.html" class="btn btn-primary">Manage Campaigns</a>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // HTML escape utility to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // DOM Elements
            const guestView = document.getElementById('guest-view');
            const userView = document.getElementById('user-view');
            const signinWrapper = document.getElementById('signin-wrapper');
            const signupWrapper = document.getElementById('signup-wrapper');
            const resetWrapper = document.getElementById('reset-wrapper');
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const resetForm = document.getElementById('reset-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showSigninBtn = document.getElementById('show-signin');
            const showForgotPasswordBtn = document.getElementById('show-forgot-password');
            const backToSigninBtn = document.getElementById('back-to-signin');
            const signoutBtn = document.getElementById('signout-btn');
            const verifyEmailBtn = document.getElementById('verify-email-btn');
            
            // Gaming systems configuration
            const gamingSystems = {
                'werewolf-apocalypse': {
                    name: 'Werewolf: The Apocalypse',
                    icon: 'üê∫'
                },
                'dnd5e': {
                    name: 'Dungeons & Dragons 5e',
                    icon: 'üêâ'
                },
                'vampire-masquerade': {
                    name: 'Vampire: The Masquerade',
                    icon: 'üßõ'
                },
                'call-of-cthulhu': {
                    name: 'Call of Cthulhu',
                    icon: 'üêô'
                }
            };
            
            // Check if user is logged in
            function checkAuthState() {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    showUserView(JSON.parse(currentUser));
                } else {
                    showGuestView();
                }
            }
            
            // Show guest view (sign in/up forms)
            function showGuestView() {
                guestView.classList.remove('hidden');
                userView.classList.add('hidden');
            }
            
            // Show logged in user view
            function showUserView(user) {
                guestView.classList.add('hidden');
                userView.classList.remove('hidden');
                
                // Update user display
                document.getElementById('display-username').textContent = user.username;
                document.getElementById('profile-username').textContent = user.username;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-joined').textContent = new Date(user.createdAt).toLocaleDateString();
                
                // Check for pending character (created before logging in)
                savePendingCharacter(user.email);
                
                // Load and display character counts by system
                loadCharactersBySystem(user.email);
                
                // Load campaigns
                loadCampaigns(user.email);
            }
            
            // Save any pending character to user account
            function savePendingCharacter(userEmail) {
                const pendingCharacter = localStorage.getItem('pendingCharacter');
                if (pendingCharacter) {
                    const character = JSON.parse(pendingCharacter);
                    character.userEmail = userEmail;
                    character.id = character.id || 'char_' + Date.now();
                    character.createdAt = character.createdAt || new Date().toISOString();
                    
                    // Get existing characters and add pending one
                    const characters = JSON.parse(localStorage.getItem('characters') || '[]');
                    characters.push(character);
                    localStorage.setItem('characters', JSON.stringify(characters));
                    
                    // Clear pending character
                    localStorage.removeItem('pendingCharacter');
                    
                    alert('Your character "' + escapeHtml(character.name) + '" has been saved to your account!');
                }
            }
            
            // Security questions mapping
            const securityQuestions = {
                'pet': 'What was the name of your first pet?',
                'city': 'In what city were you born?',
                'school': 'What is the name of your elementary school?',
                'friend': 'What is your best friend\'s name?',
                'book': 'What is your favorite book?'
            };
            
            // Toggle between sign in and sign up forms
            showSignupBtn.addEventListener('click', function() {
                signinWrapper.classList.add('hidden');
                signupWrapper.classList.remove('hidden');
                resetWrapper.classList.add('hidden');
            });
            
            showSigninBtn.addEventListener('click', function() {
                signupWrapper.classList.add('hidden');
                signinWrapper.classList.remove('hidden');
                resetWrapper.classList.add('hidden');
                resetForm.reset();
                document.getElementById('reset-step-1').classList.remove('hidden');
                document.getElementById('reset-step-2').classList.add('hidden');
            });
            
            showForgotPasswordBtn.addEventListener('click', function() {
                signinWrapper.classList.add('hidden');
                signupWrapper.classList.add('hidden');
                resetWrapper.classList.remove('hidden');
                resetForm.reset();
                document.getElementById('reset-step-1').classList.remove('hidden');
                document.getElementById('reset-step-2').classList.add('hidden');
            });
            
            backToSigninBtn.addEventListener('click', function() {
                resetWrapper.classList.add('hidden');
                signinWrapper.classList.remove('hidden');
                resetForm.reset();
                document.getElementById('reset-step-1').classList.remove('hidden');
                document.getElementById('reset-step-2').classList.add('hidden');
            });
            
            // Handle Sign Up
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('signup-username').value.trim();
                const email = document.getElementById('signup-email').value.trim().toLowerCase();
                const dob = document.getElementById('signup-dob').value;
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;
                const securityQuestion = document.getElementById('signup-security-question').value;
                const securityAnswer = document.getElementById('signup-security-answer').value.trim().toLowerCase();
                
                // Validate passwords match
                if (password !== confirm) {
                    alert('Passwords do not match!');
                    return;
                }
                
                // Validate age (must be 13+)
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                if (age < 13) {
                    alert('You must be at least 13 years old to create an account.');
                    return;
                }
                
                // Check if user already exists
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[email]) {
                    alert('An account with this email already exists. Please sign in.');
                    return;
                }
                
                // Create new user
                const newUser = {
                    username: username,
                    email: email,
                    dob: dob,
                    password: password, // In a real app, this would be hashed
                    securityQuestion: securityQuestion,
                    securityAnswer: securityAnswer, // In a real app, this would be hashed
                    createdAt: new Date().toISOString(),
                    characters: [],
                    campaigns: []
                };
                
                // Save user
                users[email] = newUser;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Log in the new user
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                
                alert('Account created successfully! Welcome to the pack, ' + escapeHtml(username) + '!');
                showUserView(newUser);
            });
            
            // Handle Sign In
            signinForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('signin-email').value.trim().toLowerCase();
                const password = document.getElementById('signin-password').value;
                
                // Get users
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[email];
                
                if (!user || user.password !== password) {
                    alert('Invalid email or password. Please try again.');
                    return;
                }
                
                // Log in user
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserView(user);
            });
            
            // Handle Password Reset - Step 1: Verify Email
            let resetEmail = '';
            verifyEmailBtn.addEventListener('click', function() {
                const email = document.getElementById('reset-email').value.trim().toLowerCase();
                
                // Get users
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[email];
                
                if (!user) {
                    alert('No account found with this email address.');
                    return;
                }
                
                if (!user.securityQuestion || !user.securityAnswer) {
                    alert('This account was created before security questions were implemented. Please contact support for assistance.');
                    return;
                }
                
                // Store email for step 2
                resetEmail = email;
                
                // Show security question
                document.getElementById('security-question-text').textContent = securityQuestions[user.securityQuestion];
                
                // Move to step 2
                document.getElementById('reset-step-1').classList.add('hidden');
                document.getElementById('reset-step-2').classList.remove('hidden');
            });
            
            // Handle Password Reset - Step 2: Verify Answer and Reset Password
            resetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const securityAnswer = document.getElementById('reset-security-answer').value.trim().toLowerCase();
                const newPassword = document.getElementById('reset-new-password').value;
                const confirmPassword = document.getElementById('reset-confirm-password').value;
                
                // Validate passwords match
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match!');
                    return;
                }
                
                // Get users
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[resetEmail];
                
                // Verify security answer
                if (user.securityAnswer !== securityAnswer) {
                    alert('Incorrect answer to security question. Please try again.');
                    return;
                }
                
                // Update password
                user.password = newPassword;
                users[resetEmail] = user;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Update current user if logged in
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const current = JSON.parse(currentUser);
                    if (current.email === resetEmail) {
                        current.password = newPassword;
                        localStorage.setItem('currentUser', JSON.stringify(current));
                    }
                }
                
                alert('Password reset successfully! You can now sign in with your new password.');
                
                // Reset form and go back to sign in
                resetForm.reset();
                document.getElementById('reset-step-1').classList.remove('hidden');
                document.getElementById('reset-step-2').classList.add('hidden');
                resetWrapper.classList.add('hidden');
                signinWrapper.classList.remove('hidden');
            });
            
            // Handle Sign Out
            signoutBtn.addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                showGuestView();
                
                // Clear forms
                signinForm.reset();
                signupForm.reset();
            });
            
            // Load characters grouped by gaming system
            function loadCharactersBySystem(userEmail) {
                const systemsList = document.getElementById('systems-list');
                const allCharacters = JSON.parse(localStorage.getItem('characters') || '[]');
                
                // Filter characters belonging to this user
                const userCharacters = allCharacters.filter(char => char.userEmail === userEmail);
                
                // Group by system
                const charactersBySystem = {};
                userCharacters.forEach(char => {
                    const system = char.system || 'werewolf-apocalypse';
                    if (!charactersBySystem[system]) {
                        charactersBySystem[system] = [];
                    }
                    charactersBySystem[system].push(char);
                });
                
                // Generate HTML
                if (userCharacters.length === 0) {
                    systemsList.innerHTML = '<p class="empty-state">No characters created yet. Start your journey by creating a character!</p>';
                    return;
                }
                
                let html = '';
                Object.entries(charactersBySystem).forEach(([systemId, characters]) => {
                    const system = gamingSystems[systemId] || { name: systemId, icon: 'üéÆ' };
                    html += `
                        <div class="system-item">
                            <span class="system-icon">${system.icon}</span>
                            <div class="system-info">
                                <span class="system-name">${system.name}</span>
                                <span class="character-count">${characters.length} character${characters.length !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                    `;
                });
                
                // Add total count
                html += `
                    <div class="total-characters">
                        <strong>Total Characters:</strong> ${userCharacters.length}
                    </div>
                `;
                
                systemsList.innerHTML = html;
            }
            
            // Load campaigns for user
            function loadCampaigns(userEmail) {
                const campaignsList = document.getElementById('campaigns-list');
                const allCampaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
                
                // Filter campaigns belonging to this user
                const userCampaigns = allCampaigns.filter(campaign => 
                    campaign.gmEmail === userEmail || 
                    (campaign.players && campaign.players.includes(userEmail))
                );
                
                if (userCampaigns.length === 0) {
                    campaignsList.innerHTML = '<p class="empty-state">No campaigns yet. Join or create a campaign to get started!</p>';
                    return;
                }
                
                let html = '';
                userCampaigns.forEach(campaign => {
                    const isGM = campaign.gmEmail === userEmail;
                    html += `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <span class="campaign-name">${campaign.name}</span>
                                <span class="campaign-role">${isGM ? 'Game Master' : 'Player'}</span>
                            </div>
                            <span class="campaign-system">${gamingSystems[campaign.system]?.name || campaign.system}</span>
                        </div>
                    `;
                });
                
                campaignsList.innerHTML = html;
            }
            
            // Initialize
            checkAuthState();
        });
    </script>
</body>
</html>
