<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - Werewolf 5e</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <header class="sticky-header">
        <nav>
            <a href="index.html" class="nav-home" aria-label="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="account.html" class="active">Account</a>
            <a href="characters.html">Characters</a>
            <a href="sessions.html">Sessions</a>
            <a href="about.html">About Us</a>
        </nav>
        <a href="index.html" class="header-logo-link">
            <img src="https://github.com/user-attachments/assets/aaa6e10d-a24c-4711-8da7-2683d2028d7b" alt="RNBW Logo" class="header-logo">
        </a>
    </header>
    
    <main class="account-main">
        <!-- Guest View (Not Logged In) -->
        <section id="guest-view" class="account-section">
            <h1>Welcome, Traveler</h1>
            <p class="subtitle">Join the pack and track your adventures across the World of Darkness.</p>
            
            <div class="auth-container">
                <!-- Sign In Form -->
                <div class="auth-form-wrapper" id="signin-wrapper">
                    <h2>Sign In</h2>
                    <form id="signin-form" class="auth-form">
                        <div class="form-group">
                            <label for="signin-email">Email</label>
                            <input type="email" id="signin-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signin-password">Password</label>
                            <input type="password" id="signin-password" name="password" placeholder="Enter your password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </div>
                        <p class="forgot-password"><button type="button" class="link-btn" id="show-forgot-password">Forgot Password?</button></p>
                    </form>
                    <p class="auth-switch">Don't have an account? <button type="button" class="link-btn" id="show-signup">Create one</button></p>
                </div>
                
                <!-- Sign Up Form (Hidden by default) -->
                <div class="auth-form-wrapper hidden" id="signup-wrapper">
                    <h2>Create Account</h2>
                    <form id="signup-form" class="auth-form">
                        <div class="form-group">
                            <label for="signup-username">Username</label>
                            <input type="text" id="signup-username" name="username" placeholder="Choose a username" required minlength="3" maxlength="30">
                        </div>
                        <div class="form-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-dob">Date of Birth</label>
                            <input type="date" id="signup-dob" name="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" name="password" placeholder="Create a password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="signup-confirm">Confirm Password</label>
                            <input type="password" id="signup-confirm" name="confirm" placeholder="Confirm your password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </div>
                    </form>
                    <p class="auth-switch">Already have an account? <button type="button" class="link-btn" id="show-signin">Sign in</button></p>
                </div>
                
                <!-- Password Reset Form (Hidden by default) -->
                <div class="auth-form-wrapper hidden" id="reset-wrapper">
                    <h2>Reset Password</h2>
                    <p class="subtitle">Enter your email address and we'll send you a link to reset your password.</p>
                    <form id="reset-form" class="auth-form">
                        <div class="form-group">
                            <label for="reset-email">Email</label>
                            <input type="email" id="reset-email" name="email" placeholder="Enter your email" required>
                        </div>
                        
                        <div class="form-group">
                            <div class="g-recaptcha" id="reset-recaptcha"></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="submit-reset-btn">Send Reset Link</button>
                        </div>
                    </form>
                    <p class="auth-switch"><button type="button" class="link-btn" id="back-to-signin">Back to Sign In</button></p>
                </div>
            </div>
        </section>
        
        <!-- Logged In View -->
        <section id="user-view" class="account-section hidden">
            <div class="user-header">
                <h1>Welcome back, <span id="display-username">User</span></h1>
                <button type="button" class="btn btn-secondary" id="signout-btn">Sign Out</button>
            </div>
            
            <div class="account-content">
                <!-- User Stats -->
                <div class="account-card">
                    <h3>Your Profile</h3>
                    <div class="profile-info">
                        <p><strong>Username:</strong> <span id="profile-username">-</span></p>
                        <p><strong>Email:</strong> <span id="profile-email">-</span></p>
                        <p><strong>Member Since:</strong> <span id="profile-joined">-</span></p>
                    </div>
                </div>
                
                <!-- Gaming Systems & Characters -->
                <div class="account-card">
                    <h3>Your Characters</h3>
                    <div id="systems-list" class="systems-list">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="card-actions">
                        <a href="characters.html" class="btn btn-primary">View All Characters</a>
                    </div>
                </div>
                
                <!-- Campaigns -->
                <div class="account-card">
                    <h3>Your Campaigns</h3>
                    <div id="campaigns-list" class="campaigns-list">
                        <p class="empty-state">No campaigns yet. Join or create a campaign to get started!</p>
                    </div>
                    <div class="card-actions">
                        <a href="sessions.html" class="btn btn-primary">Manage Campaigns</a>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Load reCAPTCHA site key from backend
            let recaptchaSiteKey = '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI'; // Default test key
            try {
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                recaptchaSiteKey = config.recaptchaSiteKey;
            } catch (error) {
                console.warn('Failed to load config, using default reCAPTCHA key');
            }
            
            // Initialize reCAPTCHA when it's loaded
            function initRecaptcha() {
                if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                    const recaptchaElement = document.getElementById('reset-recaptcha');
                    if (recaptchaElement && !recaptchaElement.hasChildNodes()) {
                        grecaptcha.render('reset-recaptcha', {
                            'sitekey': recaptchaSiteKey
                        });
                    }
                }
            }
            
            // Check if grecaptcha is already loaded
            if (typeof grecaptcha !== 'undefined') {
                initRecaptcha();
            } else {
                // Wait for grecaptcha to load
                window.addEventListener('load', initRecaptcha);
            }
            
            // HTML escape utility to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // DOM Elements
            const guestView = document.getElementById('guest-view');
            const userView = document.getElementById('user-view');
            const signinWrapper = document.getElementById('signin-wrapper');
            const signupWrapper = document.getElementById('signup-wrapper');
            const resetWrapper = document.getElementById('reset-wrapper');
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const resetForm = document.getElementById('reset-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showSigninBtn = document.getElementById('show-signin');
            const showForgotPasswordBtn = document.getElementById('show-forgot-password');
            const backToSigninBtn = document.getElementById('back-to-signin');
            const signoutBtn = document.getElementById('signout-btn');
            
            // Gaming systems configuration
            const gamingSystems = {
                'werewolf-apocalypse': {
                    name: 'Werewolf: The Apocalypse',
                    icon: 'üê∫'
                },
                'dnd5e': {
                    name: 'Dungeons & Dragons 5e',
                    icon: 'üêâ'
                },
                'vampire-masquerade': {
                    name: 'Vampire: The Masquerade',
                    icon: 'üßõ'
                },
                'call-of-cthulhu': {
                    name: 'Call of Cthulhu',
                    icon: 'üêô'
                }
            };
            
            // Check if user is logged in
            function checkAuthState() {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    showUserView(JSON.parse(currentUser));
                } else {
                    showGuestView();
                }
            }
            
            // Show guest view (sign in/up forms)
            function showGuestView() {
                guestView.classList.remove('hidden');
                userView.classList.add('hidden');
            }
            
            // Show logged in user view
            function showUserView(user) {
                guestView.classList.add('hidden');
                userView.classList.remove('hidden');
                
                // Update user display
                document.getElementById('display-username').textContent = user.username;
                document.getElementById('profile-username').textContent = user.username;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-joined').textContent = new Date(user.createdAt).toLocaleDateString();
                
                // Check for pending character (created before logging in)
                savePendingCharacter(user.email);
                
                // Load and display character counts by system
                loadCharactersBySystem(user.email);
                
                // Load campaigns
                loadCampaigns(user.email);
            }
            
            // Save any pending character to user account
            function savePendingCharacter(userEmail) {
                const pendingCharacter = localStorage.getItem('pendingCharacter');
                if (pendingCharacter) {
                    const character = JSON.parse(pendingCharacter);
                    character.userEmail = userEmail;
                    character.id = character.id || 'char_' + Date.now();
                    character.createdAt = character.createdAt || new Date().toISOString();
                    
                    // Get existing characters and add pending one
                    const characters = JSON.parse(localStorage.getItem('characters') || '[]');
                    characters.push(character);
                    localStorage.setItem('characters', JSON.stringify(characters));
                    
                    // Clear pending character
                    localStorage.removeItem('pendingCharacter');
                    
                    alert('Your character "' + escapeHtml(character.name) + '" has been saved to your account!');
                }
            }
            
            // Toggle between sign in and sign up forms
            showSignupBtn.addEventListener('click', function() {
                signinWrapper.classList.add('hidden');
                signupWrapper.classList.remove('hidden');
                resetWrapper.classList.add('hidden');
            });
            
            showSigninBtn.addEventListener('click', function() {
                signupWrapper.classList.add('hidden');
                signinWrapper.classList.remove('hidden');
                resetWrapper.classList.add('hidden');
                resetForm.reset();
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                }
            });
            
            showForgotPasswordBtn.addEventListener('click', function() {
                signinWrapper.classList.add('hidden');
                signupWrapper.classList.add('hidden');
                resetWrapper.classList.remove('hidden');
                resetForm.reset();
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                }
            });
            
            backToSigninBtn.addEventListener('click', function() {
                resetWrapper.classList.add('hidden');
                signinWrapper.classList.remove('hidden');
                resetForm.reset();
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                }
            });
            
            // Handle Sign Up
            signupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('signup-username').value.trim();
                const email = document.getElementById('signup-email').value.trim().toLowerCase();
                const dob = document.getElementById('signup-dob').value;
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;
                
                // Validate passwords match
                if (password !== confirm) {
                    alert('Passwords do not match!');
                    return;
                }
                
                // Validate age (must be 13+)
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                if (age < 13) {
                    alert('You must be at least 13 years old to create an account.');
                    return;
                }
                
                // Call backend API to create user
                try {
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            email,
                            dob,
                            password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        alert(data.error || 'Failed to create account');
                        return;
                    }
                    
                    // Save user to localStorage (for frontend compatibility)
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    
                    alert('Account created successfully! Welcome to the pack, ' + escapeHtml(username) + '!');
                    showUserView(data.user);
                } catch (error) {
                    console.error('Registration error:', error);
                    alert('An error occurred while creating your account. Please try again.');
                }
            });
            
            // Handle Sign In
            signinForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('signin-email').value.trim().toLowerCase();
                const password = document.getElementById('signin-password').value;
                
                // Call backend API to login
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        alert(data.error || 'Invalid email or password');
                        return;
                    }
                    
                    // Log in user
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    showUserView(data.user);
                } catch (error) {
                    console.error('Login error:', error);
                    alert('An error occurred while signing in. Please try again.');
                }
            });
            
            // Handle Password Reset - Email-based with reCAPTCHA
            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('reset-email').value.trim().toLowerCase();
                const submitBtn = document.getElementById('submit-reset-btn');
                
                // Get reCAPTCHA response
                const recaptchaResponse = typeof grecaptcha !== 'undefined' ? grecaptcha.getResponse() : null;
                
                if (!recaptchaResponse) {
                    alert('Please complete the reCAPTCHA verification.');
                    return;
                }
                
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';
                
                try {
                    const response = await fetch('/api/password-reset/request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            recaptchaToken: recaptchaResponse
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('If an account exists with this email, a password reset link has been sent. Please check your email inbox (and spam folder).');
                        resetForm.reset();
                        if (typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                        resetWrapper.classList.add('hidden');
                        signinWrapper.classList.remove('hidden');
                    } else {
                        alert(data.error || 'Failed to process password reset request');
                        if (typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    }
                } catch (error) {
                    console.error('Password reset error:', error);
                    alert('An error occurred. Please try again.');
                    if (typeof grecaptcha !== 'undefined') {
                        grecaptcha.reset();
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Link';
                }
            });
            
            // Handle Sign Out
            signoutBtn.addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                showGuestView();
                
                // Clear forms
                signinForm.reset();
                signupForm.reset();
            });
            
            // Load characters grouped by gaming system
            function loadCharactersBySystem(userEmail) {
                const systemsList = document.getElementById('systems-list');
                const allCharacters = JSON.parse(localStorage.getItem('characters') || '[]');
                
                // Filter characters belonging to this user
                const userCharacters = allCharacters.filter(char => char.userEmail === userEmail);
                
                // Group by system
                const charactersBySystem = {};
                userCharacters.forEach(char => {
                    const system = char.system || 'werewolf-apocalypse';
                    if (!charactersBySystem[system]) {
                        charactersBySystem[system] = [];
                    }
                    charactersBySystem[system].push(char);
                });
                
                // Generate HTML
                if (userCharacters.length === 0) {
                    systemsList.innerHTML = '<p class="empty-state">No characters created yet. Start your journey by creating a character!</p>';
                    return;
                }
                
                let html = '';
                Object.entries(charactersBySystem).forEach(([systemId, characters]) => {
                    const system = gamingSystems[systemId] || { name: systemId, icon: 'üéÆ' };
                    html += `
                        <div class="system-item">
                            <span class="system-icon">${system.icon}</span>
                            <div class="system-info">
                                <span class="system-name">${system.name}</span>
                                <span class="character-count">${characters.length} character${characters.length !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                    `;
                });
                
                // Add total count
                html += `
                    <div class="total-characters">
                        <strong>Total Characters:</strong> ${userCharacters.length}
                    </div>
                `;
                
                systemsList.innerHTML = html;
            }
            
            // Load campaigns for user
            function loadCampaigns(userEmail) {
                const campaignsList = document.getElementById('campaigns-list');
                const allCampaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
                
                // Filter campaigns belonging to this user
                const userCampaigns = allCampaigns.filter(campaign => 
                    campaign.gmEmail === userEmail || 
                    (campaign.players && campaign.players.includes(userEmail))
                );
                
                if (userCampaigns.length === 0) {
                    campaignsList.innerHTML = '<p class="empty-state">No campaigns yet. Join or create a campaign to get started!</p>';
                    return;
                }
                
                let html = '';
                userCampaigns.forEach(campaign => {
                    const isGM = campaign.gmEmail === userEmail;
                    html += `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <span class="campaign-name">${campaign.name}</span>
                                <span class="campaign-role">${isGM ? 'Game Master' : 'Player'}</span>
                            </div>
                            <span class="campaign-system">${gamingSystems[campaign.system]?.name || campaign.system}</span>
                        </div>
                    `;
                });
                
                campaignsList.innerHTML = html;
            }
            
            // Initialize
            checkAuthState();
        });
    </script>
</body>
</html>
