<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Characters - Werewolf 5e</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
</head>
<body>
    <header class="sticky-header">
        <nav>
            <a href="index.html" class="nav-home" aria-label="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="account.html">Account</a>
            <a href="characters.html" class="active">Characters</a>
            <a href="sessions.html">Sessions</a>
            <a href="about.html">About Us</a>
        </nav>
        <a href="index.html" class="header-logo-link">
            <img src="https://github.com/user-attachments/assets/aaa6e10d-a24c-4711-8da7-2683d2028d7b" alt="RNBW Logo" class="header-logo">
        </a>
    </header>
    
    <main class="characters-main">
        <div class="characters-header">
            <h1>Your Characters</h1>
            <p class="subtitle">View and manage your characters across all gaming systems.</p>
        </div>
        
        <!-- Not Logged In Message -->
        <div id="login-prompt" class="login-prompt hidden">
            <div class="prompt-content">
                <h2>Sign In Required</h2>
                <p>Please sign in to view your saved characters.</p>
                <a href="account.html" class="btn btn-primary">Go to Account</a>
            </div>
        </div>
        
        <!-- Characters List -->
        <div id="characters-content" class="characters-content hidden">
            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label for="system-filter">Gaming System:</label>
                    <select id="system-filter">
                        <option value="all">All Systems</option>
                        <option value="werewolf-apocalypse">Werewolf: The Apocalypse</option>
                        <option value="dnd5e">Dungeons & Dragons 5e</option>
                        <option value="vampire-masquerade">Vampire: The Masquerade</option>
                        <option value="call-of-cthulhu">Call of Cthulhu</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="campaign-filter">Campaign:</label>
                    <select id="campaign-filter">
                        <option value="all">All Campaigns</option>
                        <option value="none">No Campaign</option>
                    </select>
                </div>
            </div>
            
            <!-- Characters Grid -->
            <div id="characters-grid" class="characters-grid">
                <!-- Dynamically populated -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-characters" class="empty-characters hidden">
                <div class="empty-content">
                    <span class="empty-icon">üê∫</span>
                    <h3>No Characters Yet</h3>
                    <p>Your journey awaits! Create your first character to begin your adventure.</p>
                    <a href="index.html" class="btn btn-primary">Create Character</a>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Character Detail Modal -->
    <div id="character-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content character-detail-modal">
            <button type="button" class="modal-close" id="modal-close-btn" aria-label="Close modal">&times;</button>
            <div id="character-detail-content">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // HTML escape utility to prevent XSS
            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }
            
            // Shared skill categories mapping
            const SKILL_CATEGORIES = {
                athletics: 'physical', brawl: 'physical', firearms: 'physical',
                larceny: 'physical', melee: 'physical', stealth: 'physical', survival: 'physical',
                empathy: 'social', etiquette: 'social', intimidation: 'social',
                leadership: 'social', performance: 'social', persuasion: 'social',
                streetwise: 'social', subterfuge: 'social',
                academics: 'mental', awareness: 'mental', craft: 'mental',
                insight: 'mental', investigation: 'mental', medicine: 'mental',
                occult: 'mental', science: 'mental', technology: 'mental'
            };
            
            // DOM Elements
            const loginPrompt = document.getElementById('login-prompt');
            const charactersContent = document.getElementById('characters-content');
            const charactersGrid = document.getElementById('characters-grid');
            const emptyCharacters = document.getElementById('empty-characters');
            const systemFilter = document.getElementById('system-filter');
            const campaignFilter = document.getElementById('campaign-filter');
            const characterModal = document.getElementById('character-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const characterDetailContent = document.getElementById('character-detail-content');
            
            // Gaming systems configuration
            const gamingSystems = {
                'werewolf-apocalypse': {
                    name: 'Werewolf: The Apocalypse',
                    icon: 'üê∫',
                    color: '#6b8e23'
                },
                'dnd5e': {
                    name: 'Dungeons & Dragons 5e',
                    icon: 'üêâ',
                    color: '#8b0000'
                },
                'vampire-masquerade': {
                    name: 'Vampire: The Masquerade',
                    icon: 'üßõ',
                    color: '#4a0000'
                },
                'call-of-cthulhu': {
                    name: 'Call of Cthulhu',
                    icon: 'üêô',
                    color: '#1a3a1a'
                }
            };
            
            // Tribe-specific themes for Werewolf character sheets
            const tribeThemes = {
                'black-furies': {
                    name: 'Black Furies',
                    primaryColor: '#8b0000',
                    secondaryColor: '#2d0000',
                    accentColor: '#ff4444',
                    symbol: '‚öîÔ∏è',
                    backgroundPattern: 'linear-gradient(135deg, #2d0000 0%, #1a0000 50%, #3d0000 100%)'
                },
                'bone-gnawers': {
                    name: 'Bone Gnawers',
                    primaryColor: '#8b7355',
                    secondaryColor: '#3d2e1f',
                    accentColor: '#d4a574',
                    symbol: 'üêÄ',
                    backgroundPattern: 'linear-gradient(135deg, #3d2e1f 0%, #2a1f14 50%, #4d3e2f 100%)',
                    customClass: 'bone-gnawer-theme',
                    borderColor: '#8b4513',
                    textureOverlay: true
                },
                'children-of-gaia': {
                    name: 'Children of Gaia',
                    primaryColor: '#228b22',
                    secondaryColor: '#0d3d0d',
                    accentColor: '#90ee90',
                    symbol: 'üåø',
                    backgroundPattern: 'linear-gradient(135deg, #0d3d0d 0%, #052805 50%, #1a4d1a 100%)'
                },
                'fianna': {
                    name: 'Fianna',
                    primaryColor: '#2e8b57',
                    secondaryColor: '#1a4030',
                    accentColor: '#ffd700',
                    symbol: 'üéµ',
                    backgroundPattern: 'linear-gradient(135deg, #1a4030 0%, #0d2018 50%, #2a5040 100%)'
                },
                'ghost-council': {
                    name: 'Ghost Council',
                    primaryColor: '#4682b4',
                    secondaryColor: '#1a3045',
                    accentColor: '#87ceeb',
                    symbol: 'üëª',
                    backgroundPattern: 'linear-gradient(135deg, #1a3045 0%, #0d1825 50%, #2a4055 100%)'
                },
                'glass-walkers': {
                    name: 'Glass Walkers',
                    primaryColor: '#708090',
                    secondaryColor: '#2d3436',
                    accentColor: '#00d4ff',
                    symbol: 'üíª',
                    backgroundPattern: 'linear-gradient(135deg, #2d3436 0%, #1a1e20 50%, #3d4446 100%)'
                },
                'red-talons': {
                    name: 'Red Talons',
                    primaryColor: '#8b0000',
                    secondaryColor: '#3d1a1a',
                    accentColor: '#ff6347',
                    symbol: 'üê∫',
                    backgroundPattern: 'linear-gradient(135deg, #3d1a1a 0%, #280d0d 50%, #4d2a2a 100%)'
                },
                'shadow-lords': {
                    name: 'Shadow Lords',
                    primaryColor: '#1a1a2e',
                    secondaryColor: '#0d0d17',
                    accentColor: '#9370db',
                    symbol: 'üëë',
                    backgroundPattern: 'linear-gradient(135deg, #0d0d17 0%, #050508 50%, #1a1a27 100%)'
                },
                'silent-striders': {
                    name: 'Silent Striders',
                    primaryColor: '#daa520',
                    secondaryColor: '#3d3010',
                    accentColor: '#ffd700',
                    symbol: 'üèúÔ∏è',
                    backgroundPattern: 'linear-gradient(135deg, #3d3010 0%, #282008 50%, #4d4020 100%)'
                },
                'silver-fangs': {
                    name: 'Silver Fangs',
                    primaryColor: '#c0c0c0',
                    secondaryColor: '#2a2a3a',
                    accentColor: '#ffffff',
                    symbol: 'üèÜ',
                    backgroundPattern: 'linear-gradient(135deg, #2a2a3a 0%, #1a1a28 50%, #3a3a4a 100%)'
                },
                'stargazers': {
                    name: 'Stargazers',
                    primaryColor: '#4b0082',
                    secondaryColor: '#1a0030',
                    accentColor: '#e6e6fa',
                    symbol: '‚≠ê',
                    backgroundPattern: 'linear-gradient(135deg, #1a0030 0%, #0d0018 50%, #2a0040 100%)'
                }
            };
            
            let currentUser = null;
            let userCharacters = [];
            
            // Check auth state
            function checkAuthState() {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    currentUser = JSON.parse(user);
                    loginPrompt.classList.add('hidden');
                    charactersContent.classList.remove('hidden');
                    loadCharacters();
                    loadCampaignsFilter();
                } else {
                    loginPrompt.classList.remove('hidden');
                    charactersContent.classList.add('hidden');
                }
            }
            
            // Load user's characters
            function loadCharacters() {
                const allCharacters = JSON.parse(localStorage.getItem('characters') || '[]');
                userCharacters = allCharacters.filter(char => char.userEmail === currentUser.email);
                renderCharacters(userCharacters);
            }
            
            // Load campaigns for filter
            function loadCampaignsFilter() {
                const allCampaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
                const userCampaigns = allCampaigns.filter(campaign => 
                    campaign.gmEmail === currentUser.email || 
                    (campaign.players && campaign.players.includes(currentUser.email))
                );
                
                // Add campaigns to filter dropdown
                userCampaigns.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign.id;
                    option.textContent = campaign.name;
                    campaignFilter.appendChild(option);
                });
            }
            
            // Render characters grid
            function renderCharacters(characters) {
                if (characters.length === 0) {
                    charactersGrid.classList.add('hidden');
                    emptyCharacters.classList.remove('hidden');
                    return;
                }
                
                charactersGrid.classList.remove('hidden');
                emptyCharacters.classList.add('hidden');
                
                let html = '';
                characters.forEach((char, index) => {
                    const system = gamingSystems[char.system] || gamingSystems['werewolf-apocalypse'];
                    const campaignName = char.campaignId ? escapeHtml(getCampaignName(char.campaignId)) : 'No Campaign';
                    
                    html += `
                        <div class="character-card" data-character-index="${index}" style="--system-color: ${escapeHtml(system.color)}">
                            <div class="card-header">
                                <span class="system-badge">${escapeHtml(system.icon)} ${escapeHtml(system.name)}</span>
                            </div>
                            <div class="card-body">
                                <h3 class="character-name">${escapeHtml(char.name) || 'Unnamed Character'}</h3>
                                <div class="character-details">
                                    ${char.tribe ? `<span class="detail-item">Tribe: ${escapeHtml(formatTribe(char.tribe))}</span>` : ''}
                                    ${char.auspice ? `<span class="detail-item">Auspice: ${escapeHtml(formatAuspice(char.auspice))}</span>` : ''}
                                    ${char.gender ? `<span class="detail-item">Gender: ${escapeHtml(formatGender(char.gender))}</span>` : ''}
                                </div>
                                <div class="campaign-badge">
                                    <span class="campaign-label">Campaign:</span>
                                    <span class="campaign-name">${campaignName}</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" class="btn btn-primary view-character-btn" data-index="${index}">View Details</button>
                                <button type="button" class="btn btn-danger delete-character-btn" data-index="${index}" data-name="${escapeHtml(char.name) || 'this character'}">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                charactersGrid.innerHTML = html;
                
                // Add click handlers - open character sheet in new tab
                document.querySelectorAll('.view-character-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const character = userCharacters[index];
                        if (character && character.id) {
                            window.open('character-sheet.html?id=' + encodeURIComponent(character.id), '_blank');
                        }
                    });
                });
                
                // Add delete handlers
                document.querySelectorAll('.delete-character-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const charName = this.dataset.name;
                        deleteCharacter(index, charName);
                    });
                });
            }
            
            // Delete character with confirmation
            function deleteCharacter(index, charName) {
                const confirmed = confirm(`Are you sure you want to delete "${charName}"?\n\nThis action cannot be undone. All character data will be permanently lost.`);
                
                if (confirmed) {
                    const allCharacters = JSON.parse(localStorage.getItem('characters') || '[]');
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    
                    // Find and remove the character
                    const characterToDelete = userCharacters[index];
                    const globalIndex = allCharacters.findIndex(c => c.id === characterToDelete.id);
                    
                    if (globalIndex !== -1) {
                        allCharacters.splice(globalIndex, 1);
                        localStorage.setItem('characters', JSON.stringify(allCharacters));
                        
                        // Update user's characters list
                        userCharacters = allCharacters.filter(c => c.userEmail === currentUser.email);
                        
                        // Re-render the list
                        renderCharacterCards(userCharacters);
                        
                        alert(`"${charName}" has been deleted.`);
                    }
                }
            }
            
            // Get campaign name by ID
            function getCampaignName(campaignId) {
                const allCampaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
                const campaign = allCampaigns.find(c => c.id === campaignId);
                return campaign ? campaign.name : 'Unknown Campaign';
            }
            
            // Format tribe name
            function formatTribe(tribe) {
                const tribes = {
                    'black-furies': 'Black Furies',
                    'bone-gnawers': 'Bone Gnawers',
                    'children-of-gaia': 'Children of Gaia',
                    'fianna': 'Fianna',
                    'ghost-council': 'Ghost Council',
                    'glass-walkers': 'Glass Walkers',
                    'red-talons': 'Red Talons',
                    'shadow-lords': 'Shadow Lords',
                    'silent-striders': 'Silent Striders',
                    'silver-fangs': 'Silver Fangs',
                    'stargazers': 'Stargazers'
                };
                return tribes[tribe] || tribe;
            }
            
            // Format auspice name
            function formatAuspice(auspice) {
                const auspices = {
                    'ragabash': 'Ragabash',
                    'theurge': 'Theurge',
                    'philodox': 'Philodox',
                    'galliard': 'Galliard',
                    'ahroun': 'Ahroun'
                };
                return auspices[auspice] || auspice;
            }
            
            // Format gender
            function formatGender(gender) {
                const genders = {
                    'male': 'Male',
                    'female': 'Female',
                    'non-binary': 'Non-Binary',
                    'genderfluid': 'Genderfluid',
                    'agender': 'Agender'
                };
                return genders[gender] || gender;
            }
            
            // Calculate age from birthdate
            function calculateAge(birthdate) {
                const birth = new Date(birthdate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }
            
            // Get auspice moon SVG
            function getAuspiceMoonSvg(auspice) {
                const moons = {
                    'ragabash': `<svg viewBox="0 0 100 100" class="moon-svg"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="3"/></svg>`,
                    'theurge': `<svg viewBox="0 0 100 100" class="moon-svg"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="3"/><path d="M50 5 A45 45 0 0 1 50 95" fill="currentColor"/></svg>`,
                    'philodox': `<svg viewBox="0 0 100 100" class="moon-svg"><circle cx="50" cy="50" r="45" fill="currentColor"/></svg>`,
                    'galliard': `<svg viewBox="0 0 100 100" class="moon-svg"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="3"/><path d="M50 5 A45 45 0 0 0 50 95" fill="currentColor"/></svg>`,
                    'ahroun': `<svg viewBox="0 0 100 100" class="moon-svg"><circle cx="50" cy="50" r="45" fill="currentColor"/></svg>`
                };
                return moons[auspice] || moons['ragabash'];
            }
            
            // Get dots display
            function getDotsDisplay(value) {
                return '‚óè'.repeat(value) + '‚óã'.repeat(5 - value);
            }
            
            // Generate editable dots HTML
            function generateEditableDots(value, max, color) {
                let html = '';
                for (let i = 1; i <= max; i++) {
                    const filled = i <= value;
                    html += `<span class="dot ${filled ? 'filled' : ''}" data-value="${i}" style="color: ${color};">${filled ? '‚óè' : '‚óã'}</span>`;
                }
                return html;
            }
            
            // Generate Gifts & Rites HTML
            function generateGiftsRitesHtml(giftsRites) {
                if (!giftsRites || giftsRites.length === 0) {
                    return '<div class="gift-rite-row empty-row"><span class="empty-message">No gifts or rites added yet</span></div>';
                }
                return giftsRites.map((item, index) => `
                    <div class="gift-rite-row" data-index="${index}">
                        <div class="gift-rite-fields">
                            <input type="text" class="gift-rite-input name-input" data-field="name" value="${escapeHtml(item.name || '')}" placeholder="Name">
                            <input type="text" class="gift-rite-input pool-input" data-field="pool" value="${escapeHtml(item.pool || '')}" placeholder="Pool">
                            <input type="text" class="gift-rite-input cost-input" data-field="cost" value="${escapeHtml(item.cost || '')}" placeholder="Cost">
                            <input type="text" class="gift-rite-input notes-input" data-field="notes" value="${escapeHtml(item.notes || '')}" placeholder="Notes">
                        </div>
                        <button type="button" class="btn-remove-row" onclick="removeGiftRite(${index})">√ó</button>
                    </div>
                `).join('');
            }
            
            // Generate Advantages & Flaws HTML
            function generateAdvantagesFlawsHtml(advantagesFlaws, accentColor) {
                if (!advantagesFlaws || advantagesFlaws.length === 0) {
                    return '<div class="advantage-flaw-row empty-row"><span class="empty-message">No advantages or flaws added yet</span></div>';
                }
                return advantagesFlaws.map((item, index) => `
                    <div class="advantage-flaw-row" data-index="${index}">
                        <input type="text" class="advantage-flaw-input" data-field="name" value="${escapeHtml(item.name || '')}" placeholder="Name">
                        <div class="editable-dots advantage-flaw-dots" data-index="${index}" data-max="5">
                            ${generateEditableDots(item.points || 0, 5, accentColor)}
                        </div>
                        <button type="button" class="btn-remove-row" onclick="removeAdvantageFlaw(${index})">√ó</button>
                    </div>
                `).join('');
            }
            
            // Current character being edited
            let currentEditingCharacter = null;
            
            // Add Gift/Rite row
            window.addGiftRite = function() {
                if (!currentEditingCharacter) return;
                if (!currentEditingCharacter.giftsRites) {
                    currentEditingCharacter.giftsRites = [];
                }
                currentEditingCharacter.giftsRites.push({ name: '', pool: '', cost: '', notes: '' });
                saveCharacterChanges(currentEditingCharacter);
                refreshGiftsRitesList();
            };
            
            // Remove Gift/Rite row
            window.removeGiftRite = function(index) {
                if (!currentEditingCharacter || !currentEditingCharacter.giftsRites) return;
                currentEditingCharacter.giftsRites.splice(index, 1);
                saveCharacterChanges(currentEditingCharacter);
                refreshGiftsRitesList();
            };
            
            // Add Advantage/Flaw row
            window.addAdvantageFlaw = function() {
                if (!currentEditingCharacter) return;
                if (!currentEditingCharacter.advantagesFlaws) {
                    currentEditingCharacter.advantagesFlaws = [];
                }
                currentEditingCharacter.advantagesFlaws.push({ name: '', points: 0 });
                saveCharacterChanges(currentEditingCharacter);
                refreshAdvantagesFlawsList();
            };
            
            // Remove Advantage/Flaw row
            window.removeAdvantageFlaw = function(index) {
                if (!currentEditingCharacter || !currentEditingCharacter.advantagesFlaws) return;
                currentEditingCharacter.advantagesFlaws.splice(index, 1);
                saveCharacterChanges(currentEditingCharacter);
                refreshAdvantagesFlawsList();
            };
            
            // Refresh Gifts & Rites list
            function refreshGiftsRitesList() {
                const container = document.getElementById('gifts-rites-list');
                if (container && currentEditingCharacter) {
                    container.innerHTML = generateGiftsRitesHtml(currentEditingCharacter.giftsRites || []);
                    attachGiftRiteListeners();
                }
            }
            
            // Refresh Advantages & Flaws list
            function refreshAdvantagesFlawsList() {
                const container = document.getElementById('advantages-flaws-list');
                if (container && currentEditingCharacter) {
                    const tribeTheme = tribeThemes[currentEditingCharacter.tribe] || { accentColor: '#9acd32' };
                    container.innerHTML = generateAdvantagesFlawsHtml(currentEditingCharacter.advantagesFlaws || [], tribeTheme.accentColor);
                    attachAdvantageFlawListeners();
                }
            }
            
            // Attach listeners for Gift/Rite inputs
            function attachGiftRiteListeners() {
                document.querySelectorAll('.gift-rite-row:not(.empty-row)').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    row.querySelectorAll('.gift-rite-input').forEach(input => {
                        input.addEventListener('change', function() {
                            if (currentEditingCharacter && currentEditingCharacter.giftsRites && currentEditingCharacter.giftsRites[index]) {
                                currentEditingCharacter.giftsRites[index][this.dataset.field] = this.value;
                                saveCharacterChanges(currentEditingCharacter);
                            }
                        });
                    });
                });
            }
            
            // Attach listeners for Advantage/Flaw inputs
            function attachAdvantageFlawListeners() {
                document.querySelectorAll('.advantage-flaw-row:not(.empty-row)').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    const input = row.querySelector('.advantage-flaw-input');
                    if (input) {
                        input.addEventListener('change', function() {
                            if (currentEditingCharacter && currentEditingCharacter.advantagesFlaws && currentEditingCharacter.advantagesFlaws[index]) {
                                currentEditingCharacter.advantagesFlaws[index].name = this.value;
                                saveCharacterChanges(currentEditingCharacter);
                            }
                        });
                    }
                    
                    const dotsContainer = row.querySelector('.advantage-flaw-dots');
                    if (dotsContainer) {
                        dotsContainer.querySelectorAll('.dot').forEach(dot => {
                            dot.addEventListener('click', function() {
                                const value = parseInt(this.dataset.value);
                                if (currentEditingCharacter && currentEditingCharacter.advantagesFlaws && currentEditingCharacter.advantagesFlaws[index]) {
                                    // Toggle: if clicking same value, reduce by 1 (min 0); otherwise set to clicked value
                                    const currentValue = currentEditingCharacter.advantagesFlaws[index].points || 0;
                                    currentEditingCharacter.advantagesFlaws[index].points = (currentValue === value) ? Math.max(0, value - 1) : value;
                                    saveCharacterChanges(currentEditingCharacter);
                                    refreshAdvantagesFlawsList();
                                }
                            });
                        });
                    }
                });
            }
            
            // Save character changes to localStorage
            function saveCharacterChanges(character) {
                const allCharacters = JSON.parse(localStorage.getItem('characters') || '[]');
                const index = allCharacters.findIndex(c => c.id === character.id);
                if (index !== -1) {
                    allCharacters[index] = character;
                    localStorage.setItem('characters', JSON.stringify(allCharacters));
                    
                    // Update userCharacters array
                    const userIndex = userCharacters.findIndex(c => c.id === character.id);
                    if (userIndex !== -1) {
                        userCharacters[userIndex] = character;
                    }
                }
            }
            
            // Attach editable section listeners
            function attachEditableListeners() {
                // Editable dots (Renown, Harano, Hauglosk)
                document.querySelectorAll('.editable-dots:not(.advantage-flaw-dots)').forEach(container => {
                    const field = container.dataset.field;
                    container.querySelectorAll('.dot').forEach(dot => {
                        dot.addEventListener('click', function() {
                            const value = parseInt(this.dataset.value);
                            if (currentEditingCharacter) {
                                // Handle nested fields like renown.glory
                                const fieldParts = field.split('.');
                                if (fieldParts.length === 2) {
                                    if (!currentEditingCharacter[fieldParts[0]]) {
                                        currentEditingCharacter[fieldParts[0]] = {};
                                    }
                                    const currentValue = currentEditingCharacter[fieldParts[0]][fieldParts[1]] || 0;
                                    currentEditingCharacter[fieldParts[0]][fieldParts[1]] = (currentValue === value) ? Math.max(0, value - 1) : value;
                                } else {
                                    const currentValue = currentEditingCharacter[field] || 0;
                                    currentEditingCharacter[field] = (currentValue === value) ? Math.max(0, value - 1) : value;
                                }
                                saveCharacterChanges(currentEditingCharacter);
                                updateDotsDisplay(container, field);
                            }
                        });
                    });
                });
                
                // Editable textareas
                document.querySelectorAll('.editable-textarea').forEach(textarea => {
                    textarea.addEventListener('change', function() {
                        const field = this.dataset.field;
                        if (currentEditingCharacter) {
                            currentEditingCharacter[field] = this.value;
                            saveCharacterChanges(currentEditingCharacter);
                        }
                    });
                });
                
                // Header inputs (Concept, Patron)
                document.querySelectorAll('.header-input').forEach(input => {
                    input.addEventListener('change', function() {
                        const field = this.dataset.field;
                        if (currentEditingCharacter) {
                            currentEditingCharacter[field] = this.value;
                            saveCharacterChanges(currentEditingCharacter);
                        }
                    });
                });
                
                // Portrait upload
                document.querySelectorAll('.portrait-file-input').forEach(input => {
                    input.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file && currentEditingCharacter) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                currentEditingCharacter.portraitUrl = event.target.result;
                                saveCharacterChanges(currentEditingCharacter);
                                // Update the portrait display
                                const container = document.querySelector('.character-portrait-container');
                                if (container) {
                                    const placeholder = container.querySelector('.auspice-moon-placeholder');
                                    if (placeholder) {
                                        placeholder.outerHTML = `<img src="${event.target.result}" alt="Character Portrait" class="character-portrait">`;
                                    } else {
                                        const existingImg = container.querySelector('.character-portrait');
                                        if (existingImg) {
                                            existingImg.src = event.target.result;
                                        }
                                    }
                                }
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
                
                // Gift/Rite listeners
                attachGiftRiteListeners();
                
                // Advantage/Flaw listeners
                attachAdvantageFlawListeners();
            }
            
            // Update dots display after click
            function updateDotsDisplay(container, field) {
                if (!currentEditingCharacter) return;
                
                const fieldParts = field.split('.');
                let value;
                if (fieldParts.length === 2) {
                    value = currentEditingCharacter[fieldParts[0]]?.[fieldParts[1]] || 0;
                } else {
                    value = currentEditingCharacter[field] || 0;
                }
                
                container.querySelectorAll('.dot').forEach(dot => {
                    const dotValue = parseInt(dot.dataset.value);
                    const filled = dotValue <= value;
                    dot.classList.toggle('filled', filled);
                    dot.textContent = filled ? '‚óè' : '‚óã';
                });
            }
            
            // Show character detail modal
            function showCharacterDetail(character) {
                const system = gamingSystems[character.system] || gamingSystems['werewolf-apocalypse'];
                
                let attributesHtml = '';
                if (character.attributes) {
                    attributesHtml = `
                        <div class="detail-section">
                            <h4>Attributes</h4>
                            <div class="attributes-grid">
                                <div class="attr-category">
                                    <h5>Physical</h5>
                                    <div class="attr-item">Strength: ${getDotsDisplay(character.attributes.strength || 1)}</div>
                                    <div class="attr-item">Dexterity: ${getDotsDisplay(character.attributes.dexterity || 1)}</div>
                                    <div class="attr-item">Stamina: ${getDotsDisplay(character.attributes.stamina || 1)}</div>
                                </div>
                                <div class="attr-category">
                                    <h5>Social</h5>
                                    <div class="attr-item">Charisma: ${getDotsDisplay(character.attributes.charisma || 1)}</div>
                                    <div class="attr-item">Manipulation: ${getDotsDisplay(character.attributes.manipulation || 1)}</div>
                                    <div class="attr-item">Composure: ${getDotsDisplay(character.attributes.composure || 1)}</div>
                                </div>
                                <div class="attr-category">
                                    <h5>Mental</h5>
                                    <div class="attr-item">Intelligence: ${getDotsDisplay(character.attributes.intelligence || 1)}</div>
                                    <div class="attr-item">Wits: ${getDotsDisplay(character.attributes.wits || 1)}</div>
                                    <div class="attr-item">Resolve: ${getDotsDisplay(character.attributes.resolve || 1)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                let skillsHtml = '';
                if (character.skills) {
                    const skillsByCategory = { physical: [], social: [], mental: [] };
                    const skillCategories = {
                        athletics: 'physical', brawl: 'physical', firearms: 'physical',
                        larceny: 'physical', melee: 'physical', stealth: 'physical', survival: 'physical',
                        empathy: 'social', etiquette: 'social', intimidation: 'social',
                        leadership: 'social', performance: 'social', persuasion: 'social',
                        streetwise: 'social', subterfuge: 'social',
                        academics: 'mental', awareness: 'mental', craft: 'mental',
                        insight: 'mental', investigation: 'mental', medicine: 'mental',
                        occult: 'mental', science: 'mental', technology: 'mental'
                    };
                    
                    Object.entries(character.skills).forEach(([skill, value]) => {
                        if (value > 0) {
                            const category = skillCategories[skill] || 'mental';
                            skillsByCategory[category].push({ name: skill, value: value });
                        }
                    });
                    
                    // Sort each category by value
                    Object.keys(skillsByCategory).forEach(cat => {
                        skillsByCategory[cat].sort((a, b) => b.value - a.value);
                    });
                    
                    skillsHtml = `
                        <div class="detail-section">
                            <h4>Skills</h4>
                            <div class="skills-grid">
                                <div class="skill-category">
                                    <h5>Physical</h5>
                                    ${skillsByCategory.physical.map(s => `<div class="skill-item">${escapeHtml(s.name)}: ${getDotsDisplay(s.value)}</div>`).join('')}
                                </div>
                                <div class="skill-category">
                                    <h5>Social</h5>
                                    ${skillsByCategory.social.map(s => `<div class="skill-item">${escapeHtml(s.name)}: ${getDotsDisplay(s.value)}</div>`).join('')}
                                </div>
                                <div class="skill-category">
                                    <h5>Mental</h5>
                                    ${skillsByCategory.mental.map(s => `<div class="skill-item">${escapeHtml(s.name)}: ${getDotsDisplay(s.value)}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                let backstoryHtml = '';
                if (character.backstory) {
                    backstoryHtml = `
                        <div class="detail-section">
                            <h4>Backstory</h4>
                            <div class="backstory-content">
                                ${character.backstory.split('\n\n').map(p => `<p>${escapeHtml(p)}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Get tribe theme for styling (for Werewolf characters)
                const tribe = character.tribe || '';
                const tribeTheme = tribeThemes[tribe] || {
                    primaryColor: system.color,
                    secondaryColor: '#1a1a1a',
                    accentColor: '#9acd32',
                    symbol: system.icon,
                    backgroundPattern: `linear-gradient(135deg, ${system.color}22 0%, #1a1a1a 50%, ${system.color}22 100%)`
                };
                
                // Character sheet styled like the PDF
                characterDetailContent.innerHTML = `
                    <div class="character-sheet ${tribeTheme.customClass || ''}" style="
                        --tribe-primary: ${tribeTheme.primaryColor};
                        --tribe-secondary: ${tribeTheme.secondaryColor};
                        --tribe-accent: ${tribeTheme.accentColor};
                        --tribe-bg: ${tribeTheme.backgroundPattern};
                        --tribe-border: ${tribeTheme.borderColor || tribeTheme.accentColor};
                    ">
                        ${tribeTheme.customClass === 'bone-gnawer-theme' ? `
                        <div class="bone-gnawer-decor">
                            <div class="torn-edge torn-edge-top"></div>
                            <div class="skull-decor"></div>
                            <div class="rat-silhouettes"></div>
                            <div class="sticker-decor">DON'T TRUST<br>SUITS</div>
                            <div class="paw-prints"></div>
                            <div class="tribe-nameplate">BONE<br>GNAWERS</div>
                            <div class="torn-edge torn-edge-bottom"></div>
                        </div>
                        ` : ''}
                        <div class="sheet-header" style="background: ${tribeTheme.backgroundPattern};">
                            <div class="sheet-header-columns">
                                <!-- Column 1: Name, Age/Gender, Concept -->
                                <div class="header-column header-column-1">
                                    <div class="header-row header-name-row">
                                        <span class="header-character-name">${escapeHtml(character.name) || 'Unnamed Character'}</span>
                                    </div>
                                    <div class="header-row">
                                        <span class="header-label">Age:</span>
                                        <span class="header-value">${character.birthdate ? calculateAge(character.birthdate) : '‚Äî'}</span>
                                        <span class="header-label" style="margin-left: 15px;">Gender:</span>
                                        <span class="header-value">${character.gender ? escapeHtml(formatGender(character.gender)) : '‚Äî'}</span>
                                    </div>
                                    <div class="header-row">
                                        <span class="header-label">Concept:</span>
                                        <input type="text" class="header-input editable-concept" data-field="concept" data-character-id="${character.id}" value="${escapeHtml(character.concept || '')}" placeholder="Enter concept...">
                                    </div>
                                </div>
                                
                                <!-- Column 2: Tribe, Patron, Auspice -->
                                <div class="header-column header-column-2">
                                    <div class="header-row">
                                        <span class="header-label">Tribe:</span>
                                        <span class="header-value">${character.tribe ? escapeHtml(formatTribe(character.tribe)) : '‚Äî'}</span>
                                    </div>
                                    <div class="header-row">
                                        <span class="header-label">Patron:</span>
                                        <input type="text" class="header-input editable-patron" data-field="patron" data-character-id="${character.id}" value="${escapeHtml(character.patron || '')}" placeholder="Enter patron spirit...">
                                    </div>
                                    <div class="header-row">
                                        <span class="header-label">Auspice:</span>
                                        <span class="header-value">${character.auspice ? escapeHtml(formatAuspice(character.auspice)) : '‚Äî'}</span>
                                    </div>
                                </div>
                                
                                <!-- Column 3: Character Image -->
                                <div class="header-column header-column-3">
                                    <div class="character-portrait-container" data-character-id="${character.id}">
                                        ${character.portraitUrl ? 
                                            `<img src="${escapeHtml(character.portraitUrl)}" alt="Character Portrait" class="character-portrait">` :
                                            `<div class="auspice-moon-placeholder ${character.auspice || 'ragabash'}">
                                                <div class="moon-phase">${getAuspiceMoonSvg(character.auspice)}</div>
                                                <span class="moon-label">${character.auspice ? escapeHtml(formatAuspice(character.auspice)) : 'New Moon'}</span>
                                            </div>`
                                        }
                                        <label class="portrait-upload-btn" title="Upload character portrait">
                                            <input type="file" accept="image/*" class="portrait-file-input" data-character-id="${character.id}" style="display: none;">
                                            <span class="upload-icon">üì∑</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="sheet-body">
                            <!-- Dice Roller Section -->
                            <div class="sheet-section dice-roller-section" style="border: 2px solid ${tribeTheme.accentColor}; border-radius: 8px; padding: 15px; margin-bottom: 25px; background: rgba(0,0,0,0.3);">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor}; margin-top: 0;">üé≤ Dice Roller</h3>
                                <p class="dice-roller-instructions">Click on an Attribute and/or Skill to build your dice pool. Each dot = 1d10. Rolls of 6+ are successes.</p>
                                <div class="dice-pool-display">
                                    <div class="selected-pools">
                                        <div class="selected-pool-item" id="selected-attribute">
                                            <span class="pool-label">Attribute:</span>
                                            <span class="pool-value" id="selected-attr-name">None selected</span>
                                            <span class="pool-dice" id="selected-attr-dice">0 dice</span>
                                        </div>
                                        <div class="selected-pool-item" id="selected-skill">
                                            <span class="pool-label">Skill:</span>
                                            <span class="pool-value" id="selected-skill-name">None selected</span>
                                            <span class="pool-dice" id="selected-skill-dice">0 dice</span>
                                        </div>
                                    </div>
                                    <div class="total-pool">
                                        <span class="total-label">Total Dice Pool:</span>
                                        <span class="total-value" id="total-dice-pool">0</span>
                                    </div>
                                </div>
                                <div class="dice-roller-actions">
                                    <button type="button" class="btn btn-primary dice-roll-btn" id="roll-dice-btn" disabled>Roll Dice</button>
                                    <button type="button" class="btn btn-secondary dice-clear-btn" id="clear-dice-btn">Clear Selection</button>
                                </div>
                                <div class="dice-results hidden" id="dice-results">
                                    <h4 class="results-title">Roll Results</h4>
                                    <div class="dice-values" id="dice-values"></div>
                                    <div class="results-summary">
                                        <div class="result-count successes" id="success-count">
                                            <span class="count-number">0</span>
                                            <span class="count-label">Successes</span>
                                        </div>
                                        <div class="result-count failures" id="failure-count">
                                            <span class="count-number">0</span>
                                            <span class="count-label">Failures</span>
                                        </div>
                                    </div>
                                    <div class="difficulty-reference">
                                        <h5>Difficulty Reference:</h5>
                                        <ul class="difficulty-list">
                                            <li><span class="diff-successes">1</span> Routine Task</li>
                                            <li><span class="diff-successes">2</span> Straightforward Task</li>
                                            <li><span class="diff-successes">3</span> Moderate Task</li>
                                            <li><span class="diff-successes">4</span> Challenging Task</li>
                                            <li><span class="diff-successes">5</span> Hard Task</li>
                                            <li><span class="diff-successes">6</span> Very Hard Task</li>
                                            <li><span class="diff-successes">7</span> Nearly Impossible Task</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sheet-section attributes-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Attributes <span class="click-hint">(click to select for dice roll)</span></h3>
                                <div class="attributes-grid">
                                    <div class="attr-category">
                                        <h4 class="category-title">Physical</h4>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Strength" data-value="${character.attributes?.strength || 1}">
                                            <span class="attr-name">Strength</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.strength || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Dexterity" data-value="${character.attributes?.dexterity || 1}">
                                            <span class="attr-name">Dexterity</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.dexterity || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Stamina" data-value="${character.attributes?.stamina || 1}">
                                            <span class="attr-name">Stamina</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.stamina || 1)}</span>
                                        </div>
                                    </div>
                                    <div class="attr-category">
                                        <h4 class="category-title">Social</h4>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Charisma" data-value="${character.attributes?.charisma || 1}">
                                            <span class="attr-name">Charisma</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.charisma || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Manipulation" data-value="${character.attributes?.manipulation || 1}">
                                            <span class="attr-name">Manipulation</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.manipulation || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Composure" data-value="${character.attributes?.composure || 1}">
                                            <span class="attr-name">Composure</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.composure || 1)}</span>
                                        </div>
                                    </div>
                                    <div class="attr-category">
                                        <h4 class="category-title">Mental</h4>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Intelligence" data-value="${character.attributes?.intelligence || 1}">
                                            <span class="attr-name">Intelligence</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.intelligence || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Wits" data-value="${character.attributes?.wits || 1}">
                                            <span class="attr-name">Wits</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.wits || 1)}</span>
                                        </div>
                                        <div class="attr-row dice-selectable" data-type="attribute" data-name="Resolve" data-value="${character.attributes?.resolve || 1}">
                                            <span class="attr-name">Resolve</span>
                                            <span class="attr-dots" style="color: ${tribeTheme.accentColor};">${getDotsDisplay(character.attributes?.resolve || 1)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${character.skills ? `
                            <div class="sheet-section skills-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Skills <span class="click-hint">(click to select for dice roll)</span></h3>
                                <div class="skills-grid">
                                    ${generateSkillsHtmlClickable(character.skills, tribeTheme.accentColor)}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Editable Sections -->
                            <div class="sheet-section rage-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Rage</h3>
                                <div class="rage-grid">
                                    <div class="tracker-item rage-tracker">
                                        <span class="tracker-name">Rage</span>
                                        <div class="editable-dots" data-field="rage" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.rage || 0, 5, '#dc143c')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sheet-section renown-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Renown</h3>
                                <div class="renown-grid">
                                    <div class="renown-item">
                                        <span class="renown-name">Glory</span>
                                        <div class="editable-dots" data-field="renown.glory" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.renown?.glory || 0, 5, tribeTheme.accentColor)}
                                        </div>
                                    </div>
                                    <div class="renown-item">
                                        <span class="renown-name">Honor</span>
                                        <div class="editable-dots" data-field="renown.honor" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.renown?.honor || 0, 5, tribeTheme.accentColor)}
                                        </div>
                                    </div>
                                    <div class="renown-item">
                                        <span class="renown-name">Wisdom</span>
                                        <div class="editable-dots" data-field="renown.wisdom" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.renown?.wisdom || 0, 5, tribeTheme.accentColor)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sheet-section harano-hauglosk-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Harano & Hauglosk</h3>
                                <div class="harano-hauglosk-grid">
                                    <div class="tracker-item">
                                        <span class="tracker-name">Harano</span>
                                        <div class="editable-dots" data-field="harano" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.harano || 0, 5, '#6495ed')}
                                        </div>
                                    </div>
                                    <div class="tracker-item">
                                        <span class="tracker-name">Hauglosk</span>
                                        <div class="editable-dots" data-field="hauglosk" data-max="5" data-character-id="${character.id}">
                                            ${generateEditableDots(character.hauglosk || 0, 5, '#ff6347')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sheet-section gifts-rites-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Gifts & Rites</h3>
                                <div class="gifts-rites-container" data-character-id="${character.id}">
                                    <div class="gifts-rites-list" id="gifts-rites-list">
                                        ${generateGiftsRitesHtml(character.giftsRites || [])}
                                    </div>
                                    <button type="button" class="btn btn-add-row" onclick="addGiftRite()">+ Add Gift/Rite</button>
                                </div>
                            </div>
                            
                            <div class="sheet-section advantages-flaws-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Advantages & Flaws</h3>
                                <div class="advantages-flaws-container" data-character-id="${character.id}">
                                    <div class="advantages-flaws-list" id="advantages-flaws-list">
                                        ${generateAdvantagesFlawsHtml(character.advantagesFlaws || [], tribeTheme.accentColor)}
                                    </div>
                                    <button type="button" class="btn btn-add-row" onclick="addAdvantageFlaw()">+ Add Advantage/Flaw</button>
                                </div>
                            </div>
                            
                            <div class="sheet-section tenets-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Character Tenets</h3>
                                <div class="editable-textarea-container">
                                    <textarea class="editable-textarea" data-field="tenets" data-character-id="${character.id}" placeholder="Enter your character's tenets...">${escapeHtml(character.tenets || '')}</textarea>
                                </div>
                            </div>
                            
                            <div class="sheet-section touchstones-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Touchstones</h3>
                                <div class="editable-textarea-container">
                                    <textarea class="editable-textarea" data-field="touchstones" data-character-id="${character.id}" placeholder="Enter your character's touchstones...">${escapeHtml(character.touchstones || '')}</textarea>
                                </div>
                            </div>
                            
                            <div class="sheet-section favors-bans-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">Favors & Bans</h3>
                                <div class="editable-textarea-container">
                                    <textarea class="editable-textarea" data-field="favorsBans" data-character-id="${character.id}" placeholder="Enter your character's favors and bans...">${escapeHtml(character.favorsBans || '')}</textarea>
                                </div>
                            </div>
                            
                            <div class="sheet-section history-section">
                                <h3 class="section-title" style="border-bottom-color: ${tribeTheme.accentColor};">History</h3>
                                <div class="history-content">
                                    ${character.backstory ? character.backstory.split('\n\n').map(p => `<p>${escapeHtml(p)}</p>`).join('') : '<p class="empty-history">No history recorded yet.</p>'}
                                </div>
                            </div>
                            
                            <div class="sheet-footer">
                                <div class="footer-item">
                                    <span class="footer-label">Campaign</span>
                                    <span class="footer-value">${character.campaignId ? escapeHtml(getCampaignName(character.campaignId)) : 'Unassigned'}</span>
                                </div>
                                <div class="footer-item">
                                    <span class="footer-label">Created</span>
                                    <span class="footer-value">${new Date(character.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Set current editing character and attach listeners
                currentEditingCharacter = character;
                characterModal.classList.add('active');
                
                // Use setTimeout to ensure DOM is ready
                setTimeout(function() {
                    attachEditableListeners();
                    attachDiceRollerListeners();
                    // Reset dice selection when opening a new character
                    clearDiceSelection();
                }, 0);
            }
            
            // Generate skills HTML organized by category
            function generateSkillsHtml(skills, accentColor) {
                const skillsByCategory = { physical: [], social: [], mental: [] };
                
                Object.entries(skills).forEach(([skill, value]) => {
                    if (value > 0) {
                        const category = SKILL_CATEGORIES[skill] || 'mental';
                        skillsByCategory[category].push({ name: skill, value: value });
                    }
                });
                
                // Sort each category by value
                Object.keys(skillsByCategory).forEach(cat => {
                    skillsByCategory[cat].sort((a, b) => b.value - a.value);
                });
                
                const formatSkillName = (name) => name.charAt(0).toUpperCase() + name.slice(1);
                
                return `
                    <div class="skill-category">
                        <h4 class="category-title">Physical</h4>
                        ${skillsByCategory.physical.length > 0 ? 
                            skillsByCategory.physical.map(s => `
                                <div class="skill-row">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No physical skills</span></div>'}
                    </div>
                    <div class="skill-category">
                        <h4 class="category-title">Social</h4>
                        ${skillsByCategory.social.length > 0 ? 
                            skillsByCategory.social.map(s => `
                                <div class="skill-row">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No social skills</span></div>'}
                    </div>
                    <div class="skill-category">
                        <h4 class="category-title">Mental</h4>
                        ${skillsByCategory.mental.length > 0 ? 
                            skillsByCategory.mental.map(s => `
                                <div class="skill-row">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No mental skills</span></div>'}
                    </div>
                `;
            }
            
            // Generate clickable skills HTML for dice roller
            function generateSkillsHtmlClickable(skills, accentColor) {
                const skillsByCategory = { physical: [], social: [], mental: [] };
                
                Object.entries(skills).forEach(([skill, value]) => {
                    if (value > 0) {
                        const category = SKILL_CATEGORIES[skill] || 'mental';
                        skillsByCategory[category].push({ name: skill, value: value });
                    }
                });
                
                // Sort each category by value
                Object.keys(skillsByCategory).forEach(cat => {
                    skillsByCategory[cat].sort((a, b) => b.value - a.value);
                });
                
                const formatSkillName = (name) => name.charAt(0).toUpperCase() + name.slice(1);
                
                return `
                    <div class="skill-category">
                        <h4 class="category-title">Physical</h4>
                        ${skillsByCategory.physical.length > 0 ? 
                            skillsByCategory.physical.map(s => `
                                <div class="skill-row dice-selectable" data-type="skill" data-name="${escapeHtml(formatSkillName(s.name))}" data-value="${s.value}">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No physical skills</span></div>'}
                    </div>
                    <div class="skill-category">
                        <h4 class="category-title">Social</h4>
                        ${skillsByCategory.social.length > 0 ? 
                            skillsByCategory.social.map(s => `
                                <div class="skill-row dice-selectable" data-type="skill" data-name="${escapeHtml(formatSkillName(s.name))}" data-value="${s.value}">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No social skills</span></div>'}
                    </div>
                    <div class="skill-category">
                        <h4 class="category-title">Mental</h4>
                        ${skillsByCategory.mental.length > 0 ? 
                            skillsByCategory.mental.map(s => `
                                <div class="skill-row dice-selectable" data-type="skill" data-name="${escapeHtml(formatSkillName(s.name))}" data-value="${s.value}">
                                    <span class="skill-name">${escapeHtml(formatSkillName(s.name))}</span>
                                    <span class="skill-dots" style="color: ${accentColor};">${getDotsDisplay(s.value)}</span>
                                </div>
                            `).join('') : '<div class="skill-row"><span class="skill-empty">No mental skills</span></div>'}
                    </div>
                `;
            }
            
            // ===== DICE ROLLER FUNCTIONALITY =====
            let selectedAttribute = null;
            let selectedSkill = null;
            
            // Attach dice roller event listeners
            function attachDiceRollerListeners() {
                // Click handlers for selectable rows
                document.querySelectorAll('.dice-selectable').forEach(row => {
                    row.addEventListener('click', function() {
                        const type = this.dataset.type;
                        const name = this.dataset.name;
                        const value = parseInt(this.dataset.value);
                        
                        if (type === 'attribute') {
                            // Deselect previous attribute
                            document.querySelectorAll('.dice-selectable[data-type="attribute"]').forEach(r => {
                                r.classList.remove('dice-selected');
                            });
                            // Toggle selection
                            if (selectedAttribute && selectedAttribute.name === name) {
                                selectedAttribute = null;
                            } else {
                                selectedAttribute = { name, value };
                                this.classList.add('dice-selected');
                            }
                        } else if (type === 'skill') {
                            // Deselect previous skill
                            document.querySelectorAll('.dice-selectable[data-type="skill"]').forEach(r => {
                                r.classList.remove('dice-selected');
                            });
                            // Toggle selection
                            if (selectedSkill && selectedSkill.name === name) {
                                selectedSkill = null;
                            } else {
                                selectedSkill = { name, value };
                                this.classList.add('dice-selected');
                            }
                        }
                        
                        updateDicePoolDisplay();
                    });
                });
                
                // Roll button handler
                const rollBtn = document.getElementById('roll-dice-btn');
                if (rollBtn) {
                    rollBtn.addEventListener('click', rollDice);
                }
                
                // Clear button handler
                const clearBtn = document.getElementById('clear-dice-btn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearDiceSelection);
                }
            }
            
            // Update the dice pool display
            function updateDicePoolDisplay() {
                const attrNameEl = document.getElementById('selected-attr-name');
                const attrDiceEl = document.getElementById('selected-attr-dice');
                const skillNameEl = document.getElementById('selected-skill-name');
                const skillDiceEl = document.getElementById('selected-skill-dice');
                const totalPoolEl = document.getElementById('total-dice-pool');
                const rollBtn = document.getElementById('roll-dice-btn');
                
                if (attrNameEl && attrDiceEl && skillNameEl && skillDiceEl && totalPoolEl) {
                    const attrValue = selectedAttribute ? selectedAttribute.value : 0;
                    const skillValue = selectedSkill ? selectedSkill.value : 0;
                    const totalPool = attrValue + skillValue;
                    
                    attrNameEl.textContent = selectedAttribute ? selectedAttribute.name : 'None selected';
                    attrDiceEl.textContent = attrValue + ' dice';
                    
                    skillNameEl.textContent = selectedSkill ? selectedSkill.name : 'None selected';
                    skillDiceEl.textContent = skillValue + ' dice';
                    
                    totalPoolEl.textContent = totalPool;
                    
                    // Enable roll button if at least one selection
                    if (rollBtn) {
                        rollBtn.disabled = totalPool === 0;
                    }
                }
            }
            
            // Roll dice and display results
            function rollDice() {
                const attrValue = selectedAttribute ? selectedAttribute.value : 0;
                const skillValue = selectedSkill ? selectedSkill.value : 0;
                const totalPool = attrValue + skillValue;
                
                if (totalPool === 0) return;
                
                // Roll d10 dice
                const rolls = [];
                for (let i = 0; i < totalPool; i++) {
                    rolls.push(Math.floor(Math.random() * 10) + 1);
                }
                
                // Count successes (6+)
                const successes = rolls.filter(r => r >= 6).length;
                const failures = rolls.length - successes;
                
                // Display results
                const resultsEl = document.getElementById('dice-results');
                const diceValuesEl = document.getElementById('dice-values');
                const successCountEl = document.getElementById('success-count');
                const failureCountEl = document.getElementById('failure-count');
                
                if (resultsEl && diceValuesEl && successCountEl && failureCountEl) {
                    // Show individual dice
                    diceValuesEl.innerHTML = rolls.map(roll => 
                        `<span class="die-result ${roll >= 6 ? 'success' : 'failure'}">${roll}</span>`
                    ).join('');
                    
                    // Update counts with emphasis on the higher number
                    const successNumEl = successCountEl.querySelector('.count-number');
                    const failureNumEl = failureCountEl.querySelector('.count-number');
                    
                    if (successNumEl) successNumEl.textContent = successes;
                    if (failureNumEl) failureNumEl.textContent = failures;
                    
                    // Add emphasis class to the higher count
                    successCountEl.classList.remove('emphasized');
                    failureCountEl.classList.remove('emphasized');
                    
                    if (successes > failures) {
                        successCountEl.classList.add('emphasized');
                    } else if (failures > successes) {
                        failureCountEl.classList.add('emphasized');
                    }
                    
                    // Show results section
                    resultsEl.classList.remove('hidden');
                }
            }
            
            // Clear dice selection
            function clearDiceSelection() {
                selectedAttribute = null;
                selectedSkill = null;
                
                // Remove selected class from all rows
                document.querySelectorAll('.dice-selectable').forEach(row => {
                    row.classList.remove('dice-selected');
                });
                
                // Update display
                updateDicePoolDisplay();
                
                // Hide results
                const resultsEl = document.getElementById('dice-results');
                if (resultsEl) {
                    resultsEl.classList.add('hidden');
                }
            }
            
            // Close modal
            modalCloseBtn.addEventListener('click', function() {
                characterModal.classList.remove('active');
            });
            
            characterModal.addEventListener('click', function(e) {
                if (e.target === characterModal) {
                    characterModal.classList.remove('active');
                }
            });
            
            // Filter handlers
            systemFilter.addEventListener('change', filterCharacters);
            campaignFilter.addEventListener('change', filterCharacters);
            
            function filterCharacters() {
                const systemValue = systemFilter.value;
                const campaignValue = campaignFilter.value;
                
                let filtered = userCharacters;
                
                if (systemValue !== 'all') {
                    filtered = filtered.filter(char => char.system === systemValue);
                }
                
                if (campaignValue === 'none') {
                    filtered = filtered.filter(char => !char.campaignId);
                } else if (campaignValue !== 'all') {
                    filtered = filtered.filter(char => char.campaignId === campaignValue);
                }
                
                renderCharacters(filtered);
            }
            
            // Initialize
            checkAuthState();
        });
    </script>
</body>
</html>
