<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Character - Werewolf 5e</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
</head>
<body>
    <!-- Embers Background Video -->
    <video class="embers-background" autoplay muted loop playsinline>
        <source src="Embers Background.mov" type="video/mp4">
    </video>

    <!-- Background Audio -->
    <audio id="background-audio" loop>
        <source src="High-Tech-Lab---Loop_AdobeStock_676139658.wav" type="audio/wav">
    </audio>

    <!-- Sound Toggle Button -->
    <button type="button" id="sound-toggle" class="sound-toggle" aria-label="Toggle sound">
        <svg id="sound-on-icon" class="sound-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg id="sound-off-icon" class="sound-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>

    <header class="sticky-header">
        <nav>
            <a href="index.html" class="nav-home" aria-label="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="account.html">Account</a>
            <a href="characters.html">Characters</a>
            <a href="sessions.html">Sessions</a>
            <a href="about.html">About Us</a>
        </nav>
        <a href="index.html" class="header-logo-link">
            <img src="https://github.com/user-attachments/assets/aaa6e10d-a24c-4711-8da7-2683d2028d7b" alt="RNBW Logo" class="header-logo">
        </a>
    </header>
    
    <main class="create-character-main">
        <h1>Create Your Character</h1>
        <p>Build your werewolf character for the apocalypse.</p>
        
        <section class="character-form-container">
            <form class="character-form" id="character-form">
                <!-- Step 1: Character Name -->
                <div class="adventure-step" id="step-name" data-step="1">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The mist parts before you, revealing a moonlit clearing. A figure emerges from the shadows, ancient eyes studying you carefully.</p>
                        <p class="adventure-question">"Traveler... what name do you carry?"</p>
                    </div>
                    <div class="form-group">
                        <label for="character-name">Your Name</label>
                        <input type="text" id="character-name" name="character-name" placeholder="Enter your name" required>
                    </div>
                    <div class="form-actions">
                        <a href="index.html" class="btn btn-secondary">Back</a>
                        <button type="button" class="btn btn-primary" id="next-to-gender">Continue</button>
                    </div>
                </div>

                <!-- Step 2: Gender -->
                <div class="adventure-step hidden" id="step-gender" data-step="2">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The ancient one nods slowly, a knowing smile crossing their weathered face.</p>
                        <p class="adventure-question">"<span id="spoken-name">Traveler</span>... and how do you walk through this world?"</p>
                    </div>
                    <div class="form-group">
                        <label for="gender">Your Identity</label>
                        <div class="gender-choices">
                            <button type="button" class="choice-btn" data-gender="male">Male</button>
                            <button type="button" class="choice-btn" data-gender="female">Female</button>
                            <button type="button" class="choice-btn" data-gender="non-binary">Non-Binary</button>
                            <button type="button" class="choice-btn" data-gender="genderfluid">Genderfluid</button>
                            <button type="button" class="choice-btn" data-gender="agender">Agender</button>
                        </div>
                        <input type="hidden" id="gender" name="gender">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-name">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-tribe" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 3: Tribe Questionnaire -->
                <div class="adventure-step hidden" id="step-tribe" data-step="3">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt" id="tribe-quest-prompt">The figure's eyes gleam with an otherworldly light as the wind carries whispers of ancient packs.</p>
                        <p class="adventure-question" id="tribe-quest-question">"Before I can tell you which tribe's blood runs strongest in your veins, I must understand who you truly are. Let me peer into the moments that shaped your spirit..."</p>
                    </div>
                    <div class="form-group">
                        <p class="tribe-progress" id="tribe-progress">Question 1 of 25</p>
                        <div class="tribe-question-container" id="tribe-question-container">
                            <!-- Questions will be dynamically populated -->
                        </div>
                        <input type="hidden" id="tribe" name="tribe">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-gender">Back</button>
                        <button type="button" class="btn btn-primary" id="prev-tribe-question" style="display: none;">Previous</button>
                        <button type="button" class="btn btn-primary" id="next-tribe-question" disabled>Next</button>
                    </div>
                </div>

                <!-- Step 3b: Tribe Result -->
                <div class="adventure-step hidden" id="step-tribe-result" data-step="3b">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder's eyes close for a long moment. When they open again, they shine with ancient wisdom.</p>
                        <p class="adventure-question" id="tribe-result-question">"The spirits have spoken. Your true tribe has been revealed..."</p>
                    </div>
                    <div class="form-group">
                        <div class="tribe-result-container" id="tribe-result-container">
                            <!-- Result will be dynamically populated -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-tribe-questions">Retake Questionnaire</button>
                        <button type="button" class="btn btn-primary" id="next-to-auspice">Continue</button>
                    </div>
                </div>

                <!-- Step 4: Auspice -->
                <div class="adventure-step hidden" id="step-auspice" data-step="4">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">Above, Luna reveals herself through the parting clouds, her silver light bathing the clearing.</p>
                        <p class="adventure-question">"Under which phase of Luna were you born? What role does she bestow upon you?"</p>
                    </div>
                    
                    <!-- Birth Date Selection (Auto-calculate Auspice) -->
                    <div class="form-group" id="birthdate-group">
                        <label for="birthdate">Your Birth Date</label>
                        <div class="birthdate-input-wrapper">
                            <input type="date" id="birthdate" name="birthdate" placeholder="Enter your birth date">
                            <button type="button" class="btn-manual-select" id="toggle-manual-auspice" title="Choose manually instead">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="auspice-result" id="auspice-result"></p>
                    </div>
                    
                    <!-- Manual Auspice Selection (Hidden by default) -->
                    <div class="form-group hidden" id="manual-auspice-group">
                        <label for="auspice-select">Choose Your Auspice</label>
                        <div class="auspice-choices">
                            <button type="button" class="choice-btn auspice-choice" data-auspice="ragabash">
                                <span class="moon-icon">üåë</span>
                                <span class="auspice-name">Ragabash</span>
                                <span class="moon-phase">New Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="theurge">
                                <span class="moon-icon">üåí</span>
                                <span class="auspice-name">Theurge</span>
                                <span class="moon-phase">Crescent Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="philodox">
                                <span class="moon-icon">üåì</span>
                                <span class="auspice-name">Philodox</span>
                                <span class="moon-phase">Half Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="galliard">
                                <span class="moon-icon">üåî</span>
                                <span class="auspice-name">Galliard</span>
                                <span class="moon-phase">Gibbous Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="ahroun">
                                <span class="moon-icon">üåï</span>
                                <span class="auspice-name">Ahroun</span>
                                <span class="moon-phase">Full Moon</span>
                            </button>
                        </div>
                        <button type="button" class="btn-back-to-birthdate" id="back-to-birthdate">
                            ‚Üê Use birth date instead
                        </button>
                    </div>
                    
                    <input type="hidden" id="auspice" name="auspice">
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-tribe">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-attributes" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 5: Primary Attribute Category -->
                <div class="adventure-step hidden" id="step-attr-category" data-step="5">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder's weathered hand reaches toward you, then pauses. Their nostrils flare, drinking in your scent as a wolf might assess prey‚Äîor pack. "I would know what manner of creature stands before me," they murmur, voice like gravel scraping stone. "When the world burns and the Wyrm's corruption seeps into everything you love, what will you trust to see you through?"</p>
                        <p class="adventure-question">In the darkest moment, when all seems lost, you have always relied upon...</p>
                    </div>
                    <div class="form-group">
                        <div class="attribute-choices">
                            <button type="button" class="choice-btn attribute-category-choice" data-category="physical">
                                <span class="choice-title">The flesh that carries you</span>
                                <span class="choice-desc">Your body has never failed you. When words ring hollow and clever plans crumble, it is sinew and bone that have carried you through. You trust in the vessel you were born with‚Äîits strength, its quickness, its stubborn refusal to fall.</span>
                            </button>
                            <button type="button" class="choice-btn attribute-category-choice" data-category="social">
                                <span class="choice-title">Those who stand beside you</span>
                                <span class="choice-desc">No wolf survives alone. You have learned this truth in blood and tears. Your greatest victories have come not from your own prowess, but from the bonds you forge, the hearts you move, the pack that answers when you howl.</span>
                            </button>
                            <button type="button" class="choice-btn attribute-category-choice" data-category="mental">
                                <span class="choice-title">The thoughts within your skull</span>
                                <span class="choice-desc">While others charge blindly forward, you have always seen the patterns others miss. Your mind is your weapon‚Äîsharp, patient, cutting through chaos to find the path that others cannot perceive.</span>
                            </button>
                        </div>
                        <input type="hidden" id="primary-category" name="primary-category">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-auspice">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-primary-attr" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 6: Primary Attribute Selection -->
                <div class="adventure-step hidden" id="step-primary-attr" data-step="6">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt" id="primary-attr-prompt">The elder's lips curl into something that might be a smile. "Yes," they breathe. "I see it in you now. But even the mightiest oak has a taproot that runs deepest. Tell me of the core that defines you."</p>
                        <p class="adventure-question" id="primary-attr-question">When you strip away everything else, what truth remains at your center?</p>
                    </div>
                    <div class="form-group">
                        <div class="attribute-choices" id="primary-attr-choices">
                            <!-- Dynamically populated based on category choice -->
                        </div>
                        <input type="hidden" id="primary-attribute" name="primary-attribute">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-category">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-secondary-category" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 7: Secondary Attribute Category -->
                <div class="adventure-step hidden" id="step-secondary-category" data-step="7">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">A cold wind cuts through the clearing, carrying the distant howl of wolves‚Äîor perhaps something worse. The elder tilts their head, listening to sounds you cannot hear. "We are not creatures of single purpose," they say at last. "The Garou who survives is the one who can adapt. Beyond your greatest gift, what else sustains you?"</p>
                        <p class="adventure-question">When your primary nature fails you, what do you fall back upon?</p>
                    </div>
                    <div class="form-group">
                        <div class="attribute-choices" id="secondary-category-choices">
                            <!-- Dynamically populated excluding primary category -->
                        </div>
                        <input type="hidden" id="secondary-category" name="secondary-category">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-primary-attr">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-secondary-attrs" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 8: Secondary Attributes Selection -->
                <div class="adventure-step hidden" id="step-secondary-attrs" data-step="8">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt" id="secondary-attrs-prompt">The elder begins to circle you slowly, like a predator assessing its prey‚Äîor perhaps a teacher measuring a student. "You carry many gifts," they observe, "some sharper than others. Of the talents that have served you well, which three would you trust with your life?"</p>
                        <p class="adventure-question">Select the three aspects that have proven most reliable in your past struggles.</p>
                    </div>
                    <div class="form-group">
                        <p class="selection-counter" id="secondary-counter">Chosen: 0 of 3</p>
                        <div class="attribute-choices multi-select" id="secondary-attr-choices">
                            <!-- Dynamically populated -->
                        </div>
                        <input type="hidden" id="secondary-attributes" name="secondary-attributes">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-secondary-category">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-tertiary-attrs" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 9: Tertiary Attributes -->
                <div class="adventure-step hidden" id="step-tertiary-attrs" data-step="9">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder stops before you, their ancient eyes holding yours with an intensity that makes your heart stutter. "No creature is perfect," they whisper. "We all carry weakness alongside strength. The wise warrior knows where they falter." They gesture to the remaining paths before you. "Choose four more aspects that serve you adequately. The one you leave behind... that is where your enemies will strike."</p>
                        <p class="adventure-question">Of these remaining qualities, which four can you still rely upon? The fifth will be your vulnerability.</p>
                    </div>
                    <div class="form-group">
                        <p class="selection-info">The aspects you choose will serve you adequately. What remains will be your weakness‚Äîthe gap in your armor that your foes may one day exploit.</p>
                        <p class="selection-counter" id="tertiary-counter">Chosen: 0 of 4</p>
                        <div class="attribute-choices multi-select" id="tertiary-attr-choices">
                            <!-- Dynamically populated with remaining attributes -->
                        </div>
                        <input type="hidden" id="tertiary-attributes" name="tertiary-attributes">
                        <input type="hidden" id="weakest-attribute" name="weakest-attribute">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-secondary-attrs">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-skill-type" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 10: Skill Distribution Type -->
                <div class="adventure-step hidden" id="step-skill-type" data-step="10">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder's gaze softens slightly, and they gesture to a weathered stone nearby. "Sit, young one. The attributes of your soul are set, but what of the skills you have honed through your mortal years? Tell me... how have you spent your time before the Change?"</p>
                        <p class="adventure-question">"What manner of learner are you?"</p>
                        <p class="selection-info">New players are recommended to choose "Jack of All Trades" for a well-rounded character.</p>
                    </div>
                    <div class="form-group">
                        <div class="attribute-choices" id="skill-type-choices">
                            <button type="button" class="choice-btn skill-type-choice" data-skill-type="jack">
                                <span class="choice-title">A Jack of All Trades</span>
                                <span class="choice-desc">You've dabbled in everything, never staying too long in one place or one pursuit. You know a little about a lot‚Äîenough to get by in almost any situation, though mastery has always eluded you. Your breadth of experience makes you adaptable.</span>
                                <span class="skill-type-details">One skill at 3, eight at 2, ten at 1 (29 points)</span>
                            </button>
                            <button type="button" class="choice-btn skill-type-choice" data-skill-type="balanced">
                                <span class="choice-title">Balanced</span>
                                <span class="choice-desc">You've found harmony between focus and flexibility. You've developed a handful of stronger skills while maintaining competence in others. You're neither a master nor a dilettante‚Äîyou're practical.</span>
                                <span class="skill-type-details">Three skills at 3, five at 2, seven at 1 (26 points)</span>
                            </button>
                            <button type="button" class="choice-btn skill-type-choice" data-skill-type="specialist">
                                <span class="choice-title">A Specialist</span>
                                <span class="choice-desc">You've poured yourself into your passions with single-minded dedication. Where others spread themselves thin, you dove deep. You may lack breadth, but in your chosen fields, few can match you.</span>
                                <span class="skill-type-details">One skill at 4, three at 3, three at 2, three at 1 (22 points)</span>
                            </button>
                        </div>
                        <input type="hidden" id="skill-type" name="skill-type">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-tertiary-attrs">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-skills-quest" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 11: Skills Questionnaire -->
                <div class="adventure-step hidden" id="step-skills-quest" data-step="11">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt" id="skills-quest-prompt">The elder leans forward, eyes gleaming with curiosity. "Now let me see what life has taught you..."</p>
                        <p class="adventure-question" id="skills-quest-question">"Tell me of a moment that shaped you."</p>
                    </div>
                    <div class="form-group">
                        <p class="skill-progress" id="skill-progress">Scenario 1</p>
                        <p class="skill-points-remaining" id="skill-points-remaining">Points remaining: 29</p>
                        <div class="skill-question-container" id="skill-question-container">
                            <!-- Questions will be dynamically populated -->
                        </div>
                        <input type="hidden" id="skills-data" name="skills-data">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-skill-type">Back</button>
                        <button type="button" class="btn btn-primary" id="next-skill-question" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 12: Skills Result -->
                <div class="adventure-step hidden" id="step-skills-result" data-step="12">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder nods slowly, a knowing smile crossing their ancient features. "I see now the shape of your past, the skills forged through trial and experience."</p>
                        <p class="adventure-question">"These are the abilities you carry into your new life."</p>
                    </div>
                    <div class="form-group">
                        <div class="skills-result-container" id="skills-result-container">
                            <!-- Skills will be dynamically populated -->
                        </div>
                        <div class="backstory-container" id="backstory-container">
                            <h4>Your Story So Far</h4>
                            <div class="backstory-text" id="backstory-text" contenteditable="true">
                                <!-- Backstory will be dynamically populated -->
                            </div>
                            <p class="backstory-hint">You may edit your backstory above.</p>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-skills-quest">Retake Questionnaire</button>
                        <button type="button" class="btn btn-primary" id="next-to-summary">Continue</button>
                    </div>
                </div>

                <!-- Step 13: Character Summary -->
                <div class="adventure-step hidden" id="step-summary" data-step="13">
                    <div class="sticky-question-container">
                        <p class="adventure-prompt">The elder falls silent at last. For a long moment, they simply regard you, and in their ancient eyes you see something that might be respect‚Äîor perhaps recognition. "The spirits have whispered your truth to me," they say finally, their voice soft as falling ash. "I know now what manner of Garou stands before me."</p>
                        <p class="adventure-question">Your nature has been revealed. This is who you are.</p>
                    </div>
                    <div class="character-summary" id="character-summary">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-tertiary">Back</button>
                        <button type="submit" class="btn btn-primary" id="submit-character">Begin Your Journey</button>
                    </div>
                </div>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('background-audio');
            const soundToggle = document.getElementById('sound-toggle');
            const soundOnIcon = document.getElementById('sound-on-icon');
            const soundOffIcon = document.getElementById('sound-off-icon');
            
            let isMuted = false; // Start with audio on by default
            
            // Update icon display
            function updateSoundIcon() {
                if (isMuted) {
                    soundOnIcon.classList.add('hidden');
                    soundOffIcon.classList.remove('hidden');
                } else {
                    soundOnIcon.classList.remove('hidden');
                    soundOffIcon.classList.add('hidden');
                }
            }
            
            // Toggle sound on/off
            soundToggle.addEventListener('click', function() {
                isMuted = !isMuted;
                audio.muted = isMuted;
                
                if (!isMuted) {
                    audio.play().catch(function(error) {
                        console.log('Audio play failed:', error);
                    });
                }
                
                updateSoundIcon();
            });
            
            // Initialize audio state - auto-play on page load
            audio.muted = isMuted;
            updateSoundIcon();
            
            // Auto-play audio on page load
            audio.play().catch(function(error) {
                console.log('Auto-play failed (browser may require user interaction):', error);
                // If auto-play fails, set to muted state
                isMuted = true;
                audio.muted = true;
                updateSoundIcon();
            });

            // Adventure Step Navigation
            const steps = {
                name: document.getElementById('step-name'),
                gender: document.getElementById('step-gender'),
                tribe: document.getElementById('step-tribe'),
                auspice: document.getElementById('step-auspice')
            };

            const characterNameInput = document.getElementById('character-name');
            const genderInput = document.getElementById('gender');
            const spokenName = document.getElementById('spoken-name');
            const genderChoices = document.querySelectorAll('.choice-btn[data-gender]');
            const nextToGenderBtn = document.getElementById('next-to-gender');
            const nextToAuspiceBtn = document.getElementById('next-to-auspice');

            // Show step function with fade transition
            function showStep(currentStep, stepToShow) {
                if (currentStep) {
                    currentStep.classList.add('fade-out');
                    setTimeout(function() {
                        Object.values(steps).forEach(function(step) {
                            step.classList.add('hidden');
                            step.classList.remove('fade-out');
                        });
                        stepToShow.classList.remove('hidden');
                    }, 500);
                } else {
                    Object.values(steps).forEach(function(step) {
                        step.classList.add('hidden');
                    });
                    stepToShow.classList.remove('hidden');
                }
            }

            // Step 1 -> Step 2 (Name to Gender)
            nextToGenderBtn.addEventListener('click', function() {
                const name = characterNameInput.value.trim();
                if (name) {
                    spokenName.textContent = name;
                    showStep(steps.name, steps.gender);
                } else {
                    characterNameInput.focus();
                }
            });

            // Allow Enter key to proceed from name input
            characterNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    nextToGenderBtn.click();
                }
            });

            // Step 2: Gender selection
            genderChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    genderChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    btn.classList.add('selected');
                    // Update hidden input
                    genderInput.value = btn.dataset.gender;
                    // Enable continue button
                    document.getElementById('next-to-tribe').disabled = false;
                });
            });

            // Step 2 -> Step 3 (Gender to Tribe)
            document.getElementById('next-to-tribe').addEventListener('click', function() {
                if (genderInput.value) {
                    initializeTribeQuestionnaire();
                    showStep(steps.gender, steps.tribe);
                }
            });

            // ===== TRIBE QUESTIONNAIRE SYSTEM =====
            
            // Tribe descriptions for tie-breaker and result display
            const tribeDescriptions = {
                'black-furies': {
                    name: 'Black Furies',
                    description: 'Fierce defenders of the wild and the wronged, the Black Furies channel righteous fury against those who would harm the innocent or despoil Gaia. They are warriors of vengeance, protectors of sacred places, and champions of those who cannot fight for themselves. Their rage burns cold and precise, and their justice is absolute.',
                    values: 'Justice, Protection, Feminine Power, Sacred Rage, Defense of the Innocent'
                },
                'bone-gnawers': {
                    name: 'Bone Gnawers',
                    description: 'Survivors of the margins, the Bone Gnawers thrive where others would perish. They know the streets, the forgotten places, and the desperate wisdom of those who have nothing. They are resourceful, adaptable, and fiercely loyal to their pack and the downtrodden. What others discard, they transform into strength.',
                    values: 'Survival, Resourcefulness, Community, Street Wisdom, Humility'
                },
                'children-of-gaia': {
                    name: 'Children of Gaia',
                    description: 'Healers and peacemakers, the Children of Gaia seek unity where others find division. They believe that compassion is strength, and that the war against the Wyrm cannot be won through rage alone. They are mediators between tribes, menders of spiritual wounds, and voices of hope in desperate times.',
                    values: 'Peace, Healing, Unity, Compassion, Mediation'
                },
                'fianna': {
                    name: 'Fianna',
                    description: 'Passionate keepers of stories and songs, the Fianna carry the living memory of the Garou. They celebrate life with fierce joy, mourn death with profound sorrow, and face battle with a warrior\'s heart and a poet\'s soul. Their tales inspire courage, and their songs carry power.',
                    values: 'Passion, Storytelling, Honor, Celebration, Artistic Expression'
                },
                'ghost-council': {
                    name: 'Ghost Council',
                    description: 'Once known as the Get of Fenris, the Ghost Council has emerged from tragedy transformed. They carry the weight of past mistakes and the determination to forge a new path. They value strength tempered by wisdom, courage balanced by reflection, and honor that serves the greater good.',
                    values: 'Redemption, Strength, Honor, Self-Improvement, Warrior Spirit'
                },
                'glass-walkers': {
                    name: 'Glass Walkers',
                    description: 'Adapters and innovators, the Glass Walkers have embraced the human world\'s technology and urban sprawl. They see opportunity where others see corruption, and they work to turn humanity\'s tools against the Wyrm. They are hackers, corporate infiltrators, and masters of the modern age.',
                    values: 'Innovation, Adaptation, Technology, Progress, Urban Wisdom'
                },
                'red-talons': {
                    name: 'Red Talons',
                    description: 'Voices of the wild, the Red Talons remember what others have forgotten‚Äîthat Garou are wolves first. They reject human weakness and embrace the primal truth of fang and claw. They are fierce defenders of wild places and the creatures that dwell within them.',
                    values: 'Nature, Primal Instinct, Wilderness Protection, Wolf Heritage, Simplicity'
                },
                'shadow-lords': {
                    name: 'Shadow Lords',
                    description: 'Masters of politics and power, the Shadow Lords understand that victory often comes through cunning rather than claws. They lead from the shadows, manipulate events to serve the greater good, and make the hard decisions others cannot. Authority is their birthright, and they wield it without apology.',
                    values: 'Leadership, Strategy, Ambition, Political Cunning, Decisive Action'
                },
                'silent-striders': {
                    name: 'Silent Striders',
                    description: 'Wanderers cursed to never find home, the Silent Striders walk between worlds and places. They carry messages across vast distances, commune with the dead, and know secrets hidden in forgotten corners of the world. Their loneliness is profound, but their wisdom is vast.',
                    values: 'Travel, Mystery, Communication, Spiritual Connection, Seeking'
                },
                'silver-fangs': {
                    name: 'Silver Fangs',
                    description: 'Noble leaders of the Garou Nation, the Silver Fangs bear the weight of royal blood and ancient duty. They are bred to command, trained to inspire, and burdened with the expectation of greatness. Their lineage is glorious, though some say the glory fades.',
                    values: 'Nobility, Leadership, Tradition, Honor, Royal Duty'
                },
                'stargazers': {
                    name: 'Stargazers',
                    description: 'Seekers of inner truth, the Stargazers pursue enlightenment through meditation and self-mastery. They see the war against the Wyrm as first a war within‚Äîagainst one\'s own rage and weakness. They are philosophers, mystics, and masters of balance.',
                    values: 'Wisdom, Balance, Inner Peace, Self-Control, Enlightenment'
                }
            };

            // 25 Tribe Questions - each answer maps to a tribe
            // Distribution: Each tribe has at least 5 answers across all questions
            const tribeQuestions = [
                {
                    prompt: "You witness a powerful figure publicly humiliating someone weaker. What do you do?",
                    answers: [
                        { text: "Confront them directly‚Äîno one should abuse power like this.", tribe: "black-furies" },
                        { text: "Help the victim slip away quietly, then plot how to humble the bully later.", tribe: "bone-gnawers" },
                        { text: "Step between them and try to de-escalate before violence erupts.", tribe: "children-of-gaia" },
                        { text: "Make a scene that embarrasses the bully and turns the crowd against them.", tribe: "fianna" },
                        { text: "Challenge them openly‚Äîlet them face someone their own size.", tribe: "ghost-council" }
                    ]
                },
                {
                    prompt: "You discover a sacred grove is threatened by a construction project. How do you respond?",
                    answers: [
                        { text: "Organize protests and bring attention to the sacred nature of the site.", tribe: "black-furies" },
                        { text: "Hack their systems and create bureaucratic nightmares that delay them indefinitely.", tribe: "glass-walkers" },
                        { text: "Destroy their equipment under cover of darkness‚Äîthey'll learn to fear the wild.", tribe: "red-talons" },
                        { text: "Find leverage against the project leaders and convince them to relocate.", tribe: "shadow-lords" },
                        { text: "Seek visions to understand what spirits dwell there and how to protect them.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "Your pack faces an impossible battle. How do you prepare?",
                    answers: [
                        { text: "Gather every scrap of useful material and improvise weapons and traps.", tribe: "bone-gnawers" },
                        { text: "Compose a war song to steel your hearts and record your deeds.", tribe: "fianna" },
                        { text: "Train relentlessly‚Äîface your weakness and overcome it through effort.", tribe: "ghost-council" },
                        { text: "Research the enemy's weaknesses and develop a precise tactical plan.", tribe: "glass-walkers" },
                        { text: "Appeal to allied packs and spirits, building a coalition of strength.", tribe: "silver-fangs" }
                    ]
                },
                {
                    prompt: "You meet a lost young werewolf who has just undergone their First Change. What's your priority?",
                    answers: [
                        { text: "Protect them from those who might exploit their confusion.", tribe: "black-furies" },
                        { text: "Share what you know about surviving on the streets and staying hidden.", tribe: "bone-gnawers" },
                        { text: "Comfort them and help them understand they're not alone in this.", tribe: "children-of-gaia" },
                        { text: "Take them somewhere wild where they can connect with their wolf nature.", tribe: "red-talons" },
                        { text: "Guide them through meditation to find calm amid the chaos within.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "Your pack needs information from a dangerous spirit. How do you approach this?",
                    answers: [
                        { text: "Seek out the dead who might know this spirit's secrets.", tribe: "silent-striders" },
                        { text: "Meditate to find the right questions and approach with respect.", tribe: "stargazers" },
                        { text: "Research ancient texts and consult with spirit talkers.", tribe: "silver-fangs" },
                        { text: "Approach with offerings and humble words, seeking mutual benefit.", tribe: "children-of-gaia" },
                        { text: "Confront the spirit with strength‚Äîshow it you won't be intimidated.", tribe: "black-furies" }
                    ]
                },
                {
                    prompt: "You discover corruption within your own pack. How do you handle it?",
                    answers: [
                        { text: "Expose it immediately‚Äîcorruption must be purged without mercy.", tribe: "black-furies" },
                        { text: "Work to rehabilitate the fallen member if there's any hope for them.", tribe: "children-of-gaia" },
                        { text: "Challenge them honorably and give them a chance to redeem themselves.", tribe: "ghost-council" },
                        { text: "Manipulate events so they expose themselves before the pack.", tribe: "shadow-lords" },
                        { text: "Uphold the traditions of judgment‚Äîcorruption disgraces us all.", tribe: "silver-fangs" }
                    ]
                },
                {
                    prompt: "A human community is suffering from an unexplained sickness. What do you investigate first?",
                    answers: [
                        { text: "The corporate facilities nearby‚Äîthey're always hiding something.", tribe: "glass-walkers" },
                        { text: "The wild places that have been disturbed or destroyed recently.", tribe: "red-talons" },
                        { text: "The spirits of the land to see if they know the source.", tribe: "stargazers" },
                        { text: "The patterns of death and illness‚Äîthe dead sometimes whisper truth.", tribe: "silent-striders" },
                        { text: "The local power structures‚Äîwho benefits from this suffering?", tribe: "shadow-lords" }
                    ]
                },
                {
                    prompt: "You have a chance to gain significant power, but it would mean abandoning someone who needs you. What do you choose?",
                    answers: [
                        { text: "Stay with the one who needs me‚Äîpower means nothing without loyalty.", tribe: "children-of-gaia" },
                        { text: "Find a creative way to do both‚Äîthere's always another angle.", tribe: "bone-gnawers" },
                        { text: "Take the power‚Äîwith it, I can help many more than just one.", tribe: "shadow-lords" },
                        { text: "Power is fleeting; honor and the stories told of us last forever.", tribe: "fianna" },
                        { text: "True power comes from within, not from external sources.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "Your pack must choose a new alpha. How do you think this should be decided?",
                    answers: [
                        { text: "Through fair combat‚Äîlet the strongest lead.", tribe: "ghost-council" },
                        { text: "The one with the best strategic mind should lead us to victory.", tribe: "shadow-lords" },
                        { text: "Whoever can unite us and bring out our best should lead.", tribe: "children-of-gaia" },
                        { text: "The one with the purest bloodline and greatest honor.", tribe: "silver-fangs" },
                        { text: "Let the spirits and ancestors guide us to the right choice.", tribe: "fianna" }
                    ]
                },
                {
                    prompt: "You find evidence of a major Wyrm threat, but sharing it would expose a fellow Garou's secret shame. What do you do?",
                    answers: [
                        { text: "The threat to Gaia comes first‚Äîshare the information.", tribe: "red-talons" },
                        { text: "Find a way to reveal the threat while protecting my kinsman's honor.", tribe: "silver-fangs" },
                        { text: "Confront the Garou privately first and give them a chance to come forward.", tribe: "ghost-council" },
                        { text: "Use the information carefully‚Äîknowledge is power when wielded right.", tribe: "shadow-lords" },
                        { text: "Seek guidance through meditation on the right path forward.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "You're offered a place of comfort and safety, but it means abandoning the road. What do you do?",
                    answers: [
                        { text: "Keep moving‚Äîthere's always another message to carry, another place to see.", tribe: "silent-striders" },
                        { text: "Accept for now, but know that roads call to those who must walk them.", tribe: "silent-striders" },
                        { text: "Safety is an illusion‚Äîthe wild offers truer shelter than any building.", tribe: "red-talons" },
                        { text: "Build something there‚Äîmake it a haven for others like you.", tribe: "bone-gnawers" },
                        { text: "Use it as a base of operations while you plan your next move.", tribe: "glass-walkers" }
                    ]
                },
                {
                    prompt: "A rival pack insults your pack's honor publicly. How do you respond?",
                    answers: [
                        { text: "Challenge their strongest to single combat to settle this.", tribe: "ghost-council" },
                        { text: "Respond with an even more devastating public humiliation.", tribe: "fianna" },
                        { text: "Seek to understand why they feel this way and find common ground.", tribe: "children-of-gaia" },
                        { text: "Ignore the words and let your deeds speak louder.", tribe: "stargazers" },
                        { text: "Remember this insult and ensure they regret it when the time is right.", tribe: "shadow-lords" }
                    ]
                },
                {
                    prompt: "You discover an ancient artifact of power. What do you do with it?",
                    answers: [
                        { text: "Study it thoroughly before deciding‚Äîknowledge prevents mistakes.", tribe: "glass-walkers" },
                        { text: "Take it to the elders and let tradition guide its use.", tribe: "silver-fangs" },
                        { text: "Destroy it if there's any chance the Wyrm could claim it.", tribe: "red-talons" },
                        { text: "Sing its story so that its power can inspire others.", tribe: "fianna" },
                        { text: "Seek visions of its history to understand its true purpose.", tribe: "silent-striders" }
                    ]
                },
                {
                    prompt: "Your packmate is overwhelmed by Rage and might hurt innocents. What do you do?",
                    answers: [
                        { text: "Restrain them physically‚Äîtheir Rage cannot be allowed to harm the innocent.", tribe: "black-furies" },
                        { text: "Help them channel it toward a worthy target instead.", tribe: "ghost-council" },
                        { text: "Speak calmly and help them find their center again.", tribe: "children-of-gaia" },
                        { text: "Lead them away from people to somewhere they can rage safely.", tribe: "red-talons" },
                        { text: "Guide them through breathing techniques to regain control.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "You must deliver urgent news across a vast distance. How do you travel?",
                    answers: [
                        { text: "Run through the spirit world‚Äîthe Umbra knows shortcuts.", tribe: "silent-striders" },
                        { text: "Use every modern convenience‚Äîplanes, cars, networks.", tribe: "glass-walkers" },
                        { text: "Run as a wolf across the wild places, where no roads slow you.", tribe: "red-talons" },
                        { text: "Reach out to contacts along the way who can relay the message faster.", tribe: "bone-gnawers" },
                        { text: "Call upon allies and favors owed to speed your journey.", tribe: "shadow-lords" }
                    ]
                },
                {
                    prompt: "A human you care about discovers what you truly are. How do you handle this?",
                    answers: [
                        { text: "Be honest with them‚Äîthey deserve the truth and the choice to stay or go.", tribe: "children-of-gaia" },
                        { text: "Help them understand the importance of secrecy for everyone's safety.", tribe: "glass-walkers" },
                        { text: "Disappear from their life‚Äîit's safer for both of you.", tribe: "silent-striders" },
                        { text: "This is why we shouldn't get close to humans in the first place.", tribe: "red-talons" },
                        { text: "Weave them into our world carefully‚Äîthey could become a valuable ally.", tribe: "shadow-lords" }
                    ]
                },
                {
                    prompt: "You witness a great injustice but acting would reveal the Garou to humans. What do you do?",
                    answers: [
                        { text: "Act anyway‚Äîsome things are more important than secrecy.", tribe: "black-furies" },
                        { text: "Find a way to act that won't expose us but still brings justice.", tribe: "bone-gnawers" },
                        { text: "Humans have their own justice systems‚Äîguide them to act instead.", tribe: "children-of-gaia" },
                        { text: "The Veil exists for a reason; we must find another way.", tribe: "silver-fangs" },
                        { text: "Document everything and ensure justice comes eventually, even if delayed.", tribe: "glass-walkers" }
                    ]
                },
                {
                    prompt: "You're asked to lead a dangerous mission with high casualties expected. How do you lead?",
                    answers: [
                        { text: "From the front‚ÄîI won't ask others to take risks I won't take.", tribe: "ghost-council" },
                        { text: "With careful planning to minimize losses while achieving objectives.", tribe: "shadow-lords" },
                        { text: "By inspiring everyone with tales of glory and the honor of sacrifice.", tribe: "fianna" },
                        { text: "By ensuring everyone knows what we're fighting for and chooses freely.", tribe: "children-of-gaia" },
                        { text: "With the dignity and composure expected of true leaders.", tribe: "silver-fangs" }
                    ]
                },
                {
                    prompt: "A sacred ritual requires a rare component. How do you obtain it?",
                    answers: [
                        { text: "Trade for it using connections in the underground economy.", tribe: "bone-gnawers" },
                        { text: "Quest to find it in the wild places where such things still exist.", tribe: "red-talons" },
                        { text: "Research and synthesize an alternative using modern methods.", tribe: "glass-walkers" },
                        { text: "Consult the spirits and ancestors about where it can be found.", tribe: "fianna" },
                        { text: "Meditate until a vision reveals the path to it.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "Your pack discovers a Garou who has committed terrible crimes but now genuinely seeks redemption. What's your vote?",
                    answers: [
                        { text: "Everyone deserves a chance at redemption if they truly seek it.", tribe: "children-of-gaia" },
                        { text: "Let them prove themselves through trials‚Äîredemption must be earned.", tribe: "ghost-council" },
                        { text: "Their crimes cannot be forgiven‚Äîjustice must be served.", tribe: "black-furies" },
                        { text: "Judge them by their bloodline and what tradition demands.", tribe: "silver-fangs" },
                        { text: "Their past is less important than their usefulness to our cause.", tribe: "shadow-lords" }
                    ]
                },
                {
                    prompt: "You find yourself alone in an unfamiliar city with no resources. What do you do first?",
                    answers: [
                        { text: "Find the local street community‚Äîthey know how to survive here.", tribe: "bone-gnawers" },
                        { text: "Access the digital networks to gather information and resources.", tribe: "glass-walkers" },
                        { text: "Seek out any wild spaces, even parks, to center yourself.", tribe: "red-talons" },
                        { text: "Walk and observe until you understand the flow of this place.", tribe: "silent-striders" },
                        { text: "Find quiet and meditate on your situation before acting.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "An elder asks you to preserve an important story for future generations. How do you do this?",
                    answers: [
                        { text: "Learn it by heart and perform it at every gathering.", tribe: "fianna" },
                        { text: "Record it using modern technology so it can never be lost.", tribe: "glass-walkers" },
                        { text: "Teach it to the young ones who will carry it forward.", tribe: "silver-fangs" },
                        { text: "Encode it in the spirit world where it will exist eternally.", tribe: "stargazers" },
                        { text: "Carry it with you as you travel, spreading it far and wide.", tribe: "silent-striders" }
                    ]
                },
                {
                    prompt: "You sense great sorrow in a packmate who won't speak of it. What do you do?",
                    answers: [
                        { text: "Create a safe space for them to share when they're ready.", tribe: "children-of-gaia" },
                        { text: "Share a story of your own pain to show they're not alone.", tribe: "fianna" },
                        { text: "Respect their silence‚Äîsome burdens we must carry alone.", tribe: "silent-striders" },
                        { text: "Help them channel their pain into purpose and action.", tribe: "ghost-council" },
                        { text: "Sit with them in silence‚Äîsometimes presence is enough.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "You have the opportunity to strike a decisive blow against the Wyrm, but innocents might be caught in the crossfire. What do you decide?",
                    answers: [
                        { text: "Find another way‚Äîthe innocent must be protected above all.", tribe: "black-furies" },
                        { text: "Protect those you can, but the Wyrm must be stopped at any cost.", tribe: "red-talons" },
                        { text: "Weigh the numbers‚Äîhow many will the Wyrm kill if we don't act?", tribe: "shadow-lords" },
                        { text: "There's always a way to minimize harm if you're clever enough.", tribe: "bone-gnawers" },
                        { text: "Seek spiritual guidance before making such a heavy choice.", tribe: "stargazers" }
                    ]
                },
                {
                    prompt: "How do you prefer to spend the quiet moments between battles?",
                    answers: [
                        { text: "Running wild in the forest, reconnecting with my wolf nature.", tribe: "red-talons" },
                        { text: "Telling stories and sharing drinks with my packmates.", tribe: "fianna" },
                        { text: "Meditating and seeking inner peace to prepare for what comes.", tribe: "stargazers" },
                        { text: "Training and improving my skills‚Äîthere's always room to grow.", tribe: "ghost-council" },
                        { text: "Wandering to new places and meeting new faces.", tribe: "silent-striders" }
                    ]
                }
            ];

            // Tribe score tracking
            let tribeScores = {};
            let currentTribeQuestion = 0;
            let tribeAnswers = [];
            
            // Initialize tribe scores
            function initializeTribeScores() {
                tribeScores = {
                    'black-furies': 0,
                    'bone-gnawers': 0,
                    'children-of-gaia': 0,
                    'fianna': 0,
                    'ghost-council': 0,
                    'glass-walkers': 0,
                    'red-talons': 0,
                    'shadow-lords': 0,
                    'silent-striders': 0,
                    'silver-fangs': 0,
                    'stargazers': 0
                };
                currentTribeQuestion = 0;
                tribeAnswers = [];
            }

            // Render current tribe question
            function renderTribeQuestion() {
                const container = document.getElementById('tribe-question-container');
                const progress = document.getElementById('tribe-progress');
                const question = tribeQuestions[currentTribeQuestion];
                
                progress.textContent = `Question ${currentTribeQuestion + 1} of ${tribeQuestions.length}`;
                
                // Update the prompt
                document.getElementById('tribe-quest-question').textContent = `"${question.prompt}"`;
                
                // Shuffle answers for this question
                const shuffledAnswers = [...question.answers].sort(() => Math.random() - 0.5);
                
                container.innerHTML = '';
                shuffledAnswers.forEach((answer, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'choice-btn tribe-answer-btn';
                    btn.dataset.tribe = answer.tribe;
                    btn.textContent = answer.text;
                    
                    // If this question was already answered, mark the selected answer
                    if (tribeAnswers[currentTribeQuestion] === answer.tribe) {
                        btn.classList.add('selected');
                    }
                    
                    btn.addEventListener('click', function() {
                        // Remove selected from all
                        container.querySelectorAll('.tribe-answer-btn').forEach(b => b.classList.remove('selected'));
                        // Add selected to clicked
                        btn.classList.add('selected');
                        // Store answer
                        tribeAnswers[currentTribeQuestion] = answer.tribe;
                        // Enable next button
                        document.getElementById('next-tribe-question').disabled = false;
                    });
                    
                    container.appendChild(btn);
                });
                
                // Update navigation buttons
                document.getElementById('prev-tribe-question').style.display = currentTribeQuestion > 0 ? 'inline-block' : 'none';
                document.getElementById('next-tribe-question').textContent = currentTribeQuestion === tribeQuestions.length - 1 ? 'See Results' : 'Next';
                document.getElementById('next-tribe-question').disabled = !tribeAnswers[currentTribeQuestion];
                document.getElementById('back-to-gender').style.display = currentTribeQuestion === 0 ? 'inline-block' : 'none';
            }

            // Calculate tribe results
            function calculateTribeResults() {
                // Reset scores
                Object.keys(tribeScores).forEach(tribe => tribeScores[tribe] = 0);
                
                // Tally answers
                tribeAnswers.forEach(tribe => {
                    if (tribe) {
                        tribeScores[tribe]++;
                    }
                });
                
                // Find highest score
                let maxScore = 0;
                let topTribes = [];
                
                Object.entries(tribeScores).forEach(([tribe, score]) => {
                    if (score > maxScore) {
                        maxScore = score;
                        topTribes = [tribe];
                    } else if (score === maxScore && score > 0) {
                        // Only add ties if score is greater than 0
                        topTribes.push(tribe);
                    }
                });
                
                // If no answers were given, default to allowing user to pick any tribe
                if (maxScore === 0) {
                    topTribes = Object.keys(tribeScores);
                }
                
                return { maxScore, topTribes };
            }

            // Display tribe result
            function displayTribeResult() {
                const { maxScore, topTribes } = calculateTribeResults();
                const container = document.getElementById('tribe-result-container');
                const tribeInput = document.getElementById('tribe');
                
                if (topTribes.length === 1) {
                    // Clear winner
                    const tribe = topTribes[0];
                    const info = tribeDescriptions[tribe];
                    tribeInput.value = tribe;
                    
                    container.innerHTML = `
                        <div class="tribe-result-single">
                            <h3 class="tribe-name">${info.name}</h3>
                            <p class="tribe-score">Your spirit resonated ${maxScore} times with this tribe's values.</p>
                            <p class="tribe-description">${info.description}</p>
                            <p class="tribe-values"><strong>Core Values:</strong> ${info.values}</p>
                        </div>
                    `;
                } else {
                    // Tie - let user choose
                    tribeInput.value = '';
                    
                    let tribeOptionsHtml = topTribes.map(tribe => {
                        const info = tribeDescriptions[tribe];
                        return `
                            <button type="button" class="choice-btn tribe-tie-choice" data-tribe="${tribe}">
                                <span class="choice-title">${info.name}</span>
                                <span class="choice-desc">${info.description}</span>
                                <span class="tribe-values-small"><em>Values: ${info.values}</em></span>
                            </button>
                        `;
                    }).join('');
                    
                    container.innerHTML = `
                        <div class="tribe-result-tie">
                            <h3>The Spirits Are Divided</h3>
                            <p class="tribe-tie-intro">Your spirit resonated equally (${maxScore} times) with multiple tribes. The choice is yours‚Äîwhich path calls to you most strongly?</p>
                            <div class="tribe-tie-options">
                                ${tribeOptionsHtml}
                            </div>
                        </div>
                    `;
                    
                    // Add click handlers for tie choices
                    container.querySelectorAll('.tribe-tie-choice').forEach(btn => {
                        btn.addEventListener('click', function() {
                            container.querySelectorAll('.tribe-tie-choice').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            tribeInput.value = btn.dataset.tribe;
                        });
                    });
                }
            }

            // Initialize tribe questionnaire
            function initializeTribeQuestionnaire() {
                initializeTribeScores();
                renderTribeQuestion();
            }

            // Add tribe result step to steps object
            steps.tribeResult = document.getElementById('step-tribe-result');

            // Navigation for tribe questionnaire
            document.getElementById('next-tribe-question').addEventListener('click', function() {
                if (currentTribeQuestion < tribeQuestions.length - 1) {
                    currentTribeQuestion++;
                    renderTribeQuestion();
                } else {
                    // Show results
                    displayTribeResult();
                    showStep(steps.tribe, steps.tribeResult);
                }
            });

            document.getElementById('prev-tribe-question').addEventListener('click', function() {
                if (currentTribeQuestion > 0) {
                    currentTribeQuestion--;
                    renderTribeQuestion();
                }
            });

            document.getElementById('back-to-tribe-questions').addEventListener('click', function() {
                initializeTribeScores();
                showStep(steps.tribeResult, steps.tribe);
            });

            // Step 3 -> Step 4 (Tribe Result to Auspice)
            nextToAuspiceBtn.addEventListener('click', function() {
                const tribe = document.getElementById('tribe').value;
                if (tribe) {
                    showStep(steps.tribeResult, steps.auspice);
                } else {
                    // If in tie scenario and no selection made
                    alert('Please select a tribe to continue.');
                }
            });

            // Back buttons
            document.getElementById('back-to-name').addEventListener('click', function() {
                showStep(steps.gender, steps.name);
            });

            document.getElementById('back-to-gender').addEventListener('click', function() {
                showStep(steps.tribe, steps.gender);
            });

            document.getElementById('back-to-tribe').addEventListener('click', function() {
                showStep(steps.auspice, steps.tribeResult);
            });

            // Auspice Selection Logic
            const birthdateInput = document.getElementById('birthdate');
            const auspiceInput = document.getElementById('auspice');
            const auspiceResult = document.getElementById('auspice-result');
            const birthdateGroup = document.getElementById('birthdate-group');
            const manualAuspiceGroup = document.getElementById('manual-auspice-group');
            const toggleManualBtn = document.getElementById('toggle-manual-auspice');
            const backToBirthdateBtn = document.getElementById('back-to-birthdate');
            const auspiceChoices = document.querySelectorAll('.auspice-choice');
            const submitBtn = document.getElementById('submit-character');

            // Moon phase calculation based on date
            function getMoonPhase(date) {
                // Calculate days since known new moon (Jan 6, 2000)
                const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0);
                const lunarCycle = 29.53058867; // days
                const daysSinceNewMoon = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
                const currentCycle = daysSinceNewMoon / lunarCycle;
                const phase = (currentCycle - Math.floor(currentCycle)) * lunarCycle;
                return phase;
            }

            // Determine auspice from moon phase
            function getAuspiceFromPhase(phase) {
                // Moon phases and corresponding auspices (29.53 day cycle)
                // New Moon: 0-1.85 days AND 27.69-29.53 days (Ragabash)
                // Crescent: 1.85-7.38 days AND 25.84-27.69 days (Theurge)
                // Half Moon: 7.38-11.07 days AND 22.15-25.84 days (Philodox)
                // Gibbous: 11.07-14.77 days AND 18.46-22.15 days (Galliard)
                // Full Moon: 14.77-18.46 days (Ahroun)
                
                // New Moon (Ragabash)
                if (phase < 1.85 || phase >= 27.69) {
                    return { auspice: 'ragabash', name: 'Ragabash', moon: 'New Moon', icon: 'üåë' };
                }
                // Waxing Crescent (Theurge)
                if (phase >= 1.85 && phase < 7.38) {
                    return { auspice: 'theurge', name: 'Theurge', moon: 'Crescent Moon', icon: 'üåí' };
                }
                // Waning Crescent (Theurge)
                if (phase >= 25.84 && phase < 27.69) {
                    return { auspice: 'theurge', name: 'Theurge', moon: 'Crescent Moon', icon: 'üåò' };
                }
                // First Quarter (Philodox)
                if (phase >= 7.38 && phase < 11.07) {
                    return { auspice: 'philodox', name: 'Philodox', moon: 'Half Moon', icon: 'üåì' };
                }
                // Last Quarter (Philodox)
                if (phase >= 22.15 && phase < 25.84) {
                    return { auspice: 'philodox', name: 'Philodox', moon: 'Half Moon', icon: 'üåó' };
                }
                // Waxing Gibbous (Galliard)
                if (phase >= 11.07 && phase < 14.77) {
                    return { auspice: 'galliard', name: 'Galliard', moon: 'Gibbous Moon', icon: 'üåî' };
                }
                // Waning Gibbous (Galliard)
                if (phase >= 18.46 && phase < 22.15) {
                    return { auspice: 'galliard', name: 'Galliard', moon: 'Gibbous Moon', icon: 'üåñ' };
                }
                // Full Moon (Ahroun) - default for 14.77-18.46
                return { auspice: 'ahroun', name: 'Ahroun', moon: 'Full Moon', icon: 'üåï' };
            }

            // Handle birth date input
            birthdateInput.addEventListener('change', function() {
                if (this.value) {
                    const birthDate = new Date(this.value);
                    const phase = getMoonPhase(birthDate);
                    const auspiceData = getAuspiceFromPhase(phase);
                    
                    auspiceInput.value = auspiceData.auspice;
                    auspiceResult.innerHTML = `${auspiceData.icon} Luna reveals your path: <strong>${auspiceData.name}</strong> (${auspiceData.moon})`;
                    auspiceResult.classList.add('show');
                    submitBtn.disabled = false;
                } else {
                    auspiceInput.value = '';
                    auspiceResult.innerHTML = '';
                    auspiceResult.classList.remove('show');
                    submitBtn.disabled = true;
                }
            });

            // Toggle to manual selection
            toggleManualBtn.addEventListener('click', function() {
                birthdateGroup.classList.add('hidden');
                manualAuspiceGroup.classList.remove('hidden');
                // Always clear the auspice when switching to manual mode
                // User must make a new selection
                auspiceInput.value = '';
                submitBtn.disabled = true;
                // Clear any previous manual selections
                auspiceChoices.forEach(function(btn) {
                    btn.classList.remove('selected');
                });
            });

            // Back to birthdate selection
            backToBirthdateBtn.addEventListener('click', function() {
                manualAuspiceGroup.classList.add('hidden');
                birthdateGroup.classList.remove('hidden');
                // Clear manual selections
                auspiceChoices.forEach(function(btn) {
                    btn.classList.remove('selected');
                });
                // Re-check if birthdate has a value
                if (birthdateInput.value) {
                    const birthDate = new Date(birthdateInput.value);
                    const phase = getMoonPhase(birthDate);
                    const auspiceData = getAuspiceFromPhase(phase);
                    auspiceInput.value = auspiceData.auspice;
                    submitBtn.disabled = false;
                } else {
                    auspiceInput.value = '';
                    submitBtn.disabled = true;
                }
            });

            // Manual auspice selection
            auspiceChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    auspiceChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    btn.classList.add('selected');
                    // Update hidden input
                    auspiceInput.value = btn.dataset.auspice;
                    // Enable next button (changed from submit)
                    document.getElementById('next-to-attributes').disabled = false;
                });
            });

            // Character data storage with attributes
            const characterData = {
                name: '',
                gender: '',
                tribe: '',
                auspice: '',
                birthdate: '',
                attributes: {
                    strength: 1,
                    dexterity: 1,
                    stamina: 1,
                    charisma: 1,
                    manipulation: 1,
                    composure: 1,
                    intelligence: 1,
                    wits: 1,
                    resolve: 1
                }
            };

            // Attribute definitions
            const attributeCategories = {
                physical: {
                    name: 'Physical',
                    prompt: 'Your body tells a story of survival. Every scar, every callus speaks of trials overcome.',
                    attributes: {
                        strength: {
                            name: 'Strength',
                            title: 'The power that breaks barriers',
                            desc: 'You have always been the one to shoulder burdens others could not bear. Doors that would not open, stones that would not move, enemies that would not yield‚Äîall have fallen before the raw power that lives in your muscles. When force is needed, you have never been found wanting.'
                        },
                        dexterity: {
                            name: 'Dexterity',
                            title: 'The grace that dances with death',
                            desc: 'Quick as thought, graceful as running water. Your hands move before your mind can catch up, catching the falling cup, threading the impossible needle, striking before your enemy can blink. Precision and speed have always been your birthright.'
                        },
                        stamina: {
                            name: 'Stamina',
                            title: 'The spirit that refuses to fall',
                            desc: 'You endure. When others collapse from exhaustion, you remain standing. When fever burns through your body, you fight on. Pain is an old companion, and weariness a challenge you have never lost to. Your body simply refuses to surrender.'
                        }
                    }
                },
                social: {
                    name: 'Social',
                    prompt: 'You have walked among others all your life, learning the subtle dance of connection and influence.',
                    attributes: {
                        charisma: {
                            name: 'Charisma',
                            title: 'The fire that draws others near',
                            desc: 'There is a fire in you that draws others like moths to flame. When you speak, heads turn. When you believe, others find themselves believing too. You have led without meaning to, inspired without trying. People want to follow you‚Äîthey always have.'
                        },
                        manipulation: {
                            name: 'Manipulation',
                            title: 'The hand that guides unseen',
                            desc: 'You see the strings that move people‚Äîtheir fears, their desires, their secret shames. A word here, a suggestion there, and events unfold as you intend. Some call it cunning. Some call it cruelty. You know it simply as understanding how the world truly works.'
                        },
                        composure: {
                            name: 'Composure',
                            title: 'The stillness within the storm',
                            desc: 'The storm rages around you, but within, you are still water. Others panic; you assess. Others break; you bend. Your face reveals nothing you do not wish it to reveal. In a world of chaos, your calm is both shield and weapon.'
                        }
                    }
                },
                mental: {
                    name: 'Mental',
                    prompt: 'Your mind has always been your sanctuary and your weapon, processing the world in ways others cannot fathom.',
                    attributes: {
                        intelligence: {
                            name: 'Intelligence',
                            title: 'The library that holds all secrets',
                            desc: 'Knowledge has always come easily to you‚Äîpatterns revealing themselves, connections forming where others see only chaos. Books open their secrets willingly, and mysteries unravel at your touch. Your mind is a vast library, and you know exactly where everything is shelved.'
                        },
                        wits: {
                            name: 'Wits',
                            title: 'The blade that strikes first',
                            desc: 'While others are still processing what happened, you have already reacted. Your instincts are razor-sharp, your snap judgments almost always correct. In the space between heartbeats, you see the danger, find the solution, and act. Hesitation is a stranger to you.'
                        },
                        resolve: {
                            name: 'Resolve',
                            title: 'The will that cannot be broken',
                            desc: 'Your will is iron wrapped in silk. When you set your mind to something, mountains might as well step aside. Fear whispers, but you do not listen. Doubt knocks, but you do not answer. Once committed, you are as unstoppable as the tide.'
                        }
                    }
                }
            };

            // ===== ATTRIBUTE DISTRIBUTION SYSTEM =====
            // This system GUARANTEES the following distribution for ALL user choices:
            // - 1 attribute at 4/5 points (primary selection)
            // - 3 attributes at 3/5 points (secondary selections)
            // - 4 attributes at 2/5 points (tertiary selections)
            // - 1 attribute at 1/5 points (remaining attribute)
            //
            // The guarantee is enforced through:
            // 1. Mandatory selection of exactly 1 primary attribute
            // 2. Mandatory selection of exactly 3 secondary attributes
            // 3. Mandatory selection of exactly 4 tertiary attributes
            // 4. Automatic assignment of the 1 remaining attribute
            //
            // Mathematical proof: 1 + 3 + 4 + 1 = 9 total attributes
            // Tested comprehensively: 900 scenarios verified in test-attribute-distribution.html
            
            // Track attribute selections
            let selectedPrimaryCategory = null;
            let selectedPrimaryAttribute = null;
            let selectedSecondaryCategory = null;
            let selectedSecondaryAttributes = [];
            let selectedTertiaryAttributes = [];
            // Note: weakest attribute is automatically determined as the unassigned attribute (stays at 1)

            // Add new steps to the steps object
            steps.attrCategory = document.getElementById('step-attr-category');
            steps.primaryAttr = document.getElementById('step-primary-attr');
            steps.secondaryCategory = document.getElementById('step-secondary-category');
            steps.secondaryAttrs = document.getElementById('step-secondary-attrs');
            steps.tertiaryAttrs = document.getElementById('step-tertiary-attrs');
            steps.summary = document.getElementById('step-summary');

            // Update birthdate change handler to use new button
            birthdateInput.removeEventListener('change', function(){});
            birthdateInput.addEventListener('change', function() {
                if (this.value) {
                    const birthDate = new Date(this.value);
                    const phase = getMoonPhase(birthDate);
                    const auspiceData = getAuspiceFromPhase(phase);
                    
                    auspiceInput.value = auspiceData.auspice;
                    auspiceResult.innerHTML = `${auspiceData.icon} Luna reveals your path: <strong>${auspiceData.name}</strong> (${auspiceData.moon})`;
                    auspiceResult.classList.add('show');
                    document.getElementById('next-to-attributes').disabled = false;
                } else {
                    auspiceInput.value = '';
                    auspiceResult.innerHTML = '';
                    auspiceResult.classList.remove('show');
                    document.getElementById('next-to-attributes').disabled = true;
                }
            });

            // Step 4 -> Step 5 (Auspice to Attribute Category)
            document.getElementById('next-to-attributes').addEventListener('click', function() {
                if (auspiceInput.value) {
                    showStep(steps.auspice, steps.attrCategory);
                }
            });

            // Back to Auspice
            document.getElementById('back-to-auspice').addEventListener('click', function() {
                showStep(steps.attrCategory, steps.auspice);
            });

            // Primary Category Selection
            const categoryChoices = document.querySelectorAll('.attribute-category-choice');
            categoryChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    categoryChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    btn.classList.add('selected');
                    selectedPrimaryCategory = btn.dataset.category;
                    document.getElementById('primary-category').value = selectedPrimaryCategory;
                    document.getElementById('next-to-primary-attr').disabled = false;
                });
            });

            // Step 5 -> Step 6 (Category to Primary Attribute)
            document.getElementById('next-to-primary-attr').addEventListener('click', function() {
                if (selectedPrimaryCategory) {
                    populatePrimaryAttributes();
                    showStep(steps.attrCategory, steps.primaryAttr);
                }
            });

            // Populate primary attribute choices
            function populatePrimaryAttributes() {
                const container = document.getElementById('primary-attr-choices');
                const category = attributeCategories[selectedPrimaryCategory];
                
                document.getElementById('primary-attr-prompt').textContent = category.prompt;
                document.getElementById('primary-attr-question').textContent = 'When you strip away everything else, what truth remains at your center?';
                
                container.innerHTML = '';
                Object.entries(category.attributes).forEach(function([key, attr]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'choice-btn attribute-choice';
                    btn.dataset.attribute = key;
                    btn.innerHTML = `
                        <span class="choice-title">${attr.title}</span>
                        <span class="choice-desc">${attr.desc}</span>
                    `;
                    btn.addEventListener('click', function() {
                        container.querySelectorAll('.attribute-choice').forEach(function(b) {
                            b.classList.remove('selected');
                        });
                        btn.classList.add('selected');
                        selectedPrimaryAttribute = key;
                        document.getElementById('primary-attribute').value = key;
                        document.getElementById('next-to-secondary-category').disabled = false;
                    });
                    container.appendChild(btn);
                });
            }

            // Back to Category
            document.getElementById('back-to-category').addEventListener('click', function() {
                showStep(steps.primaryAttr, steps.attrCategory);
            });

            // Step 6 -> Step 7 (Primary Attr to Secondary Category)
            document.getElementById('next-to-secondary-category').addEventListener('click', function() {
                if (selectedPrimaryAttribute) {
                    populateSecondaryCategories();
                    showStep(steps.primaryAttr, steps.secondaryCategory);
                }
            });

            // Populate secondary category choices
            function populateSecondaryCategories() {
                const container = document.getElementById('secondary-category-choices');
                container.innerHTML = '';
                
                Object.entries(attributeCategories).forEach(function([key, cat]) {
                    if (key !== selectedPrimaryCategory) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'choice-btn attribute-category-choice';
                        btn.dataset.category = key;
                        
                        let title, desc;
                        if (key === 'physical') {
                            title = 'The Body';
                            desc = 'Physical prowess and endurance';
                        } else if (key === 'social') {
                            title = 'The Pack';
                            desc = 'Social influence and connection';
                        } else {
                            title = 'The Mind';
                            desc = 'Mental acuity and awareness';
                        }
                        
                        btn.innerHTML = `
                            <span class="choice-title">${title}</span>
                            <span class="choice-desc">${desc}</span>
                        `;
                        btn.addEventListener('click', function() {
                            container.querySelectorAll('.attribute-category-choice').forEach(function(b) {
                                b.classList.remove('selected');
                            });
                            btn.classList.add('selected');
                            selectedSecondaryCategory = key;
                            document.getElementById('secondary-category').value = key;
                            document.getElementById('next-to-secondary-attrs').disabled = false;
                        });
                        container.appendChild(btn);
                    }
                });
            }

            // Back to Primary Attr
            document.getElementById('back-to-primary-attr').addEventListener('click', function() {
                showStep(steps.secondaryCategory, steps.primaryAttr);
            });

            // Step 7 -> Step 8 (Secondary Category to Secondary Attrs)
            document.getElementById('next-to-secondary-attrs').addEventListener('click', function() {
                if (selectedSecondaryCategory) {
                    populateSecondaryAttributes();
                    showStep(steps.secondaryCategory, steps.secondaryAttrs);
                }
            });

            // Populate secondary attribute choices (multi-select 3)
            function populateSecondaryAttributes() {
                const container = document.getElementById('secondary-attr-choices');
                const primaryCat = attributeCategories[selectedPrimaryCategory];
                const secondaryCat = attributeCategories[selectedSecondaryCategory];
                
                container.innerHTML = '';
                selectedSecondaryAttributes = [];
                updateSecondaryCounter();
                
                // Add remaining attributes from primary category (excluding the primary one)
                Object.entries(primaryCat.attributes).forEach(function([key, attr]) {
                    if (key !== selectedPrimaryAttribute) {
                        addSecondaryAttrButton(container, key, attr);
                    }
                });
                
                // Add all attributes from secondary category
                Object.entries(secondaryCat.attributes).forEach(function([key, attr]) {
                    addSecondaryAttrButton(container, key, attr);
                });
            }

            function addSecondaryAttrButton(container, key, attr) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'choice-btn attribute-choice';
                btn.dataset.attribute = key;
                btn.innerHTML = `
                    <span class="choice-title">${attr.title}</span>
                    <span class="choice-desc">${attr.desc}</span>
                `;
                btn.addEventListener('click', function() {
                    if (btn.classList.contains('selected')) {
                        btn.classList.remove('selected');
                        selectedSecondaryAttributes = selectedSecondaryAttributes.filter(a => a !== key);
                    } else if (selectedSecondaryAttributes.length < 3) {
                        btn.classList.add('selected');
                        selectedSecondaryAttributes.push(key);
                    }
                    updateSecondaryCounter();
                    document.getElementById('next-to-tertiary-attrs').disabled = selectedSecondaryAttributes.length !== 3;
                });
                container.appendChild(btn);
            }

            function updateSecondaryCounter() {
                document.getElementById('secondary-counter').textContent = `Chosen: ${selectedSecondaryAttributes.length} of 3`;
            }

            // Back to Secondary Category
            document.getElementById('back-to-secondary-category').addEventListener('click', function() {
                showStep(steps.secondaryAttrs, steps.secondaryCategory);
            });

            // Step 8 -> Step 9 (Secondary Attrs to Tertiary Attrs)
            document.getElementById('next-to-tertiary-attrs').addEventListener('click', function() {
                if (selectedSecondaryAttributes.length === 3) {
                    populateTertiaryAttributes();
                    showStep(steps.secondaryAttrs, steps.tertiaryAttrs);
                }
            });

            // Get tertiary category (the one not selected)
            function getTertiaryCategory() {
                const categories = ['physical', 'social', 'mental'];
                return categories.find(c => c !== selectedPrimaryCategory && c !== selectedSecondaryCategory);
            }

            // Populate tertiary attribute choices (multi-select 4, leaving 1 at lowest)
            function populateTertiaryAttributes() {
                const container = document.getElementById('tertiary-attr-choices');
                const tertiaryCatKey = getTertiaryCategory();
                const tertiaryCat = attributeCategories[tertiaryCatKey];
                const primaryCat = attributeCategories[selectedPrimaryCategory];
                const secondaryCat = attributeCategories[selectedSecondaryCategory];
                
                container.innerHTML = '';
                selectedTertiaryAttributes = [];
                updateTertiaryCounter();
                
                // Collect all remaining attributes not yet assigned
                const remainingAttrs = [];
                
                // Add all attributes from tertiary category (none assigned yet)
                Object.entries(tertiaryCat.attributes).forEach(function([key, attr]) {
                    remainingAttrs.push({ key, attr });
                });
                
                // Add remaining from primary category (not the primary attribute and not selected as secondary)
                Object.entries(primaryCat.attributes).forEach(function([key, attr]) {
                    if (key !== selectedPrimaryAttribute && !selectedSecondaryAttributes.includes(key)) {
                        remainingAttrs.push({ key, attr });
                    }
                });
                
                // Add remaining from secondary category (not selected as secondary)
                Object.entries(secondaryCat.attributes).forEach(function([key, attr]) {
                    if (!selectedSecondaryAttributes.includes(key)) {
                        remainingAttrs.push({ key, attr });
                    }
                });
                
                // Add buttons for all remaining attributes
                remainingAttrs.forEach(function(item) {
                    addTertiaryAttrButton(container, item.key, item.attr);
                });
            }

            function addTertiaryAttrButton(container, key, attr) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'choice-btn attribute-choice';
                btn.dataset.attribute = key;
                btn.innerHTML = `
                    <span class="choice-title">${attr.title}</span>
                    <span class="choice-desc">${attr.desc}</span>
                `;
                btn.addEventListener('click', function() {
                    if (btn.classList.contains('selected')) {
                        btn.classList.remove('selected');
                        selectedTertiaryAttributes = selectedTertiaryAttributes.filter(a => a !== key);
                    } else if (selectedTertiaryAttributes.length < 4) {
                        btn.classList.add('selected');
                        selectedTertiaryAttributes.push(key);
                    }
                    updateTertiaryCounter();
                    
                    // Note: The weakest attribute is automatically determined as the one
                    // not selected - it will remain at the base value of 1
                    
                    document.getElementById('next-to-skill-type').disabled = selectedTertiaryAttributes.length !== 4;
                });
                container.appendChild(btn);
            }
            
            // Helper function to get all remaining attributes
            function getAllRemainingAttributes() {
                const remaining = [];
                const tertiaryCatKey = getTertiaryCategory();
                const tertiaryCat = attributeCategories[tertiaryCatKey];
                const primaryCat = attributeCategories[selectedPrimaryCategory];
                const secondaryCat = attributeCategories[selectedSecondaryCategory];
                
                // Tertiary category attrs
                Object.keys(tertiaryCat.attributes).forEach(function(key) {
                    remaining.push(key);
                });
                
                // Remaining from primary
                Object.keys(primaryCat.attributes).forEach(function(key) {
                    if (key !== selectedPrimaryAttribute && !selectedSecondaryAttributes.includes(key)) {
                        remaining.push(key);
                    }
                });
                
                // Remaining from secondary
                Object.keys(secondaryCat.attributes).forEach(function(key) {
                    if (!selectedSecondaryAttributes.includes(key)) {
                        remaining.push(key);
                    }
                });
                
                return remaining;
            }

            function updateTertiaryCounter() {
                document.getElementById('tertiary-counter').textContent = `Chosen: ${selectedTertiaryAttributes.length} of 4`;
            }

            // Back to Secondary Attrs
            document.getElementById('back-to-secondary-attrs').addEventListener('click', function() {
                showStep(steps.tertiaryAttrs, steps.secondaryAttrs);
            });

            // ===== SKILLS QUESTIONNAIRE SYSTEM =====
            
            // Skills list with base points for certain skills
            const allSkills = {
                // Skills that start with 1 point (free)
                academics: { name: 'Academics', base: 1, category: 'mental' },
                craft: { name: 'Craft', base: 1, category: 'mental' },
                performance: { name: 'Performance', base: 1, category: 'social' },
                science: { name: 'Science', base: 1, category: 'mental' },
                // All other skills
                athletics: { name: 'Athletics', base: 0, category: 'physical' },
                awareness: { name: 'Awareness', base: 0, category: 'mental' },
                brawl: { name: 'Brawl', base: 0, category: 'physical' },
                empathy: { name: 'Empathy', base: 0, category: 'social' },
                etiquette: { name: 'Etiquette', base: 0, category: 'social' },
                firearms: { name: 'Firearms', base: 0, category: 'physical' },
                insight: { name: 'Insight', base: 0, category: 'mental' },
                intimidation: { name: 'Intimidation', base: 0, category: 'social' },
                investigation: { name: 'Investigation', base: 0, category: 'mental' },
                leadership: { name: 'Leadership', base: 0, category: 'social' },
                larceny: { name: 'Larceny', base: 0, category: 'physical' },
                medicine: { name: 'Medicine', base: 0, category: 'mental' },
                melee: { name: 'Melee', base: 0, category: 'physical' },
                occult: { name: 'Occult', base: 0, category: 'mental' },
                persuasion: { name: 'Persuasion', base: 0, category: 'social' },
                stealth: { name: 'Stealth', base: 0, category: 'physical' },
                streetwise: { name: 'Streetwise', base: 0, category: 'social' },
                subterfuge: { name: 'Subterfuge', base: 0, category: 'social' },
                survival: { name: 'Survival', base: 0, category: 'physical' },
                technology: { name: 'Technology', base: 0, category: 'mental' }
            };

            // Skill distribution types
            const skillDistributions = {
                jack: {
                    name: 'Jack of All Trades',
                    totalPoints: 29,
                    distribution: { 3: 1, 2: 8, 1: 10 }
                },
                balanced: {
                    name: 'Balanced',
                    totalPoints: 26,
                    distribution: { 3: 3, 2: 5, 1: 7 }
                },
                specialist: {
                    name: 'Specialist',
                    totalPoints: 22,
                    distribution: { 4: 1, 3: 3, 2: 3, 1: 3 }
                }
            };

            // Skill questionnaire scenarios with branching
            const skillScenarios = [
                {
                    id: 1,
                    prompt: "You are standing in line at a store when a desperate-looking man approaches and demands your wallet. How do you respond?",
                    backstoryIntro: "Once, in a convenience store, a desperate man confronted you...",
                    initialChoices: [
                        { 
                            text: "Try to talk him down‚Äîit's not worth getting hurt over a wallet.",
                            skills: ['persuasion', 'leadership', 'intimidation', 'streetwise'],
                            backstory: "You tried to calm him with words",
                            followUp: {
                                prompt: "You can see this was never about the money. His fists are balled, and there's a wild look in his eyes. The fight is inevitable. How do you proceed?",
                                choices: [
                                    { text: "Headbutt him and get him in a sleeper hold.", skill: 'brawl', backstory: "and when words failed, you put him down with your fists." },
                                    { text: "Grab a bottle off the rack and defend yourself.", skill: 'melee', backstory: "and when words failed, you armed yourself and fought back." },
                                    { text: "Make yourself look bigger, growl, and tell him to back off.", skill: 'intimidation', backstory: "and your fierce presence made him think twice." },
                                    { text: "Throw your groceries at him and vault over the counter.", skill: 'athletics', backstory: "and when he lunged, you were already gone." }
                                ]
                            }
                        },
                        { 
                            text: "Get ready to beat his ass‚Äînobody threatens you.",
                            skills: ['brawl', 'melee', 'intimidation', 'athletics'],
                            backstory: "You stood your ground, ready to fight",
                            followUp: {
                                prompt: "He swings first. How do you end this?",
                                choices: [
                                    { text: "Catch his arm and take him to the ground.", skill: 'brawl', backstory: "and your grappling skills ended it quickly." },
                                    { text: "Dodge and grab something to hit him with.", skill: 'melee', backstory: "and an improvised weapon gave you the edge." },
                                    { text: "Step into his swing and intimidate him into backing down.", skill: 'intimidation', backstory: "and your fearless advance broke his nerve." },
                                    { text: "Sidestep and use his momentum against him.", skill: 'athletics', backstory: "and your agility turned his aggression against him." }
                                ]
                            }
                        },
                        { 
                            text: "You clocked him the moment he walked in‚Äîhe never got the drop on you.",
                            skills: ['stealth', 'survival', 'insight', 'awareness'],
                            backstory: "You had spotted him the moment he entered",
                            followUp: {
                                prompt: "He realizes you're not an easy mark. What's your next move?",
                                choices: [
                                    { text: "Slip away through the back while his attention is elsewhere.", skill: 'stealth', backstory: "and you vanished before he could react." },
                                    { text: "Position yourself near the exit with an escape route planned.", skill: 'survival', backstory: "and your survival instincts kept you safe." },
                                    { text: "Read his body language to predict his next move.", skill: 'insight', backstory: "and you read him like an open book." },
                                    { text: "Keep your eyes on his hands and stay ready for anything.", skill: 'awareness', backstory: "and your vigilance kept you one step ahead." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 2,
                    prompt: "Your best friend has been acting strangely‚Äîwithdrawn, secretive, possibly involved in something dangerous. How do you find out what's going on?",
                    backstoryIntro: "When your closest friend started to change...",
                    initialChoices: [
                        { 
                            text: "Sit them down and have an honest heart-to-heart conversation.",
                            skills: ['empathy', 'persuasion', 'insight', 'leadership'],
                            backstory: "you confronted them directly",
                            followUp: {
                                prompt: "They're defensive, clearly hiding something. How do you get through to them?",
                                choices: [
                                    { text: "Show them you understand their pain and create a safe space.", skill: 'empathy', backstory: "and your compassion broke through their walls." },
                                    { text: "Convince them that whatever it is, you'll face it together.", skill: 'persuasion', backstory: "and your words reminded them they weren't alone." },
                                    { text: "Read between the lines of what they're saying.", skill: 'insight', backstory: "and you saw the truth they couldn't speak." },
                                    { text: "Take charge and tell them you're not leaving until they talk.", skill: 'leadership', backstory: "and your determination wouldn't let them hide." }
                                ]
                            }
                        },
                        { 
                            text: "Follow them discreetly to see where they've been going.",
                            skills: ['stealth', 'investigation', 'streetwise', 'awareness'],
                            backstory: "you decided to find out for yourself",
                            followUp: {
                                prompt: "You trail them to an abandoned building. What's your approach?",
                                choices: [
                                    { text: "Move silently and observe from the shadows.", skill: 'stealth', backstory: "and you watched unseen from the darkness." },
                                    { text: "Look for clues about what they're involved in.", skill: 'investigation', backstory: "and the evidence told its own story." },
                                    { text: "Ask around the neighborhood about this place.", skill: 'streetwise', backstory: "and the locals filled in the gaps." },
                                    { text: "Stay alert for any sign of danger.", skill: 'awareness', backstory: "and your sharp senses kept you informed." }
                                ]
                            }
                        },
                        { 
                            text: "Research their recent activities online and through mutual friends.",
                            skills: ['technology', 'investigation', 'subterfuge', 'academics'],
                            backstory: "you started digging into their digital footprint",
                            followUp: {
                                prompt: "You find some concerning information. How do you dig deeper?",
                                choices: [
                                    { text: "Hack into their social media and email.", skill: 'technology', backstory: "and their digital life revealed the truth." },
                                    { text: "Cross-reference the clues to build a complete picture.", skill: 'investigation', backstory: "and you pieced together the puzzle." },
                                    { text: "Create a fake account to get closer to their new contacts.", skill: 'subterfuge', backstory: "and your deception uncovered their secrets." },
                                    { text: "Research the organizations and people they're involved with.", skill: 'academics', backstory: "and your research exposed the whole operation." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 3,
                    prompt: "You're at a formal event when you notice something valuable has gone missing from a display case. The host is frantic. What do you do?",
                    backstoryIntro: "At a high-society gathering, something precious vanished...",
                    initialChoices: [
                        { 
                            text: "Take charge and organize a systematic search of the premises.",
                            skills: ['leadership', 'investigation', 'etiquette', 'awareness'],
                            backstory: "you stepped up to handle the crisis",
                            followUp: {
                                prompt: "The search is underway. How do you contribute?",
                                choices: [
                                    { text: "Direct the staff and guests efficiently.", skill: 'leadership', backstory: "and your command brought order to chaos." },
                                    { text: "Examine the crime scene for clues.", skill: 'investigation', backstory: "and the evidence pointed you to the culprit." },
                                    { text: "Navigate the social dynamics to question guests tactfully.", skill: 'etiquette', backstory: "and you questioned suspects without causing offense." },
                                    { text: "Scan the room for anyone acting suspiciously.", skill: 'awareness', backstory: "and you spotted the guilty party." }
                                ]
                            }
                        },
                        { 
                            text: "Quietly observe the guests‚Äîthe thief is probably still here.",
                            skills: ['insight', 'awareness', 'subterfuge', 'stealth'],
                            backstory: "you watched the crowd with careful eyes",
                            followUp: {
                                prompt: "You notice someone acting nervous. What's your move?",
                                choices: [
                                    { text: "Study their behavior to confirm your suspicions.", skill: 'insight', backstory: "and their guilt was written all over them." },
                                    { text: "Watch where their eyes keep going.", skill: 'awareness', backstory: "and they couldn't stop glancing at their hiding spot." },
                                    { text: "Pretend to be sympathetic and get them talking.", skill: 'subterfuge', backstory: "and your false friendship made them slip up." },
                                    { text: "Position yourself to block their escape.", skill: 'stealth', backstory: "and you cornered them without them realizing." }
                                ]
                            }
                        },
                        { 
                            text: "Check if anyone has the skills to pull off this kind of heist.",
                            skills: ['streetwise', 'larceny', 'occult', 'technology'],
                            backstory: "you approached it like a professional would",
                            followUp: {
                                prompt: "You've profiled the likely culprit. How do you catch them?",
                                choices: [
                                    { text: "Reach out to your contacts in the criminal world.", skill: 'streetwise', backstory: "and your underworld connections paid off." },
                                    { text: "Set up a trap using your knowledge of thievery.", skill: 'larceny', backstory: "and it takes a thief to catch a thief." },
                                    { text: "Consider if supernatural means were involved.", skill: 'occult', backstory: "and you found traces of something unnatural." },
                                    { text: "Check the security cameras and electronic systems.", skill: 'technology', backstory: "and the digital evidence sealed their fate." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 4,
                    prompt: "You're lost in the wilderness as night approaches and a storm is rolling in. How do you survive?",
                    backstoryIntro: "Lost in the wild with a storm approaching...",
                    initialChoices: [
                        { 
                            text: "Find or build shelter and wait out the storm.",
                            skills: ['survival', 'craft', 'awareness', 'athletics'],
                            backstory: "you focused on finding shelter",
                            followUp: {
                                prompt: "The storm is intensifying. What's your priority?",
                                choices: [
                                    { text: "Use natural materials to reinforce your shelter.", skill: 'survival', backstory: "and your wilderness skills kept you alive." },
                                    { text: "Construct a proper structure from available materials.", skill: 'craft', backstory: "and your craftsmanship created a solid refuge." },
                                    { text: "Stay alert for any dangers the storm might bring.", skill: 'awareness', backstory: "and your vigilance spotted danger before it found you." },
                                    { text: "Gather enough resources to last the night.", skill: 'athletics', backstory: "and your endurance let you prepare before the worst hit." }
                                ]
                            }
                        },
                        { 
                            text: "Navigate by the stars before the clouds block them.",
                            skills: ['science', 'academics', 'survival', 'awareness'],
                            backstory: "you used the sky to find your way",
                            followUp: {
                                prompt: "You've got a heading. How do you make it to safety?",
                                choices: [
                                    { text: "Calculate the most efficient route using natural landmarks.", skill: 'science', backstory: "and your calculations led you true." },
                                    { text: "Remember what you learned about this region.", skill: 'academics', backstory: "and your knowledge proved invaluable." },
                                    { text: "Trust your instincts about the terrain.", skill: 'survival', backstory: "and instinct guided you home." },
                                    { text: "Stay alert for any signs of civilization.", skill: 'awareness', backstory: "and you spotted lights in the distance." }
                                ]
                            }
                        },
                        { 
                            text: "Look for signs of other people or civilization.",
                            skills: ['streetwise', 'investigation', 'empathy', 'persuasion'],
                            backstory: "you searched for signs of other people",
                            followUp: {
                                prompt: "You find a remote cabin with a light in the window. What do you do?",
                                choices: [
                                    { text: "Approach carefully‚Äîyou know how to read dangerous situations.", skill: 'streetwise', backstory: "and your street smarts told you it was safe." },
                                    { text: "Look for clues about who lives here before approaching.", skill: 'investigation', backstory: "and you confirmed it was safe before knocking." },
                                    { text: "Approach openly and appeal to their compassion.", skill: 'empathy', backstory: "and they took pity on a fellow traveler." },
                                    { text: "Knock and convince them to let you in.", skill: 'persuasion', backstory: "and your words earned you shelter from the storm." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 5,
                    prompt: "You discover that a local business is involved in something illegal. How do you handle it?",
                    backstoryIntro: "When you uncovered corruption in your neighborhood...",
                    initialChoices: [
                        { 
                            text: "Gather evidence and bring it to the authorities.",
                            skills: ['investigation', 'technology', 'academics', 'subterfuge'],
                            backstory: "you decided to build a case",
                            followUp: {
                                prompt: "You need more concrete proof. How do you get it?",
                                choices: [
                                    { text: "Dig through their records and find the smoking gun.", skill: 'investigation', backstory: "and you found the evidence that brought them down." },
                                    { text: "Access their digital systems to find proof.", skill: 'technology', backstory: "and their own files condemned them." },
                                    { text: "Research the legal implications and build an airtight case.", skill: 'academics', backstory: "and your meticulous preparation ensured justice." },
                                    { text: "Go undercover to get the evidence firsthand.", skill: 'subterfuge', backstory: "and you witnessed their crimes yourself." }
                                ]
                            }
                        },
                        { 
                            text: "Confront the people involved directly.",
                            skills: ['intimidation', 'leadership', 'brawl', 'persuasion'],
                            backstory: "you confronted them head-on",
                            followUp: {
                                prompt: "They're not backing down. How do you handle this?",
                                choices: [
                                    { text: "Make them understand the consequences of continuing.", skill: 'intimidation', backstory: "and your threats made them reconsider." },
                                    { text: "Rally others to stand with you against them.", skill: 'leadership', backstory: "and together, you forced them to stop." },
                                    { text: "Be ready to back up your words with action.", skill: 'brawl', backstory: "and they learned you weren't bluffing." },
                                    { text: "Negotiate a way for them to make things right.", skill: 'persuasion', backstory: "and you convinced them to change their ways." }
                                ]
                            }
                        },
                        { 
                            text: "Work within the community to expose them.",
                            skills: ['streetwise', 'performance', 'empathy', 'leadership'],
                            backstory: "you turned the community against them",
                            followUp: {
                                prompt: "The community is listening. How do you spread the word?",
                                choices: [
                                    { text: "Use your street connections to get the word out.", skill: 'streetwise', backstory: "and the word spread through the underground." },
                                    { text: "Organize a public demonstration to draw attention.", skill: 'performance', backstory: "and your protest made headlines." },
                                    { text: "Connect with those they've hurt and give them a voice.", skill: 'empathy', backstory: "and the victims found the courage to speak out." },
                                    { text: "Unite neighborhood leaders to take collective action.", skill: 'leadership', backstory: "and the community stood together against corruption." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 6,
                    prompt: "A friend asks you to help them learn something new‚Äîthey're counting on you. What do you teach them?",
                    backstoryIntro: "When asked to share your knowledge...",
                    initialChoices: [
                        { 
                            text: "How to defend themselves‚Äîthe world is dangerous.",
                            skills: ['brawl', 'melee', 'firearms', 'athletics'],
                            backstory: "you taught them to protect themselves",
                            followUp: {
                                prompt: "What's the most important thing for them to learn first?",
                                choices: [
                                    { text: "How to throw a proper punch and take a hit.", skill: 'brawl', backstory: "starting with the basics of hand-to-hand combat." },
                                    { text: "How to use everyday objects for self-defense.", skill: 'melee', backstory: "showing them how anything can be a weapon." },
                                    { text: "Proper gun safety and handling.", skill: 'firearms', backstory: "ensuring they could handle a firearm responsibly." },
                                    { text: "How to run, dodge, and escape dangerous situations.", skill: 'athletics', backstory: "teaching them that the best fight is one you don't have." }
                                ]
                            }
                        },
                        { 
                            text: "How to read people and navigate social situations.",
                            skills: ['insight', 'empathy', 'subterfuge', 'etiquette'],
                            backstory: "you taught them the art of understanding people",
                            followUp: {
                                prompt: "What skill will serve them best?",
                                choices: [
                                    { text: "How to tell when someone is lying.", skill: 'insight', backstory: "teaching them to see through deception." },
                                    { text: "How to connect with people on an emotional level.", skill: 'empathy', backstory: "showing them how to truly understand others." },
                                    { text: "How to blend in and play different roles.", skill: 'subterfuge', backstory: "teaching them the power of misdirection." },
                                    { text: "How to behave appropriately in any social setting.", skill: 'etiquette', backstory: "ensuring they could navigate any crowd." }
                                ]
                            }
                        },
                        { 
                            text: "Practical skills they can use in everyday life.",
                            skills: ['craft', 'medicine', 'technology', 'survival'],
                            backstory: "you focused on practical knowledge",
                            followUp: {
                                prompt: "What practical skill will help them most?",
                                choices: [
                                    { text: "How to fix and build things with their hands.", skill: 'craft', backstory: "teaching them to create and repair." },
                                    { text: "Basic first aid and medical knowledge.", skill: 'medicine', backstory: "ensuring they could save a life." },
                                    { text: "How to use and troubleshoot technology.", skill: 'technology', backstory: "making them comfortable with modern tools." },
                                    { text: "How to survive when civilization fails.", skill: 'survival', backstory: "preparing them for the worst." }
                                ]
                            }
                        }
                    ]
                },
                {
                    id: 7,
                    prompt: "You've been given a rare opportunity to learn from an expert. What field do you choose to study?",
                    backstoryIntro: "When given the chance to learn from a master...",
                    initialChoices: [
                        { 
                            text: "The mysteries of the world beyond the mundane.",
                            skills: ['occult', 'academics', 'investigation', 'insight'],
                            backstory: "you chose to explore the hidden world",
                            followUp: {
                                prompt: "What aspect of the unknown calls to you most?",
                                choices: [
                                    { text: "Ancient rituals and supernatural lore.", skill: 'occult', backstory: "delving into forbidden knowledge." },
                                    { text: "Historical texts and forgotten wisdom.", skill: 'academics', backstory: "studying the lessons of the past." },
                                    { text: "Unsolved mysteries and strange phenomena.", skill: 'investigation', backstory: "seeking answers to impossible questions." },
                                    { text: "The psychology behind belief and perception.", skill: 'insight', backstory: "understanding how people experience the impossible." }
                                ]
                            }
                        },
                        { 
                            text: "The healing arts and care for the wounded.",
                            skills: ['medicine', 'empathy', 'science', 'craft'],
                            backstory: "you chose to learn the healing arts",
                            followUp: {
                                prompt: "What aspect of healing speaks to you?",
                                choices: [
                                    { text: "Emergency medicine and trauma care.", skill: 'medicine', backstory: "learning to save lives in critical moments." },
                                    { text: "The emotional support that aids recovery.", skill: 'empathy', backstory: "understanding that healing is more than physical." },
                                    { text: "The science behind disease and treatment.", skill: 'science', backstory: "studying the mechanisms of the body." },
                                    { text: "Creating medicines and medical tools.", skill: 'craft', backstory: "learning to make the tools of healing." }
                                ]
                            }
                        },
                        { 
                            text: "The art of influence and social manipulation.",
                            skills: ['persuasion', 'intimidation', 'subterfuge', 'leadership'],
                            backstory: "you chose to master the art of influence",
                            followUp: {
                                prompt: "How do you prefer to exert influence?",
                                choices: [
                                    { text: "Through compelling arguments and charisma.", skill: 'persuasion', backstory: "learning to win hearts and minds." },
                                    { text: "Through fear and commanding presence.", skill: 'intimidation', backstory: "mastering the power of fear." },
                                    { text: "Through misdirection and manipulation.", skill: 'subterfuge', backstory: "learning to pull strings from the shadows." },
                                    { text: "Through inspiring and directing others.", skill: 'leadership', backstory: "becoming someone others would follow." }
                                ]
                            }
                        }
                    ]
                }
            ];

            // Skills state
            let selectedSkillType = null;
            let skillPoints = {};
            let totalSkillPointsRemaining = 0;
            let currentScenarioIndex = 0;
            let currentScenarioPhase = 'initial'; // 'initial' or 'followUp'
            let currentInitialChoice = null;
            let backstoryFragments = [];
            let generatedBackstory = '';
            let requiredDistribution = {}; // e.g., { 3: 1, 2: 8, 1: 10 }
            let currentDistribution = {}; // e.g., { 3: 0, 2: 0, 1: 4 }

            // Initialize skills with base values
            function initializeSkills() {
                skillPoints = {};
                Object.keys(allSkills).forEach(skill => {
                    skillPoints[skill] = allSkills[skill].base;
                });
            }
            
            // Get current skill distribution
            function getCurrentDistribution() {
                const dist = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                Object.values(skillPoints).forEach(val => {
                    dist[val]++;
                });
                return dist;
            }
            
            // Check if a skill can accept more points
            function canAddPointToSkill(skill) {
                const currentValue = skillPoints[skill];
                
                // Max skill value is 5
                if (currentValue >= 5) return false;
                
                // Check if we need more skills at (currentValue + 1)
                const targetValue = currentValue + 1;
                const currentDist = getCurrentDistribution();
                
                // If we need more skills at this level, allow it
                if (requiredDistribution[targetValue] && currentDist[targetValue] < requiredDistribution[targetValue]) {
                    return true;
                }
                
                return false;
            }
            
            // Check if skill distribution is complete
            function isDistributionComplete() {
                const currentDist = getCurrentDistribution();
                
                for (let level in requiredDistribution) {
                    if (currentDist[level] < requiredDistribution[level]) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Get skills that can still receive points
            function getAvailableSkills() {
                return Object.keys(skillPoints).filter(skill => canAddPointToSkill(skill));
            }

            // Add steps to steps object
            steps.skillType = document.getElementById('step-skill-type');
            steps.skillsQuest = document.getElementById('step-skills-quest');
            steps.skillsResult = document.getElementById('step-skills-result');

            // Skill type selection
            const skillTypeChoices = document.querySelectorAll('.skill-type-choice');
            skillTypeChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    skillTypeChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    btn.classList.add('selected');
                    selectedSkillType = btn.dataset.skillType;
                    document.getElementById('skill-type').value = selectedSkillType;
                    document.getElementById('next-to-skills-quest').disabled = false;
                });
            });

            // Step 9 -> Step 10 (Tertiary Attrs to Skill Type)
            document.getElementById('next-to-skill-type').addEventListener('click', function() {
                if (selectedTertiaryAttributes.length === 4) {
                    calculateFinalAttributes();
                    showStep(steps.tertiaryAttrs, steps.skillType);
                }
            });

            // Back to Tertiary Attrs
            document.getElementById('back-to-tertiary-attrs').addEventListener('click', function() {
                showStep(steps.skillType, steps.tertiaryAttrs);
            });

            // Step 10 -> Step 11 (Skill Type to Skills Quest)
            document.getElementById('next-to-skills-quest').addEventListener('click', function() {
                if (selectedSkillType) {
                    initializeSkillsQuestionnaire();
                    showStep(steps.skillType, steps.skillsQuest);
                }
            });

            // Initialize skills questionnaire
            function initializeSkillsQuestionnaire() {
                initializeSkills();
                
                // Set required distribution based on skill type
                requiredDistribution = skillDistributions[selectedSkillType].distribution;
                totalSkillPointsRemaining = skillDistributions[selectedSkillType].totalPoints;
                
                currentScenarioIndex = 0;
                currentScenarioPhase = 'initial';
                currentInitialChoice = null;
                backstoryFragments = [];
                
                renderSkillQuestion();
            }

            // Render current skill question
            function renderSkillQuestion() {
                const container = document.getElementById('skill-question-container');
                const progress = document.getElementById('skill-progress');
                const pointsDisplay = document.getElementById('skill-points-remaining');
                
                // Check if distribution is complete
                if (isDistributionComplete()) {
                    displaySkillsResult();
                    showStep(steps.skillsQuest, steps.skillsResult);
                    return;
                }
                
                // Cycle through scenarios, wrapping around if needed
                const scenario = skillScenarios[currentScenarioIndex % skillScenarios.length];
                
                progress.textContent = `Scenario ${Math.floor(currentScenarioIndex / skillScenarios.length) * skillScenarios.length + (currentScenarioIndex % skillScenarios.length) + 1}`;
                
                // Update points display with distribution info
                const currentDist = getCurrentDistribution();
                let distText = '';
                for (let level = 5; level >= 1; level--) {
                    if (requiredDistribution[level]) {
                        distText += `${level} pts: ${currentDist[level]}/${requiredDistribution[level]}  `;
                    }
                }
                pointsDisplay.textContent = distText.trim();
                
                container.innerHTML = '';
                
                const availableSkills = getAvailableSkills();
                
                if (currentScenarioPhase === 'initial') {
                    // Show initial question
                    document.getElementById('skills-quest-prompt').textContent = "The elder leans forward, eyes gleaming with curiosity. \"Now let me see what life has taught you...\"";
                    document.getElementById('skills-quest-question').textContent = `"${scenario.prompt}"`;
                    
                    // Filter initial choices to only show those with available skills
                    const validChoices = scenario.initialChoices.filter(choice => {
                        return choice.skills.some(skill => availableSkills.includes(skill));
                    });
                    
                    if (validChoices.length === 0) {
                        // No valid choices, skip to next scenario
                        currentScenarioIndex++;
                        currentScenarioPhase = 'initial';
                        renderSkillQuestion();
                        return;
                    }
                    
                    validChoices.forEach((choice, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'choice-btn skill-answer-btn';
                        
                        // Filter skills to only show available ones
                        const availableChoiceSkills = choice.skills.filter(s => availableSkills.includes(s));
                        
                        btn.innerHTML = `
                            <span class="choice-text">${choice.text}</span>
                            <span class="skill-hints">(Related: ${availableChoiceSkills.map(s => allSkills[s].name).join(', ')})</span>
                        `;
                        btn.addEventListener('click', function() {
                            container.querySelectorAll('.skill-answer-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            currentInitialChoice = choice;
                            document.getElementById('next-skill-question').disabled = false;
                        });
                        container.appendChild(btn);
                    });
                } else {
                    // Show follow-up question
                    document.getElementById('skills-quest-prompt').textContent = "The elder nods slowly, considering your words...";
                    document.getElementById('skills-quest-question').textContent = `"${currentInitialChoice.followUp.prompt}"`;
                    
                    // Filter follow-up choices to only show available skills
                    const validFollowUps = currentInitialChoice.followUp.choices.filter(choice => {
                        return availableSkills.includes(choice.skill);
                    });
                    
                    if (validFollowUps.length === 0) {
                        // No valid follow-ups, move to next scenario
                        currentScenarioIndex++;
                        currentScenarioPhase = 'initial';
                        currentInitialChoice = null;
                        renderSkillQuestion();
                        return;
                    }
                    
                    validFollowUps.forEach((choice, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'choice-btn skill-answer-btn';
                        btn.innerHTML = `
                            <span class="choice-text">${choice.text}</span>
                            <span class="skill-hints">(${allSkills[choice.skill].name})</span>
                        `;
                        btn.addEventListener('click', function() {
                            container.querySelectorAll('.skill-answer-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            btn.dataset.selectedSkill = choice.skill;
                            btn.dataset.backstory = choice.backstory;
                            document.getElementById('next-skill-question').disabled = false;
                        });
                        container.appendChild(btn);
                    });
                }
                
                // Update button text
                const nextBtn = document.getElementById('next-skill-question');
                if (currentScenarioPhase === 'initial') {
                    nextBtn.textContent = 'Continue';
                } else {
                    nextBtn.textContent = 'Next Scenario';
                }
                nextBtn.disabled = true;
            }

            // Handle skill question navigation
            document.getElementById('next-skill-question').addEventListener('click', function() {
                const container = document.getElementById('skill-question-container');
                
                if (currentScenarioPhase === 'initial') {
                    // Move to follow-up phase
                    currentScenarioPhase = 'followUp';
                    renderSkillQuestion();
                } else {
                    // Process the answer and move to next scenario
                    const selectedBtn = container.querySelector('.skill-answer-btn.selected');
                    if (selectedBtn) {
                        const skill = selectedBtn.dataset.selectedSkill;
                        const backstory = selectedBtn.dataset.backstory;
                        
                        // Add point to skill if allowed
                        if (canAddPointToSkill(skill)) {
                            skillPoints[skill]++;
                            totalSkillPointsRemaining--;
                        }
                        
                        // Add to backstory
                        const scenario = skillScenarios[currentScenarioIndex % skillScenarios.length];
                        backstoryFragments.push(`${scenario.backstoryIntro} ${currentInitialChoice.backstory}, ${backstory}`);
                    }
                    
                    // Check if distribution is complete
                    if (isDistributionComplete()) {
                        displaySkillsResult();
                        showStep(steps.skillsQuest, steps.skillsResult);
                    } else {
                        // Move to next scenario
                        currentScenarioIndex++;
                        currentScenarioPhase = 'initial';
                        currentInitialChoice = null;
                        renderSkillQuestion();
                    }
                }
            });

            // Back to skill type
            document.getElementById('back-to-skill-type').addEventListener('click', function() {
                showStep(steps.skillsQuest, steps.skillType);
            });

            // Display skills result
            function displaySkillsResult() {
                const container = document.getElementById('skills-result-container');
                const backstoryContainer = document.getElementById('backstory-text');
                
                // Sort skills by points (highest first)
                const sortedSkills = Object.entries(skillPoints)
                    .sort((a, b) => b[1] - a[1])
                    .filter(([skill, points]) => points > 0);
                
                // Create skills display grouped by category
                const skillsByCategory = {
                    physical: [],
                    social: [],
                    mental: []
                };
                
                sortedSkills.forEach(([skill, points]) => {
                    skillsByCategory[allSkills[skill].category].push({ skill, points, name: allSkills[skill].name });
                });
                
                container.innerHTML = `
                    <div class="skills-grid">
                        <div class="skill-category">
                            <h5>Physical</h5>
                            ${skillsByCategory.physical.map(s => `
                                <div class="skill-item ${s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                    ${s.name}: ${getDotsDisplay(s.points)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="skill-category">
                            <h5>Social</h5>
                            ${skillsByCategory.social.map(s => `
                                <div class="skill-item ${s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                    ${s.name}: ${getDotsDisplay(s.points)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="skill-category">
                            <h5>Mental</h5>
                            ${skillsByCategory.mental.map(s => `
                                <div class="skill-item ${s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                    ${s.name}: ${getDotsDisplay(s.points)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Generate backstory
                generatedBackstory = backstoryFragments.join('\n\n');
                backstoryContainer.textContent = generatedBackstory;
            }

            // Back to skills questionnaire (retake)
            document.getElementById('back-to-skills-quest').addEventListener('click', function() {
                initializeSkillsQuestionnaire();
                showStep(steps.skillsResult, steps.skillsQuest);
            });

            // Step 12 -> Step 13 (Skills Result to Summary)
            document.getElementById('next-to-summary').addEventListener('click', function() {
                // Get the final backstory (may have been edited)
                generatedBackstory = document.getElementById('backstory-text').textContent;
                populateSummary();
                showStep(steps.skillsResult, steps.summary);
            });

            // Calculate final attribute values
            // GUARANTEE: This function ensures the required distribution is ALWAYS met:
            // - 1 attribute at 4/5 points (primary)
            // - 3 attributes at 3/5 points (secondary)
            // - 4 attributes at 2/5 points (tertiary)
            // - 1 attribute at 1/5 points (weakest)
            // Total: 1 + 3 + 4 + 1 = 9 attributes (verified by test suite)
            function calculateFinalAttributes() {
                // Reset all to base 1
                Object.keys(characterData.attributes).forEach(function(attr) {
                    characterData.attributes[attr] = 1;
                });
                
                // Primary attribute: 4 points
                characterData.attributes[selectedPrimaryAttribute] = 4;
                
                // Secondary attributes (3 selected): 3 points each
                selectedSecondaryAttributes.forEach(function(attr) {
                    characterData.attributes[attr] = 3;
                });
                
                // Tertiary attributes (4 selected): 2 points each
                selectedTertiaryAttributes.forEach(function(attr) {
                    characterData.attributes[attr] = 2;
                });
                
                // Weakest attribute remains at 1 (already initialized, no action needed)
                // The remaining unassigned attribute automatically stays at base value of 1
                
                // Validate that the distribution is correct
                validateAttributeDistribution();
            }
            
            // Validate attribute distribution matches requirements
            // This provides runtime verification that the guarantee holds
            function validateAttributeDistribution() {
                const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                
                Object.values(characterData.attributes).forEach(function(value) {
                    distribution[value]++;
                });
                
                const isValid = 
                    distribution[4] === 1 &&  // Exactly 1 at 4 points
                    distribution[3] === 3 &&  // Exactly 3 at 3 points
                    distribution[2] === 4 &&  // Exactly 4 at 2 points
                    distribution[1] === 1 &&  // Exactly 1 at 1 point
                    distribution[5] === 0;    // None at 5 points
                
                if (!isValid) {
                    console.error('VALIDATION ERROR: Attribute distribution does not match requirements!');
                    console.error('Expected: 1√ó4pts, 3√ó3pts, 4√ó2pts, 1√ó1pt');
                    console.error('Got:', distribution);
                    console.error('Attributes:', characterData.attributes);
                    console.error('This is a bug in the character creation system. Please report this issue.');
                    // Alert user of the issue with actionable guidance
                    alert('Error: Character attributes are invalid.\n\n' +
                          'Expected: 1 attr at 4 pts, 3 attrs at 3 pts, 4 attrs at 2 pts, 1 attr at 1 pt\n' +
                          'This is a system error. Please:\n' +
                          '1. Take a screenshot\n' +
                          '2. Note your selections\n' +
                          '3. Report this bug\n' +
                          '4. Refresh and try again');
                    return false;
                }
                
                console.log('‚úì Attribute distribution validated successfully');
                console.log('Distribution: 1√ó4pts, 3√ó3pts, 4√ó2pts, 1√ó1pt');
                return true;
            }

            // Populate summary
            function populateSummary() {
                const container = document.getElementById('character-summary');
                const name = characterNameInput.value;
                
                // Get skills by category for display
                const skillsByCategory = {
                    physical: [],
                    social: [],
                    mental: []
                };
                
                Object.entries(skillPoints).forEach(([skill, points]) => {
                    if (points > 0) {
                        skillsByCategory[allSkills[skill].category].push({ 
                            skill, 
                            points, 
                            name: allSkills[skill].name 
                        });
                    }
                });
                
                // Sort each category by points
                Object.keys(skillsByCategory).forEach(cat => {
                    skillsByCategory[cat].sort((a, b) => b.points - a.points);
                });
                
                container.innerHTML = `
                    <div class="summary-section">
                        <h3>${name}</h3>
                        <p class="summary-subtitle">${getGenderLabel(genderInput.value)} ${getTribeLabel(document.getElementById('tribe').value)} ${getAuspiceLabel(auspiceInput.value)}</p>
                    </div>
                    <div class="summary-section">
                        <h4>Attributes</h4>
                        <div class="attribute-grid">
                            <div class="attr-category">
                                <h5>Physical</h5>
                                <div class="attr-item ${characterData.attributes.strength === 4 ? 'primary' : characterData.attributes.strength === 3 ? 'secondary' : characterData.attributes.strength === 2 ? 'tertiary' : 'weak'}">
                                    Strength: ${getDotsDisplay(characterData.attributes.strength)}
                                </div>
                                <div class="attr-item ${characterData.attributes.dexterity === 4 ? 'primary' : characterData.attributes.dexterity === 3 ? 'secondary' : characterData.attributes.dexterity === 2 ? 'tertiary' : 'weak'}">
                                    Dexterity: ${getDotsDisplay(characterData.attributes.dexterity)}
                                </div>
                                <div class="attr-item ${characterData.attributes.stamina === 4 ? 'primary' : characterData.attributes.stamina === 3 ? 'secondary' : characterData.attributes.stamina === 2 ? 'tertiary' : 'weak'}">
                                    Stamina: ${getDotsDisplay(characterData.attributes.stamina)}
                                </div>
                            </div>
                            <div class="attr-category">
                                <h5>Social</h5>
                                <div class="attr-item ${characterData.attributes.charisma === 4 ? 'primary' : characterData.attributes.charisma === 3 ? 'secondary' : characterData.attributes.charisma === 2 ? 'tertiary' : 'weak'}">
                                    Charisma: ${getDotsDisplay(characterData.attributes.charisma)}
                                </div>
                                <div class="attr-item ${characterData.attributes.manipulation === 4 ? 'primary' : characterData.attributes.manipulation === 3 ? 'secondary' : characterData.attributes.manipulation === 2 ? 'tertiary' : 'weak'}">
                                    Manipulation: ${getDotsDisplay(characterData.attributes.manipulation)}
                                </div>
                                <div class="attr-item ${characterData.attributes.composure === 4 ? 'primary' : characterData.attributes.composure === 3 ? 'secondary' : characterData.attributes.composure === 2 ? 'tertiary' : 'weak'}">
                                    Composure: ${getDotsDisplay(characterData.attributes.composure)}
                                </div>
                            </div>
                            <div class="attr-category">
                                <h5>Mental</h5>
                                <div class="attr-item ${characterData.attributes.intelligence === 4 ? 'primary' : characterData.attributes.intelligence === 3 ? 'secondary' : characterData.attributes.intelligence === 2 ? 'tertiary' : 'weak'}">
                                    Intelligence: ${getDotsDisplay(characterData.attributes.intelligence)}
                                </div>
                                <div class="attr-item ${characterData.attributes.wits === 4 ? 'primary' : characterData.attributes.wits === 3 ? 'secondary' : characterData.attributes.wits === 2 ? 'tertiary' : 'weak'}">
                                    Wits: ${getDotsDisplay(characterData.attributes.wits)}
                                </div>
                                <div class="attr-item ${characterData.attributes.resolve === 4 ? 'primary' : characterData.attributes.resolve === 3 ? 'secondary' : characterData.attributes.resolve === 2 ? 'tertiary' : 'weak'}">
                                    Resolve: ${getDotsDisplay(characterData.attributes.resolve)}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-section">
                        <h4>Skills</h4>
                        <div class="skills-grid">
                            <div class="skill-category">
                                <h5>Physical</h5>
                                ${skillsByCategory.physical.map(s => `
                                    <div class="skill-item ${s.points >= 4 ? 'expert' : s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                        ${s.name}: ${getDotsDisplay(s.points)}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="skill-category">
                                <h5>Social</h5>
                                ${skillsByCategory.social.map(s => `
                                    <div class="skill-item ${s.points >= 4 ? 'expert' : s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                        ${s.name}: ${getDotsDisplay(s.points)}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="skill-category">
                                <h5>Mental</h5>
                                ${skillsByCategory.mental.map(s => `
                                    <div class="skill-item ${s.points >= 4 ? 'expert' : s.points >= 3 ? 'high' : s.points >= 2 ? 'medium' : 'low'}">
                                        ${s.name}: ${getDotsDisplay(s.points)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="summary-section">
                        <h4>Your Story</h4>
                        <div class="backstory-display">
                            ${generatedBackstory.split('\n\n').map(p => `<p>${p}</p>`).join('')}
                        </div>
                    </div>
                `;
            }

            function getDotsDisplay(value) {
                return '‚óè'.repeat(value) + '‚óã'.repeat(5 - value);
            }

            function getGenderLabel(gender) {
                const labels = {
                    'male': 'Male',
                    'female': 'Female',
                    'non-binary': 'Non-Binary',
                    'genderfluid': 'Genderfluid',
                    'agender': 'Agender'
                };
                return labels[gender] || gender;
            }

            function getTribeLabel(tribe) {
                const labels = {
                    'black-furies': 'Black Fury',
                    'bone-gnawers': 'Bone Gnawer',
                    'children-of-gaia': 'Child of Gaia',
                    'fianna': 'Fianna',
                    'ghost-council': 'Ghost Council',
                    'glass-walkers': 'Glass Walker',
                    'red-talons': 'Red Talon',
                    'shadow-lords': 'Shadow Lord',
                    'silent-striders': 'Silent Strider',
                    'silver-fangs': 'Silver Fang',
                    'stargazers': 'Stargazer'
                };
                return labels[tribe] || tribe;
            }

            function getAuspiceLabel(auspice) {
                const labels = {
                    'ragabash': 'Ragabash',
                    'theurge': 'Theurge',
                    'philodox': 'Philodox',
                    'galliard': 'Galliard',
                    'ahroun': 'Ahroun'
                };
                return labels[auspice] || auspice;
            }

            // Back to Skills Result
            document.getElementById('back-to-tertiary').addEventListener('click', function() {
                showStep(steps.summary, steps.skillsResult);
            });

            // Update character data on form submission
            document.getElementById('character-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                characterData.name = characterNameInput.value;
                characterData.gender = genderInput.value;
                characterData.tribe = document.getElementById('tribe').value;
                characterData.auspice = auspiceInput.value;
                characterData.birthdate = birthdateInput.value;
                characterData.skillType = selectedSkillType;
                characterData.skills = skillPoints;
                characterData.backstory = generatedBackstory;
                characterData.system = 'werewolf-apocalypse';
                characterData.createdAt = new Date().toISOString();
                
                // Check if user is logged in
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    characterData.userEmail = user.email;
                    characterData.id = 'char_' + Date.now();
                    
                    // Get existing characters and add new one
                    const characters = JSON.parse(localStorage.getItem('characters') || '[]');
                    characters.push(characterData);
                    localStorage.setItem('characters', JSON.stringify(characters));
                    
                    // Also store as current werewolf character
                    localStorage.setItem('werewolfCharacter', JSON.stringify(characterData));
                    
                    console.log('Character created:', characterData);
                    alert('Character created successfully! Your journey begins... View your character in the Characters section.');
                    window.location.href = 'characters.html';
                } else {
                    // Not logged in - store temporarily and prompt to log in
                    localStorage.setItem('werewolfCharacter', JSON.stringify(characterData));
                    localStorage.setItem('pendingCharacter', JSON.stringify(characterData));
                    
                    console.log('Character created:', characterData);
                    if (confirm('Character created! Sign in or create an account to save your character permanently. Go to Account page?')) {
                        window.location.href = 'account.html';
                    }
                }
            });
        });
    </script>
</body>
</html>
