<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Character - Werewolf 5e</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
</head>
<body>
    <!-- Embers Background Video -->
    <video class="embers-background" autoplay muted loop playsinline>
        <source src="Embers Background.mov" type="video/mp4">
    </video>

    <!-- Background Audio -->
    <audio id="background-audio" loop>
        <source src="High-Tech-Lab---Loop_AdobeStock_676139658.wav" type="audio/wav">
    </audio>

    <!-- Sound Toggle Button -->
    <button type="button" id="sound-toggle" class="sound-toggle" aria-label="Toggle sound">
        <svg id="sound-on-icon" class="sound-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg id="sound-off-icon" class="sound-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>

    <header class="sticky-header">
        <nav>
            <a href="account.html">Account</a>
            <a href="characters.html">Characters</a>
            <a href="sessions.html">Sessions</a>
            <a href="about.html">About Us</a>
        </nav>
        <img src="https://github.com/user-attachments/assets/aaa6e10d-a24c-4711-8da7-2683d2028d7b" alt="RNBW Logo" class="header-logo">
    </header>
    
    <main class="create-character-main">
        <h1>Create Your Character</h1>
        <p>Build your werewolf character for the apocalypse.</p>
        
        <section class="character-form-container">
            <form class="character-form" id="character-form">
                <!-- Step 1: Character Name -->
                <div class="adventure-step" id="step-name" data-step="1">
                    <p class="adventure-prompt">The mist parts before you, revealing a moonlit clearing. A figure emerges from the shadows, ancient eyes studying you carefully.</p>
                    <p class="adventure-question">"Traveler... what name do you carry?"</p>
                    <div class="form-group">
                        <label for="character-name">Your Name</label>
                        <input type="text" id="character-name" name="character-name" placeholder="Enter your name" required>
                    </div>
                    <div class="form-actions">
                        <a href="index.html" class="btn btn-secondary">Back</a>
                        <button type="button" class="btn btn-primary" id="next-to-gender">Continue</button>
                    </div>
                </div>

                <!-- Step 2: Gender -->
                <div class="adventure-step hidden" id="step-gender" data-step="2">
                    <p class="adventure-prompt">The ancient one nods slowly, a knowing smile crossing their weathered face.</p>
                    <p class="adventure-question">"<span id="spoken-name">Traveler</span>... and how do you walk through this world?"</p>
                    <div class="form-group">
                        <label for="gender">Your Identity</label>
                        <div class="gender-choices">
                            <button type="button" class="choice-btn" data-gender="male">Male</button>
                            <button type="button" class="choice-btn" data-gender="female">Female</button>
                            <button type="button" class="choice-btn" data-gender="non-binary">Non-Binary</button>
                            <button type="button" class="choice-btn" data-gender="genderfluid">Genderfluid</button>
                            <button type="button" class="choice-btn" data-gender="agender">Agender</button>
                        </div>
                        <input type="hidden" id="gender" name="gender">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-name">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-tribe" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 3: Tribe -->
                <div class="adventure-step hidden" id="step-tribe" data-step="3">
                    <p class="adventure-prompt">The figure's eyes gleam with an otherworldly light as the wind carries whispers of ancient packs.</p>
                    <p class="adventure-question">"The blood of many tribes flows through Gaia's children. Which lineage calls to your spirit?"</p>
                    <div class="form-group">
                        <label for="tribe">Your Tribe</label>
                        <select id="tribe" name="tribe" required>
                            <option value="">Select a tribe</option>
                            <option value="black-furies">Black Furies</option>
                            <option value="bone-gnawers">Bone Gnawers</option>
                            <option value="children-of-gaia">Children of Gaia</option>
                            <option value="fianna">Fianna</option>
                            <option value="get-of-fenris">Get of Fenris</option>
                            <option value="glass-walkers">Glass Walkers</option>
                            <option value="red-talons">Red Talons</option>
                            <option value="shadow-lords">Shadow Lords</option>
                            <option value="silent-striders">Silent Striders</option>
                            <option value="silver-fangs">Silver Fangs</option>
                            <option value="stargazers">Stargazers</option>
                            <option value="uktena">Uktena</option>
                            <option value="wendigo">Wendigo</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-gender">Back</button>
                        <button type="button" class="btn btn-primary" id="next-to-auspice">Continue</button>
                    </div>
                </div>

                <!-- Step 4: Auspice -->
                <div class="adventure-step hidden" id="step-auspice" data-step="4">
                    <p class="adventure-prompt">Above, Luna reveals herself through the parting clouds, her silver light bathing the clearing.</p>
                    <p class="adventure-question">"Under which phase of Luna were you born? What role does she bestow upon you?"</p>
                    
                    <!-- Birth Date Selection (Auto-calculate Auspice) -->
                    <div class="form-group" id="birthdate-group">
                        <label for="birthdate">Your Birth Date</label>
                        <div class="birthdate-input-wrapper">
                            <input type="date" id="birthdate" name="birthdate" placeholder="Enter your birth date">
                            <button type="button" class="btn-manual-select" id="toggle-manual-auspice" title="Choose manually instead">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="auspice-result" id="auspice-result"></p>
                    </div>
                    
                    <!-- Manual Auspice Selection (Hidden by default) -->
                    <div class="form-group hidden" id="manual-auspice-group">
                        <label for="auspice-select">Choose Your Auspice</label>
                        <div class="auspice-choices">
                            <button type="button" class="choice-btn auspice-choice" data-auspice="ragabash">
                                <span class="moon-icon">üåë</span>
                                <span class="auspice-name">Ragabash</span>
                                <span class="moon-phase">New Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="theurge">
                                <span class="moon-icon">üåí</span>
                                <span class="auspice-name">Theurge</span>
                                <span class="moon-phase">Crescent Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="philodox">
                                <span class="moon-icon">üåì</span>
                                <span class="auspice-name">Philodox</span>
                                <span class="moon-phase">Half Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="galliard">
                                <span class="moon-icon">üåî</span>
                                <span class="auspice-name">Galliard</span>
                                <span class="moon-phase">Gibbous Moon</span>
                            </button>
                            <button type="button" class="choice-btn auspice-choice" data-auspice="ahroun">
                                <span class="moon-icon">üåï</span>
                                <span class="auspice-name">Ahroun</span>
                                <span class="moon-phase">Full Moon</span>
                            </button>
                        </div>
                        <button type="button" class="btn-back-to-birthdate" id="back-to-birthdate">
                            ‚Üê Use birth date instead
                        </button>
                    </div>
                    
                    <input type="hidden" id="auspice" name="auspice">
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-tribe">Back</button>
                        <button type="submit" class="btn btn-primary" id="submit-character" disabled>Begin Your Journey</button>
                    </div>
                </div>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('background-audio');
            const soundToggle = document.getElementById('sound-toggle');
            const soundOnIcon = document.getElementById('sound-on-icon');
            const soundOffIcon = document.getElementById('sound-off-icon');
            
            let isMuted = true; // Start muted by default
            
            // Update icon display
            function updateSoundIcon() {
                if (isMuted) {
                    soundOnIcon.classList.add('hidden');
                    soundOffIcon.classList.remove('hidden');
                } else {
                    soundOnIcon.classList.remove('hidden');
                    soundOffIcon.classList.add('hidden');
                }
            }
            
            // Toggle sound on/off
            soundToggle.addEventListener('click', function() {
                isMuted = !isMuted;
                audio.muted = isMuted;
                
                if (!isMuted) {
                    audio.play().catch(function(error) {
                        console.log('Audio play failed:', error);
                    });
                }
                
                updateSoundIcon();
            });
            
            // Initialize audio state
            audio.muted = isMuted;
            updateSoundIcon();

            // Adventure Step Navigation
            const steps = {
                name: document.getElementById('step-name'),
                gender: document.getElementById('step-gender'),
                tribe: document.getElementById('step-tribe'),
                auspice: document.getElementById('step-auspice')
            };

            const characterNameInput = document.getElementById('character-name');
            const genderInput = document.getElementById('gender');
            const spokenName = document.getElementById('spoken-name');
            const genderChoices = document.querySelectorAll('.choice-btn[data-gender]');
            const nextToGenderBtn = document.getElementById('next-to-gender');
            const nextToAuspiceBtn = document.getElementById('next-to-auspice');

            // Show step function with fade transition
            function showStep(currentStep, stepToShow) {
                if (currentStep) {
                    currentStep.classList.add('fade-out');
                    setTimeout(function() {
                        Object.values(steps).forEach(function(step) {
                            step.classList.add('hidden');
                            step.classList.remove('fade-out');
                        });
                        stepToShow.classList.remove('hidden');
                    }, 500);
                } else {
                    Object.values(steps).forEach(function(step) {
                        step.classList.add('hidden');
                    });
                    stepToShow.classList.remove('hidden');
                }
            }

            // Step 1 -> Step 2 (Name to Gender)
            nextToGenderBtn.addEventListener('click', function() {
                const name = characterNameInput.value.trim();
                if (name) {
                    spokenName.textContent = name;
                    showStep(steps.name, steps.gender);
                } else {
                    characterNameInput.focus();
                }
            });

            // Allow Enter key to proceed from name input
            characterNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    nextToGenderBtn.click();
                }
            });

            // Step 2: Gender selection
            genderChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    genderChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    btn.classList.add('selected');
                    // Update hidden input
                    genderInput.value = btn.dataset.gender;
                    // Enable continue button
                    document.getElementById('next-to-tribe').disabled = false;
                });
            });

            // Step 2 -> Step 3 (Gender to Tribe)
            document.getElementById('next-to-tribe').addEventListener('click', function() {
                if (genderInput.value) {
                    showStep(steps.gender, steps.tribe);
                }
            });

            // Step 3 -> Step 4 (Tribe to Auspice)
            nextToAuspiceBtn.addEventListener('click', function() {
                const tribe = document.getElementById('tribe').value;
                if (tribe) {
                    showStep(steps.tribe, steps.auspice);
                } else {
                    document.getElementById('tribe').focus();
                }
            });

            // Back buttons
            document.getElementById('back-to-name').addEventListener('click', function() {
                showStep(steps.gender, steps.name);
            });

            document.getElementById('back-to-gender').addEventListener('click', function() {
                showStep(steps.tribe, steps.gender);
            });

            document.getElementById('back-to-tribe').addEventListener('click', function() {
                showStep(steps.auspice, steps.tribe);
            });

            // Auspice Selection Logic
            const birthdateInput = document.getElementById('birthdate');
            const auspiceInput = document.getElementById('auspice');
            const auspiceResult = document.getElementById('auspice-result');
            const birthdateGroup = document.getElementById('birthdate-group');
            const manualAuspiceGroup = document.getElementById('manual-auspice-group');
            const toggleManualBtn = document.getElementById('toggle-manual-auspice');
            const backToBirthdateBtn = document.getElementById('back-to-birthdate');
            const auspiceChoices = document.querySelectorAll('.auspice-choice');
            const submitBtn = document.getElementById('submit-character');

            // Moon phase calculation based on date
            function getMoonPhase(date) {
                // Calculate days since known new moon (Jan 6, 2000)
                const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0);
                const lunarCycle = 29.53058867; // days
                const daysSinceNewMoon = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
                const currentCycle = daysSinceNewMoon / lunarCycle;
                const phase = (currentCycle - Math.floor(currentCycle)) * lunarCycle;
                return phase;
            }

            // Determine auspice from moon phase
            function getAuspiceFromPhase(phase) {
                // Moon phases and corresponding auspices
                // 0-1.85 days: New Moon (Ragabash)
                // 1.85-7.38 days: Waxing Crescent (Theurge)
                // 7.38-11.07 days: First Quarter (Philodox)
                // 11.07-14.77 days: Waxing Gibbous (Galliard)
                // 14.77-18.46 days: Full Moon (Ahroun)
                // 18.46-22.15 days: Waning Gibbous (Galliard)
                // 22.15-25.84 days: Last Quarter (Philodox)
                // 25.84-27.69 days: Waning Crescent (Theurge)
                // 27.69-29.53 days: New Moon (Ragabash)
                
                if (phase < 1.85 || phase >= 27.69) {
                    return { auspice: 'ragabash', name: 'Ragabash', moon: 'New Moon', icon: 'üåë' };
                } else if (phase < 7.38 || phase >= 25.84) {
                    return { auspice: 'theurge', name: 'Theurge', moon: 'Crescent Moon', icon: 'üåí' };
                } else if (phase < 11.07 || phase >= 22.15) {
                    return { auspice: 'philodox', name: 'Philodox', moon: 'Half Moon', icon: 'üåì' };
                } else if (phase < 14.77 || phase >= 18.46) {
                    return { auspice: 'galliard', name: 'Galliard', moon: 'Gibbous Moon', icon: 'üåî' };
                } else {
                    return { auspice: 'ahroun', name: 'Ahroun', moon: 'Full Moon', icon: 'üåï' };
                }
            }

            // Handle birth date input
            birthdateInput.addEventListener('change', function() {
                if (this.value) {
                    const birthDate = new Date(this.value);
                    const phase = getMoonPhase(birthDate);
                    const auspiceData = getAuspiceFromPhase(phase);
                    
                    auspiceInput.value = auspiceData.auspice;
                    auspiceResult.innerHTML = `${auspiceData.icon} Luna reveals your path: <strong>${auspiceData.name}</strong> (${auspiceData.moon})`;
                    auspiceResult.classList.add('show');
                    submitBtn.disabled = false;
                } else {
                    auspiceInput.value = '';
                    auspiceResult.innerHTML = '';
                    auspiceResult.classList.remove('show');
                    submitBtn.disabled = true;
                }
            });

            // Toggle to manual selection
            toggleManualBtn.addEventListener('click', function() {
                birthdateGroup.classList.add('hidden');
                manualAuspiceGroup.classList.remove('hidden');
                // Clear any auto-selected auspice
                if (!auspiceInput.value || birthdateInput.value) {
                    auspiceInput.value = '';
                    submitBtn.disabled = true;
                }
            });

            // Back to birthdate selection
            backToBirthdateBtn.addEventListener('click', function() {
                manualAuspiceGroup.classList.add('hidden');
                birthdateGroup.classList.remove('hidden');
                // Clear manual selections
                auspiceChoices.forEach(function(btn) {
                    btn.classList.remove('selected');
                });
                // Re-check if birthdate has a value
                if (birthdateInput.value) {
                    const birthDate = new Date(birthdateInput.value);
                    const phase = getMoonPhase(birthDate);
                    const auspiceData = getAuspiceFromPhase(phase);
                    auspiceInput.value = auspiceData.auspice;
                    submitBtn.disabled = false;
                } else {
                    auspiceInput.value = '';
                    submitBtn.disabled = true;
                }
            });

            // Manual auspice selection
            auspiceChoices.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    auspiceChoices.forEach(function(b) {
                        b.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    btn.classList.add('selected');
                    // Update hidden input
                    auspiceInput.value = btn.dataset.auspice;
                    // Enable submit button
                    submitBtn.disabled = false;
                });
            });

            // Character data storage
            const characterData = {
                name: '',
                gender: '',
                tribe: '',
                auspice: '',
                birthdate: ''
            };

            // Update character data on form submission
            document.getElementById('character-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                characterData.name = characterNameInput.value;
                characterData.gender = genderInput.value;
                characterData.tribe = document.getElementById('tribe').value;
                characterData.auspice = auspiceInput.value;
                characterData.birthdate = birthdateInput.value;
                
                // Store in localStorage for later use
                localStorage.setItem('werewolfCharacter', JSON.stringify(characterData));
                
                console.log('Character created:', characterData);
                alert('Character created successfully! Your journey begins...');
            });
        });
    </script>
</body>
</html>
